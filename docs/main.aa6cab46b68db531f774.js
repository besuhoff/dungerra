(()=>{"use strict";var e="/dungerra/";const t={floorTexture:e+"assets/ba86869b6bcdfdb23fcd.png",wallTexture:e+"assets/1ff0e9fd7756fa67a6e3.jpg",playerTexture:e+"assets/36842061eecde0146548.png",playerShotgunTexture:e+"assets/82149cdcc18d151a09cc.png",playerRailgunTexture:e+"assets/dba6046f9eea37c5faa3.png",playerRocketLauncherTexture:e+"assets/1be230d8a1c34654da1d.png",enemyTexture:e+"assets/c2abb91c965fee2c144b.png",bloodTexture:e+"assets/aad741dfe71af677f795.png",aidKitTexture:e+"assets/79e186c8dd3fba9deccb.png",gogglesTexture:e+"assets/731b2b0db1a708ca3175.png",heartTexture:e+"assets/502866806875110ceeae.png",shopTexturne:e+"assets/20d0728d9980c79a46d8.png",inventoryTexture:e+"assets/01c4effa1c7f6f4277bb.png",itemRailgunTexture:e+"assets/20d94331a249251f72fd.png",itemRocketLauncherTexture:e+"assets/2028a209c1d45ed223b8.png",itemShotgunTexture:e+"assets/0864d380ef9d32f4dd3d.png",itemBlasterTexture:e+"assets/3ede2d2991151e8bf272.png",itemAmmoShotgunTexture:e+"assets/ff336fc71319c4a55ec6.png",itemAmmoRocketLauncherTexture:e+"assets/a376fa91ea6835a98345.png",itemAmmoRailgunTexture:e+"assets/ca67a899bd13b1db165d.png",bulletRocketTexture:e+"assets/4f4294a77c4b4f4b1dce.png",shopLayoutTexture:e+"assets/06f02911d0ba2229b770.png",chestTexture:e+"assets/2af5eb44d29a59f3b662.png",explosionAnimation:{image:e+"assets/116019dff1c51461403b.png",frameCount:17,duration:800},bulletSound:e+"assets/5d47cbddfd7640ba29a0.ogg",torchSound:e+"assets/ac5ce9bd2dc980bf1754.ogg",gameOverSound:e+"assets/81f4739e205d4712bde7.ogg",playerHurtSound:e+"assets/0aaf114e55619a91fd22.ogg",playerDeadSound:e+"assets/f7f66f7a50db67b654e0.ogg",enemyHurtSound:e+"assets/a5236b0656b6d63f174a.ogg",playerBulletRechargeSound:e+"assets/671b1542dbb4caf26fa4.ogg",bonusPickupSound:e+"assets/a0eba45f5e6c41de422f.ogg",spawnSound:e+"assets/912af0db42bb5d4e3612.ogg",rocketLauncherSound:e+"assets/50dad2a267c55ca22618.ogg",rocketBlastSound:e+"assets/b7af1b74e0e69193962f.ogg",railgunSound:e+"assets/6c87a33a2b9e9e7791fc.ogg",shotgunSound:e+"assets/65b2382668c942f8e10e.ogg",enterShopSound:e+"assets/c61abe865ca7c71e3bc5.ogg",moneySpentSound:e+"assets/3ab75845dc3c04dc66ed.ogg",mistakeSound:e+"assets/48dd75ca19d8333cad68.ogg"};class i{_x;_y;constructor(e,t){this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}toString(){return`(${this._x.toFixed(2)}, ${this._y.toFixed(2)})`}equals(e){return this._x===e.x&&this._y===e.y}clone(){return new i(this._x,this._y)}setTo(e,t){return this._x=e,this._y=t,this}setToPointCoordinates(e){return this.setTo(e.x,e.y)}moveBy(e,t){return this._x+=e,this._y+=t,this}movedBy(e,t){return this.clone().moveBy(e,t)}moveByPointCoordinates(e){return this.moveBy(e.x,e.y)}movedByPointCoordinates(e){return this.clone().moveByPointCoordinates(e)}invertAgainstPointCoordinates(e){return this.moveBy(2*(e.x-this._x),2*(e.y-this._y))}invertedAgainstPointCoordinates(e){return this.clone().invertAgainstPointCoordinates(e)}invert(){return this.invertAgainstPointCoordinates(new i(0,0))}inverted(){return this.clone().invert()}rotateAroundPointCoordinates(e,t){const i=Math.cos(t*Math.PI/180),n=Math.sin(t*Math.PI/180),s=this._x-e._x,a=this._y-e.y;return this._x=s*i-a*n+e._x,this._y=s*n+a*i+e.y,this}rotatedAroundPointCoordinates(e,t){return this.clone().rotateAroundPointCoordinates(e,t)}rotate(e){return this.rotateAroundPointCoordinates(new i(0,0),e)}rotated(e){return this.clone().rotate(e)}distanceTo(e){return Math.sqrt((this._x-e.x)**2+(this.y-e.y)**2)}}const n="https://dungeon-game-go.onrender.com",s=`${n}/api/v1`,a=1280,r=720,o="Texturina",l="#000000E6",h=new i(31,26),c=new i(22,56),d=new i(39,47),u="#00FFFF",g=new i(31,26),p=new i(31,60),f="#FF0000",y={FLOOR:t.floorTexture,WALL:t.wallTexture,PLAYER:t.playerTexture,PLAYER_SHOTGUN:t.playerShotgunTexture,PLAYER_RAILGUN:t.playerRailgunTexture,PLAYER_ROCKET_LAUNCHER:t.playerRocketLauncherTexture,ENEMY:t.enemyTexture,BLOOD:t.bloodTexture,AID_KIT:t.aidKitTexture,GOGGLES:t.gogglesTexture,CHEST:t.chestTexture,HEART:t.heartTexture,SHOP:t.shopTexturne,SHOP_LAYOUT:t.shopLayoutTexture,INVENTORY:t.inventoryTexture,ITEM_RAILGUN:t.itemRailgunTexture,ITEM_ROCKET_LAUNCHER:t.itemRocketLauncherTexture,ITEM_SHOTGUN:t.itemShotgunTexture,ITEM_BLASTER:t.itemBlasterTexture,ITEM_AMMO_SHOTGUN:t.itemAmmoShotgunTexture,ITEM_AMMO_ROCKET_LAUNCHER:t.itemAmmoRocketLauncherTexture,ITEM_AMMO_RAILGUN:t.itemAmmoRailgunTexture,BULLET_ROCKET:t.bulletRocketTexture},m={EXPLOSION:t.explosionAnimation},w={BULLET:t.bulletSound,TORCH:t.torchSound,GAME_OVER:t.gameOverSound,PLAYER_HURT:t.playerHurtSound,PLAYER_DEAD:t.playerDeadSound,ENEMY_HURT:t.enemyHurtSound,PLAYER_BULLET_RECHARGE:t.playerBulletRechargeSound,BONUS_PICKUP:t.bonusPickupSound,SPAWN:t.spawnSound,ROCKET_LAUNCHER:t.rocketLauncherSound,ROCKET_BLAST:t.rocketBlastSound,RAILGUN:t.railgunSound,SHOTGUN:t.shotgunSound,ENTER_SHOP:t.enterShopSound,MONEY_SPENT:t.moneySpentSound,MISTAKE:t.mistakeSound},b=1,k=2,_=3,T=4,v=22,S=23,I=24,E=7,N=8,B=[22,23,24],R={[b]:y.ITEM_BLASTER,[k]:y.ITEM_SHOTGUN,[_]:y.ITEM_ROCKET_LAUNCHER,[T]:y.ITEM_RAILGUN,[v]:y.ITEM_AMMO_SHOTGUN,[S]:y.ITEM_AMMO_ROCKET_LAUNCHER,[I]:y.ITEM_AMMO_RAILGUN,[N]:y.AID_KIT,[E]:y.GOGGLES},P={blaster:w.BULLET,shotgun:w.SHOTGUN,railgun:w.RAILGUN,rocket_launcher:w.ROCKET_LAUNCHER},L=["railgun","rocket_launcher"],O={shotgun:22,rocket_launcher:23,railgun:24},x={blaster:1,shotgun:2,rocket_launcher:3,railgun:4},A=[7,8],M={blaster:"‚óè",shotgun:"‚Åç",railgun:"‚ö°",rocket_launcher:"üöÄ"},D={blaster:y.PLAYER,shotgun:y.PLAYER_SHOTGUN,railgun:y.PLAYER_RAILGUN,rocket_launcher:y.PLAYER_ROCKET_LAUNCHER},U={blaster:0,shotgun:0,railgun:200,rocket_launcher:m.EXPLOSION.duration},C={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let j;const V=new Uint8Array(16);function $(){if(!j){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");j=crypto.getRandomValues.bind(crypto)}return j(V)}const F=[];for(let e=0;e<256;++e)F.push((e+256).toString(16).slice(1));const G=function(e,t,i){if(C.randomUUID&&!t&&!e)return C.randomUUID();const n=(e=e||{}).random||(e.rng||$)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=n[e];return t}return function(e,t=0){return(F[e[t+0]]+F[e[t+1]]+F[e[t+2]]+F[e[t+3]]+"-"+F[e[t+4]]+F[e[t+5]]+"-"+F[e[t+6]]+F[e[t+7]]+"-"+F[e[t+8]]+F[e[t+9]]+"-"+F[e[t+10]]+F[e[t+11]]+F[e[t+12]]+F[e[t+13]]+F[e[t+14]]+F[e[t+15]]).toLowerCase()}(n)};class K{_point;_width;_height;_id;static _objectNumber=0;static get objectCount(){return K._objectNumber}get id(){return this._id}constructor(e,t,i,n=G()){this._point=e,this._width=t,this._height=i,this._id=n,K._objectNumber++}get x(){return this._point.x}get y(){return this._point.y}get width(){return this._width}get height(){return this._height}getPosition(){return this._point}moveBy(e,t){this._point.moveBy(e,t)}getCollisionRect(e=0,t=0){return{left:this.x-this.width/2+e,top:this.y-this.height/2+t,width:this.width,height:this.height}}checkCollision(e,t,i,n){const s=this.getCollisionRect();return s.left<e+i&&s.left+s.width>e&&s.top<t+n&&s.top+s.height>t}checkCollisionWithObject(e){const t=e.getCollisionRect();return this.checkCollision(t.left,t.top,t.width,t.height)}}function W(e){return new Promise(((t,i)=>{const n=new Image;n.onload=()=>t(n),n.onerror=t=>i(new Error(`Failed to load image: ${e}`)),n.src=e}))}class H extends K{world;type;image=null;constructor(e,t){let n="",s=0;"aid_kit"===t.type?(n=y.AID_KIT,s=32):"goggles"===t.type?(n=y.GOGGLES,s=32):"chest"===t.type&&(n=y.CHEST,s=32),super(new i(t.position.x,t.position.y),s,s,t.id),this.world=e,this.type=t.type,W(n).then((e=>{this.image=e}))}draw(e){if(!this.image||!this.world.player)return;const t=this.world.player;let i=(this.getPosition().distanceTo(t.getPosition())<=this.world.torchRadius+this.width||t.hasNightVision())&&!this.world.gameOver;for(const e of this.world.otherPlayers)if(!e.hasNightVision()&&this.getPosition().distanceTo(e.getPosition())<=this.world.torchRadius+this.width){i=!0;break}if(!i)return;const n=this.world.worldToScreenCoordinates(this.getPosition());e.save(),e.translate(n.x,n.y),e.drawImage(this.image,-this.width/2,-this.height/2,this.width,this.height),e.restore()}}class Y{static instance;audioContext;soundBuffers;loadingPromises;activeSources=new Map;constructor(){this.audioContext=new AudioContext,this.soundBuffers=new Map,this.loadingPromises=new Map}static getInstance(){return Y.instance||(Y.instance=new Y),Y.instance}async loadSound(e){if(this.soundBuffers.has(e)||this.loadingPromises.has(e))return;const t=fetch(e).then((e=>e.arrayBuffer())).then((e=>this.audioContext.decodeAudioData(e))).then((t=>{this.soundBuffers.set(e,t)}));this.loadingPromises.set(e,t),await t}playSound(e,t){const i=this.soundBuffers.get(e);if(!i)return void console.warn(`Sound not loaded: ${e}`);const n=this.audioContext.createBufferSource();n.buffer=i,n.loop=t?.loop??!1;const s=this.audioContext.createGain();s.gain.value=t?.volume??1,n.connect(s),s.connect(this.audioContext.destination),this.activeSources.has(e)||this.activeSources.set(e,new Set),this.activeSources.get(e).add(n),n.onended=()=>{const t=this.activeSources.get(e);t&&t.delete(n)},n.start(t?.when??0,t?.offset??0)}stopSound(e){const t=this.activeSources.get(e);t&&(t.forEach((e=>{try{e.stop()}catch(e){}})),t.clear())}stopAllSounds(){this.activeSources.forEach(((e,t)=>{e.forEach((e=>{try{e.stop()}catch(e){}})),e.clear()}))}}class q extends K{world;_wall;image=null;bloodImage=null;dead=!1;_lives=1;_bullets=[];_rotation=0;get lives(){return this._lives}get wall(){return this._wall}constructor(e,t,n){Math.random();const s=n.position??{x:0,y:0};super(new i(s.x,s.y),24,24,n.id),this.world=e,this._wall=t,this._rotation=n.rotation,this._lives=n.lives,this.dead=n.isDead,W(y.ENEMY).then((e=>{this.image=e})),W(y.BLOOD).then((e=>{this.bloodImage=e}))}get rotation(){return this._rotation}getGunPoint(){return this.getPosition().movedByPointCoordinates(g.inverted()).moveByPointCoordinates(p).rotateAroundPointCoordinates(this.getPosition(),this.rotation)}draw(e,t){this._bullets.forEach((i=>{i.draw(e,t)}));const n=this.world.player;if(!this.image||!n)return;let s=!1;if(this.world.gameOver)s=!1;else if(n.isAlive()&&n.hasNightVision())s=!0;else{const e=[n,...this.world.otherPlayers.filter((e=>e.isAlive()&&!e.hasNightVision))];for(const t of e){const e=this.getPosition().distanceTo(t.getTorchPoint());s=s||e<=this.world.torchRadius+this.width}}const a=this.world.worldToScreenCoordinates(this.getPosition());e.save(),e.translate(a.x,a.y);const r=this.dead?32:64,l=this.dead?new i(-r/2,-r/2):g.inverted();if(e.rotate(this.rotation*Math.PI/180),this.dead&&s&&this.bloodImage&&e.drawImage(this.bloodImage,-this.width/2,-this.height/2,this.width,this.height),!this.dead&&s&&this.image&&e.drawImage(this.image,l.x,l.y,r,r),e.restore(),this.world.debug){if(t.save(),t.translate(a.x,a.y),t.strokeStyle="#00ff00",t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),!this.dead){t.rotate(this.rotation*Math.PI/180),t.fillStyle="magenta";const e=l.movedByPointCoordinates(p);t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill(),t.rotate(-this.rotation*Math.PI/180)}t.fillStyle="white",t.font=`12px ${o}`,t.textAlign="left",t.fillText(`Wall #${this._wall.id}`,-20,24),t.fillText(`Position: ${this.getPosition()}`,-20,36),t.restore()}}isAlive(){return!this.dead}isInvulnerable(){return!1}applyFromGameState(e){if(this._point.setTo(e.position.x,e.position.y),this._rotation=e.rotation,e.lives<this._lives){const e=this.getPosition().distanceTo(this.world.player.getPosition()),t=2*this.world.torchRadius,i=e>=t?0:1-e/t;Y.getInstance().playSound(w.ENEMY_HURT,{volume:i})}this._lives=e.lives,this.dead=e.isDead}}class J extends K{world;_nightVisionTimer=0;_rotation=0;_bullets=[];_bulletsLeft=6;_kills=0;_money=0;_score=0;_selectedGunType="blaster";_inventory=[];_images={blaster:null,shotgun:null,railgun:null,rocket_launcher:null};_imageDead=null;_inventoryImage=null;_inventoryOpen=!0;_invulnerableTimer=0;_debugData={};_lives=0;get money(){return this._money}get score(){return this._score}get kills(){return this._kills}get bulletsLeft(){return this._bulletsLeft}get rotation(){return this._rotation}get nightVisionTimer(){return this._nightVisionTimer}get selectedGunType(){return this._selectedGunType}get inventory(){return this._inventory}hasInventoryItem(e){return this._inventory.some((t=>t.type===e&&t.quantity>0))}toggleInventory(){this._inventoryOpen=!this._inventoryOpen}static createFromSessionPlayer(e,t){const n=new J(e,new i(t.position.x,t.position.y),t.position.rotation,t.player_id);return n._lives=t.lives,n._kills=t.kills,n._money=t.money,n}constructor(e,t,i,n=""){super(t,24,24,n),this.world=e,this._rotation=i,W(D.blaster).then((e=>{this._images.blaster=e})),W(D.shotgun).then((e=>{this._images.shotgun=e})),W(D.railgun).then((e=>{this._images.railgun=e})),W(D.rocket_launcher).then((e=>{this._images.rocket_launcher=e})),W(y.INVENTORY).then((e=>{this._inventoryImage=e})),W(y.BLOOD).then((e=>{this._imageDead=e}))}getGunPoint(){return this.getPosition().movedByPointCoordinates(h.inverted()).moveByPointCoordinates(c).rotateAroundPointCoordinates(this.getPosition(),this._rotation)}getTorchPoint(){return this.getPosition().movedByPointCoordinates(h.inverted()).moveByPointCoordinates(d).rotateAroundPointCoordinates(this.getPosition(),this._rotation)}takeDamage(e){this._lives-=e,Y.getInstance().playSound(this._lives>0?w.PLAYER_HURT:w.PLAYER_DEAD)}hasNightVision(){return this._nightVisionTimer>0}isNightVisionFading(){return this._nightVisionTimer<2&&this._nightVisionTimer%.2<.1}update(e){this._invulnerableTimer>0&&(this._invulnerableTimer=Math.max(0,this._invulnerableTimer-e)),this._nightVisionTimer>0&&(this._nightVisionTimer=Math.max(0,this._nightVisionTimer-e))}draw(e,t){if(this._bullets.forEach((i=>{i.draw(e,t)})),!this._images[this._selectedGunType]||!this._imageDead)return;const i=this.world.worldToScreenCoordinates(this.getPosition());e.save();const n=5*this._invulnerableTimer/1,s=n-Math.floor(n)<.5,a=h.inverted();if(e.translate(i.x,i.y),(this._invulnerableTimer<=0||s)&&!this.world.gameOver){this.isAlive()?this._images[this._selectedGunType]:this._imageDead;const t=this.isAlive()?64:32;e.rotate(this._rotation*Math.PI/180),e.drawImage(this.isAlive()?this._images[this._selectedGunType]:this._imageDead,a.x,a.y,t,t),e.rotate(-this._rotation*Math.PI/180)}if(e.restore(),this.world.debug){t.strokeStyle="red",t.strokeRect(-this.width/2+i.x,-this.height/2+i.y,this.width,this.height),t.fillStyle="magenta",t.beginPath(),t.arc(i.x,i.y,2,0,2*Math.PI),t.fill(),t.fillStyle="magenta";const e=this.world.worldToScreenCoordinates(this.getGunPoint());t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill(),t.fillStyle="cyan";const n=this.world.worldToScreenCoordinates(this.getTorchPoint());t.beginPath(),t.arc(n.x,n.y,2,0,2*Math.PI),t.fill()}}drawUI(e){if(this._inventoryImage&&!this.world.gameOver&&this._inventoryOpen){e.save(),e.globalAlpha=.7;const t=this._inventoryImage.width,i=this._inventoryImage.height,n=30,s=42;e.drawImage(this._inventoryImage,640-t/2,r-i-n,t,i),this._inventory&&this._inventory.forEach((a=>{if(!a.quantity)return;const l=this.world.getInventoryTexture(a.type);if(!l)return;const h=B.includes(a.type),c=(h?a.type-s/2:a.type)*s-s/2,d=h?s/2:1.5*s;e.drawImage(l,640-t/2+c-l.width/2,r-i-n+d-l.height/2,l.width,l.height),a.quantity>1&&(e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(640-t/2+c-s/2,r-i-n+d+s/2-16,l.width,16),e.fillStyle="white",e.font=`16px ${o}`,e.textAlign="right",e.fillText(`x${a.quantity}`,640-t/2+c+s/2-4,r-i-n+d+s/2-4)),a.type===x[this._selectedGunType]&&(e.strokeStyle="yellow",e.lineWidth=2,e.strokeRect(640-t/2+c-s/2,r-i-n+d-s/2,s,s))})),e.restore()}this.world.debug&&(e.fillStyle="white",e.font=`12px ${o}`,e.textAlign="left",e.fillText(`Collision hits: ${this._debugData.collisionHits}`,10,e.canvas.height-38),e.fillText(`Player position: ${this.getPosition()}`,10,e.canvas.height-24),e.fillText(`Rotation: ${this._rotation}`,10,e.canvas.height-10))}isAlive(){return this._lives>0}die(){}get lives(){return this._lives}recordKill(e){this._kills++,this._money+=e}isInvulnerable(){return this._invulnerableTimer>0}static fromGameState(e,t){const n=new i(t.position.x,t.position.y),s=new J(e,n,t.rotation,t.id);return s.applyFromGameState(t),s}applyFromGameState(e){if(this._score=e.score,e.position&&(this.getPosition().setTo(e.position.x,e.position.y),this._rotation=e.rotation),this._lives>e.lives?this.takeDamage(this._lives-e.lives):this._lives<e.lives&&(this._lives=e.lives),this.isAlive()||this.world.endGame(),this._money=e.money,this._kills=e.kills,e.selectedGunType===this._selectedGunType&&!L.includes(e.selectedGunType)&&this._bulletsLeft<e.bulletsLeftByWeaponType[e.selectedGunType]&&Y.getInstance().playSound(w.PLAYER_BULLET_RECHARGE,{volume:.5}),L.includes(e.selectedGunType)){const t=O[e.selectedGunType],i=e.inventory.find((e=>e.type===t));this._bulletsLeft=i?.quantity??0}else this._bulletsLeft=e.bulletsLeftByWeaponType[e.selectedGunType]??0;this._selectedGunType=e.selectedGunType,this._invulnerableTimer=e.invulnerableTimer,this._nightVisionTimer=e.nightVisionTimer,this.world.isPlayerInShop()?e.inventory.forEach((e=>{const t=this._inventory.find((t=>t.type===e.type));(!t||e.quantity>t.quantity)&&Y.getInstance().playSound(w.MONEY_SPENT)})):this._inventory.filter((e=>A.includes(e.type))).forEach((t=>{const i=e.inventory.find((e=>e.type===t.type));(!i||i.quantity<t.quantity)&&Y.getInstance().playSound(w.BONUS_PICKUP)})),this._inventory=e.inventory}}class X extends K{world;_orientation;image=null;constructor(e,t,i,n,s,a){super(t,i,n,a),this.world=e,this._orientation=s,W(y.WALL).then((e=>{this.image=e}))}get orientation(){return this._orientation}draw(e,t){if(!this.image)return;const i=this.world.worldToScreenCoordinates(this.getLeftTopCorner());t.save(),t.translate(i.x,i.y),e.save(),e.translate(i.x,i.y);let[n,s]=[this._width,this._height];if("vertical"===this._orientation&&([n,s]=[this._height,this._width]),"vertical"===this._orientation&&(e.rotate(Math.PI/2),e.translate(0,-this.width),t.rotate(Math.PI/2),t.translate(0,-this.width)),e.drawImage(this.image,0,0,n,s),this.world.debug&&(t.strokeStyle="red",t.strokeRect(0,0,n,s),t.fillStyle="white",t.font=`12px ${o}`,t.fillText(`#${this.id} ${this.getPosition()}`,2,12),t.fillText(`Width: ${this.width}, Height: ${this.height}`,2,24)),e.restore(),t.restore(),this.world.debug){const e=this.world.worldToScreenCoordinates(this.getPosition());t.fillStyle="magenta",t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill()}}getCollisionRect(){const{x:e,y:t}=this.getLeftTopCorner();return{left:e,top:t,width:this._width,height:this.height}}getLeftTopCorner(){let e=0,t=0;return"vertical"==this.orientation?e=this._width/2:t=this.height/2,this.getPosition().movedBy(-e,-t)}}class Z{static instance;userData=null;authUrl=null;performingRequest=!1;_token=null;urls={login:"/auth/google/url",user:"/auth/user"};constructor(){}static getInstance(){return Z.instance||(Z.instance=new Z),Z.instance}async get(e,t={}){this.performingRequest=!0;try{const i=await fetch(s+e,{method:"GET",...t,headers:{...t.headers,Authorization:`Bearer ${this.getToken()}`}});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return i.json()}catch(e){throw console.error("Request failed: ",e),e}finally{this.performingRequest=!1}}initToken(){let e=new URLSearchParams(window.location.search).get("token");e?(localStorage.setItem("token",e),history.pushState({},"",window.location.pathname)):e=localStorage.getItem("token"),this._token=e}getToken(){return this._token}async getAuthUrl(){const e=await this.get(this.urls.login);return this.authUrl=e.url,this.authUrl}async checkAuthStatus(){const e=await this.get(this.urls.user);return this.userData=e,e}isPerformingRequest(){return this.performingRequest}getUserData(){return this.userData}openAuthPage(){this.authUrl&&(window.location.href=this.authUrl)}}class z{static getUrl(e,t){const i=new URL(s+e);return t&&Object.entries(t).forEach((([e,t])=>{i.searchParams.append(e,t)})),i.toString()}static async request(e,t={}){const{params:i,...n}=t,s=this.getUrl(e,i),a=Z.getInstance(),r=new Headers(t.headers||{});r.set("Content-Type","application/json");const o=a.getToken();o&&r.set("Authorization",`Bearer ${o}`);const l=await fetch(s,{...n,headers:r});if(!l.ok){const e=new Error;throw e.message=await l.text(),e.code=l.status,e}return l.json()}static async get(e,t={}){return this.request(e,{...t,method:"GET"})}static async post(e,t,i={}){return this.request(e,{...i,method:"POST",body:t?JSON.stringify(t):void 0})}static async patch(e,t,i={}){return this.request(e,{...i,method:"PATCH",body:JSON.stringify(t)})}static async delete(e,t={}){return this.request(e,{...t,method:"DELETE"})}}var Q,ee;function te(e,t,i){let n,s,a=i;for(let i of e.fields){let e=i.localName;if(i.oneof){const r=a[i.oneof];if(null==(null==r?void 0:r.oneofKind))continue;if(n=r[e],s=t[i.oneof],s.oneofKind=r.oneofKind,null==n){delete s[e];continue}}else if(n=a[e],s=t,null==n)continue;switch(i.repeat&&(s[e].length=n.length),i.kind){case"scalar":case"enum":if(i.repeat)for(let t=0;t<n.length;t++)s[e][t]=n[t];else s[e]=n;break;case"message":let t=i.T();if(i.repeat)for(let i=0;i<n.length;i++)s[e][i]=t.create(n[i]);else void 0===s[e]?s[e]=t.create(n):t.mergePartial(s[e],n);break;case"map":switch(i.V.kind){case"scalar":case"enum":Object.assign(s[e],n);break;case"message":let t=i.V.T();for(let i of Object.keys(n))s[e][i]=t.create(n[i])}}}}!function(e){e.symbol=Symbol.for("protobuf-ts/unknown"),e.onRead=(i,n,s,a,r)=>{(t(n)?n[e.symbol]:n[e.symbol]=[]).push({no:s,wireType:a,data:r})},e.onWrite=(t,i,n)=>{for(let{no:t,wireType:s,data:a}of e.list(i))n.tag(t,s).raw(a)},e.list=(i,n)=>{if(t(i)){let t=i[e.symbol];return n?t.filter((e=>e.no==n)):t}return[]},e.last=(t,i)=>e.list(t,i).slice(-1)[0];const t=t=>t&&Array.isArray(t[e.symbol])}(Q||(Q={})),function(e){e[e.Varint=0]="Varint",e[e.Bit64=1]="Bit64",e[e.LengthDelimited=2]="LengthDelimited",e[e.StartGroup=3]="StartGroup",e[e.EndGroup=4]="EndGroup",e[e.Bit32=5]="Bit32"}(ee||(ee={}));const ie=Symbol.for("protobuf-ts/message-type");function ne(e){let t=!1;const i=[];for(let n=0;n<e.length;n++){let s=e.charAt(n);"_"==s?t=!0:/\d/.test(s)?(i.push(s),t=!0):t?(i.push(s.toUpperCase()),t=!1):0==n?i.push(s.toLowerCase()):i.push(s)}return i.join("")}var se,ae,re;function oe(e){var t,i,n,s;return e.localName=null!==(t=e.localName)&&void 0!==t?t:ne(e.name),e.jsonName=null!==(i=e.jsonName)&&void 0!==i?i:ne(e.name),e.repeat=null!==(n=e.repeat)&&void 0!==n?n:re.NO,e.opt=null!==(s=e.opt)&&void 0!==s?s:!e.repeat&&!e.oneof&&"message"==e.kind,e}function le(e){if("object"!=typeof e||null===e||!e.hasOwnProperty("oneofKind"))return!1;switch(typeof e.oneofKind){case"string":return void 0!==e[e.oneofKind]&&2==Object.keys(e).length;case"undefined":return 1==Object.keys(e).length;default:return!1}}!function(e){e[e.DOUBLE=1]="DOUBLE",e[e.FLOAT=2]="FLOAT",e[e.INT64=3]="INT64",e[e.UINT64=4]="UINT64",e[e.INT32=5]="INT32",e[e.FIXED64=6]="FIXED64",e[e.FIXED32=7]="FIXED32",e[e.BOOL=8]="BOOL",e[e.STRING=9]="STRING",e[e.BYTES=12]="BYTES",e[e.UINT32=13]="UINT32",e[e.SFIXED32=15]="SFIXED32",e[e.SFIXED64=16]="SFIXED64",e[e.SINT32=17]="SINT32",e[e.SINT64=18]="SINT64"}(se||(se={})),function(e){e[e.BIGINT=0]="BIGINT",e[e.STRING=1]="STRING",e[e.NUMBER=2]="NUMBER"}(ae||(ae={})),function(e){e[e.NO=0]="NO",e[e.PACKED=1]="PACKED",e[e.UNPACKED=2]="UNPACKED"}(re||(re={}));class he{constructor(e){var t;this.fields=null!==(t=e.fields)&&void 0!==t?t:[]}prepare(){if(this.data)return;const e=[],t=[],i=[];for(let n of this.fields)if(n.oneof)i.includes(n.oneof)||(i.push(n.oneof),e.push(n.oneof),t.push(n.oneof));else switch(t.push(n.localName),n.kind){case"scalar":case"enum":n.opt&&!n.repeat||e.push(n.localName);break;case"message":n.repeat&&e.push(n.localName);break;case"map":e.push(n.localName)}this.data={req:e,known:t,oneofs:Object.values(i)}}is(e,t,i=!1){if(t<0)return!0;if(null==e||"object"!=typeof e)return!1;this.prepare();let n=Object.keys(e),s=this.data;if(n.length<s.req.length||s.req.some((e=>!n.includes(e))))return!1;if(!i&&n.some((e=>!s.known.includes(e))))return!1;if(t<1)return!0;for(const n of s.oneofs){const s=e[n];if(!le(s))return!1;if(void 0===s.oneofKind)continue;const a=this.fields.find((e=>e.localName===s.oneofKind));if(!a)return!1;if(!this.field(s[s.oneofKind],a,i,t))return!1}for(const n of this.fields)if(void 0===n.oneof&&!this.field(e[n.localName],n,i,t))return!1;return!0}field(e,t,i,n){let s=t.repeat;switch(t.kind){case"scalar":return void 0===e?t.opt:s?this.scalars(e,t.T,n,t.L):this.scalar(e,t.T,t.L);case"enum":return void 0===e?t.opt:s?this.scalars(e,se.INT32,n):this.scalar(e,se.INT32);case"message":return void 0===e||(s?this.messages(e,t.T(),i,n):this.message(e,t.T(),i,n));case"map":if("object"!=typeof e||null===e)return!1;if(n<2)return!0;if(!this.mapKeys(e,t.K,n))return!1;switch(t.V.kind){case"scalar":return this.scalars(Object.values(e),t.V.T,n,t.V.L);case"enum":return this.scalars(Object.values(e),se.INT32,n);case"message":return this.messages(Object.values(e),t.V.T(),i,n)}}return!0}message(e,t,i,n){return i?t.isAssignable(e,n):t.is(e,n)}messages(e,t,i,n){if(!Array.isArray(e))return!1;if(n<2)return!0;if(i){for(let i=0;i<e.length&&i<n;i++)if(!t.isAssignable(e[i],n-1))return!1}else for(let i=0;i<e.length&&i<n;i++)if(!t.is(e[i],n-1))return!1;return!0}scalar(e,t,i){let n=typeof e;switch(t){case se.UINT64:case se.FIXED64:case se.INT64:case se.SFIXED64:case se.SINT64:switch(i){case ae.BIGINT:return"bigint"==n;case ae.NUMBER:return"number"==n&&!isNaN(e);default:return"string"==n}case se.BOOL:return"boolean"==n;case se.STRING:return"string"==n;case se.BYTES:return e instanceof Uint8Array;case se.DOUBLE:case se.FLOAT:return"number"==n&&!isNaN(e);default:return"number"==n&&Number.isInteger(e)}}scalars(e,t,i,n){if(!Array.isArray(e))return!1;if(i<2)return!0;if(Array.isArray(e))for(let s=0;s<e.length&&s<i;s++)if(!this.scalar(e[s],t,n))return!1;return!0}mapKeys(e,t,i){let n=Object.keys(e);switch(t){case se.INT32:case se.FIXED32:case se.SFIXED32:case se.SINT32:case se.UINT32:return this.scalars(n.slice(0,i).map((e=>parseInt(e))),t,i);case se.BOOL:return this.scalars(n.slice(0,i).map((e=>"true"==e||"false"!=e&&e)),t,i);default:return this.scalars(n,t,i,ae.STRING)}}}function ce(e){let t=typeof e;if("object"==t){if(Array.isArray(e))return"array";if(null===e)return"null"}return t}let de="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),ue=[];for(let e=0;e<de.length;e++)ue[de[e].charCodeAt(0)]=e;function ge(){let e=0,t=0;for(let i=0;i<28;i+=7){let n=this.buf[this.pos++];if(e|=(127&n)<<i,!(128&n))return this.assertBounds(),[e,t]}let i=this.buf[this.pos++];if(e|=(15&i)<<28,t=(112&i)>>4,!(128&i))return this.assertBounds(),[e,t];for(let i=3;i<=31;i+=7){let n=this.buf[this.pos++];if(t|=(127&n)<<i,!(128&n))return this.assertBounds(),[e,t]}throw new Error("invalid varint")}function pe(e,t,i){for(let n=0;n<28;n+=7){const s=e>>>n,a=!(s>>>7==0&&0==t),r=255&(a?128|s:s);if(i.push(r),!a)return}const n=e>>>28&15|(7&t)<<4,s=!!(t>>3);if(i.push(255&(s?128|n:n)),s){for(let e=3;e<31;e+=7){const n=t>>>e,s=!(n>>>7==0),a=255&(s?128|n:n);if(i.push(a),!s)return}i.push(t>>>31&1)}}ue["-".charCodeAt(0)]=de.indexOf("+"),ue["_".charCodeAt(0)]=de.indexOf("/");const fe=4294967296;function ye(e){let t="-"==e[0];t&&(e=e.slice(1));const i=1e6;let n=0,s=0;function a(t,a){const r=Number(e.slice(t,a));s*=i,n=n*i+r,n>=fe&&(s+=n/fe|0,n%=fe)}return a(-24,-18),a(-18,-12),a(-12,-6),a(-6),[t,n,s]}function me(e,t){if(t>>>0<=2097151)return""+(fe*t+(e>>>0));let i=(e>>>24|t<<8)>>>0&16777215,n=t>>16&65535,s=(16777215&e)+6777216*i+6710656*n,a=i+8147497*n,r=2*n,o=1e7;function l(e,t){let i=e?String(e):"";return t?"0000000".slice(i.length)+i:i}return s>=o&&(a+=Math.floor(s/o),s%=o),a>=o&&(r+=Math.floor(a/o),a%=o),l(r,0)+l(a,r)+l(s,1)}function we(e,t){if(e>=0){for(;e>127;)t.push(127&e|128),e>>>=7;t.push(e)}else{for(let i=0;i<9;i++)t.push(127&e|128),e>>=7;t.push(1)}}function be(){let e=this.buf[this.pos++],t=127&e;if(!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<7,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<14,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<21,!(128&e))return this.assertBounds(),t;e=this.buf[this.pos++],t|=(15&e)<<28;for(let t=5;128&e&&t<10;t++)e=this.buf[this.pos++];if(128&e)throw new Error("invalid varint");return this.assertBounds(),t>>>0}let ke;function _e(e){if(!e)throw new Error("BigInt unavailable, see https://github.com/timostamm/protobuf-ts/blob/v1.0.8/MANUAL.md#bigint-support")}!function(){const e=new DataView(new ArrayBuffer(8)),t=void 0!==globalThis.BigInt&&"function"==typeof e.getBigInt64&&"function"==typeof e.getBigUint64&&"function"==typeof e.setBigInt64&&"function"==typeof e.setBigUint64;ke=t?{MIN:BigInt("-9223372036854775808"),MAX:BigInt("9223372036854775807"),UMIN:BigInt("0"),UMAX:BigInt("18446744073709551615"),C:BigInt,V:e}:void 0}();const Te=/^-?[0-9]+$/,ve=4294967296,Se=2147483648;class Ie{constructor(e,t){this.lo=0|e,this.hi=0|t}isZero(){return 0==this.lo&&0==this.hi}toNumber(){let e=this.hi*ve+(this.lo>>>0);if(!Number.isSafeInteger(e))throw new Error("cannot convert to safe number");return e}}class Ee extends Ie{static from(e){if(ke)switch(typeof e){case"string":if("0"==e)return this.ZERO;if(""==e)throw new Error("string is no integer");e=ke.C(e);case"number":if(0===e)return this.ZERO;e=ke.C(e);case"bigint":if(!e)return this.ZERO;if(e<ke.UMIN)throw new Error("signed value for ulong");if(e>ke.UMAX)throw new Error("ulong too large");return ke.V.setBigUint64(0,e,!0),new Ee(ke.V.getInt32(0,!0),ke.V.getInt32(4,!0))}else switch(typeof e){case"string":if("0"==e)return this.ZERO;if(e=e.trim(),!Te.test(e))throw new Error("string is no integer");let[t,i,n]=ye(e);if(t)throw new Error("signed value for ulong");return new Ee(i,n);case"number":if(0==e)return this.ZERO;if(!Number.isSafeInteger(e))throw new Error("number is no integer");if(e<0)throw new Error("signed value for ulong");return new Ee(e,e/ve)}throw new Error("unknown value "+typeof e)}toString(){return ke?this.toBigInt().toString():me(this.lo,this.hi)}toBigInt(){return _e(ke),ke.V.setInt32(0,this.lo,!0),ke.V.setInt32(4,this.hi,!0),ke.V.getBigUint64(0,!0)}}Ee.ZERO=new Ee(0,0);class Ne extends Ie{static from(e){if(ke)switch(typeof e){case"string":if("0"==e)return this.ZERO;if(""==e)throw new Error("string is no integer");e=ke.C(e);case"number":if(0===e)return this.ZERO;e=ke.C(e);case"bigint":if(!e)return this.ZERO;if(e<ke.MIN)throw new Error("signed long too small");if(e>ke.MAX)throw new Error("signed long too large");return ke.V.setBigInt64(0,e,!0),new Ne(ke.V.getInt32(0,!0),ke.V.getInt32(4,!0))}else switch(typeof e){case"string":if("0"==e)return this.ZERO;if(e=e.trim(),!Te.test(e))throw new Error("string is no integer");let[t,i,n]=ye(e);if(t){if(n>Se||n==Se&&0!=i)throw new Error("signed long too small")}else if(n>=Se)throw new Error("signed long too large");let s=new Ne(i,n);return t?s.negate():s;case"number":if(0==e)return this.ZERO;if(!Number.isSafeInteger(e))throw new Error("number is no integer");return e>0?new Ne(e,e/ve):new Ne(-e,-e/ve).negate()}throw new Error("unknown value "+typeof e)}isNegative(){return!!(this.hi&Se)}negate(){let e=~this.hi,t=this.lo;return t?t=1+~t:e+=1,new Ne(t,e)}toString(){if(ke)return this.toBigInt().toString();if(this.isNegative()){let e=this.negate();return"-"+me(e.lo,e.hi)}return me(this.lo,this.hi)}toBigInt(){return _e(ke),ke.V.setInt32(0,this.lo,!0),ke.V.setInt32(4,this.hi,!0),ke.V.getBigInt64(0,!0)}}function Be(e,t){if(!e)throw new Error(t)}function Re(e){if("number"!=typeof e)throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>2147483647||e<-2147483648)throw new Error("invalid int 32: "+e)}function Pe(e){if("number"!=typeof e)throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>4294967295||e<0)throw new Error("invalid uint 32: "+e)}function Le(e){if("number"!=typeof e)throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>34028234663852886e22||e<-34028234663852886e22))throw new Error("invalid float 32: "+e)}function Oe(e,t){switch(t){case ae.BIGINT:return e.toBigInt();case ae.NUMBER:return e.toNumber();default:return e.toString()}}Ne.ZERO=new Ne(0,0);class xe{constructor(e){this.info=e}prepare(){var e;if(void 0===this.fMap){this.fMap={};const t=null!==(e=this.info.fields)&&void 0!==e?e:[];for(const e of t)this.fMap[e.name]=e,this.fMap[e.jsonName]=e,this.fMap[e.localName]=e}}assert(e,t,i){if(!e){let e=ce(i);throw"number"!=e&&"boolean"!=e||(e=i.toString()),new Error(`Cannot parse JSON ${e} for ${this.info.typeName}#${t}`)}}read(e,t,i){this.prepare();const n=[];for(const[a,r]of Object.entries(e)){const e=this.fMap[a];if(!e){if(!i.ignoreUnknownFields)throw new Error(`Found unknown field while reading ${this.info.typeName} from JSON format. JSON key: ${a}`);continue}const o=e.localName;let l;if(e.oneof){if(null===r&&("enum"!==e.kind||"google.protobuf.NullValue"!==e.T()[0]))continue;if(n.includes(e.oneof))throw new Error(`Multiple members of the oneof group "${e.oneof}" of ${this.info.typeName} are present in JSON.`);n.push(e.oneof),l=t[e.oneof]={oneofKind:o}}else l=t;if("map"==e.kind){if(null===r)continue;this.assert(null!==(s=r)&&"object"==typeof s&&!Array.isArray(s),e.name,r);const t=l[o];for(const[n,s]of Object.entries(r)){let a;switch(this.assert(null!==s,e.name+" map value",null),e.V.kind){case"message":a=e.V.T().internalJsonRead(s,i);break;case"enum":if(a=this.enum(e.V.T(),s,e.name,i.ignoreUnknownFields),!1===a)continue;break;case"scalar":a=this.scalar(s,e.V.T,e.V.L,e.name)}this.assert(void 0!==a,e.name+" map value",s);let r=n;e.K==se.BOOL&&(r="true"==r||"false"!=r&&r),r=this.scalar(r,e.K,ae.STRING,e.name).toString(),t[r]=a}}else if(e.repeat){if(null===r)continue;this.assert(Array.isArray(r),e.name,r);const t=l[o];for(const n of r){let s;switch(this.assert(null!==n,e.name,null),e.kind){case"message":s=e.T().internalJsonRead(n,i);break;case"enum":if(s=this.enum(e.T(),n,e.name,i.ignoreUnknownFields),!1===s)continue;break;case"scalar":s=this.scalar(n,e.T,e.L,e.name)}this.assert(void 0!==s,e.name,r),t.push(s)}}else switch(e.kind){case"message":if(null===r&&"google.protobuf.Value"!=e.T().typeName){this.assert(void 0===e.oneof,e.name+" (oneof member)",null);continue}l[o]=e.T().internalJsonRead(r,i,l[o]);break;case"enum":if(null===r)continue;let t=this.enum(e.T(),r,e.name,i.ignoreUnknownFields);if(!1===t)continue;l[o]=t;break;case"scalar":if(null===r)continue;l[o]=this.scalar(r,e.T,e.L,e.name)}}var s}enum(e,t,i,n){if("google.protobuf.NullValue"==e[0]&&Be(null===t||"NULL_VALUE"===t,`Unable to parse field ${this.info.typeName}#${i}, enum ${e[0]} only accepts null.`),null===t)return 0;switch(typeof t){case"number":return Be(Number.isInteger(t),`Unable to parse field ${this.info.typeName}#${i}, enum can only be integral number, got ${t}.`),t;case"string":let s=t;e[2]&&t.substring(0,e[2].length)===e[2]&&(s=t.substring(e[2].length));let a=e[1][s];return(void 0!==a||!n)&&(Be("number"==typeof a,`Unable to parse field ${this.info.typeName}#${i}, enum ${e[0]} has no value for "${t}".`),a)}Be(!1,`Unable to parse field ${this.info.typeName}#${i}, cannot parse enum value from ${typeof t}".`)}scalar(e,t,i,n){let s;try{switch(t){case se.DOUBLE:case se.FLOAT:if(null===e)return 0;if("NaN"===e)return Number.NaN;if("Infinity"===e)return Number.POSITIVE_INFINITY;if("-Infinity"===e)return Number.NEGATIVE_INFINITY;if(""===e){s="empty string";break}if("string"==typeof e&&e.trim().length!==e.length){s="extra whitespace";break}if("string"!=typeof e&&"number"!=typeof e)break;let n=Number(e);if(Number.isNaN(n)){s="not a number";break}if(!Number.isFinite(n)){s="too large or small";break}return t==se.FLOAT&&Le(n),n;case se.INT32:case se.FIXED32:case se.SFIXED32:case se.SINT32:case se.UINT32:if(null===e)return 0;let a;if("number"==typeof e?a=e:""===e?s="empty string":"string"==typeof e&&(e.trim().length!==e.length?s="extra whitespace":a=Number(e)),void 0===a)break;return t==se.UINT32?Pe(a):Re(a),a;case se.INT64:case se.SFIXED64:case se.SINT64:if(null===e)return Oe(Ne.ZERO,i);if("number"!=typeof e&&"string"!=typeof e)break;return Oe(Ne.from(e),i);case se.FIXED64:case se.UINT64:if(null===e)return Oe(Ee.ZERO,i);if("number"!=typeof e&&"string"!=typeof e)break;return Oe(Ee.from(e),i);case se.BOOL:if(null===e)return!1;if("boolean"!=typeof e)break;return e;case se.STRING:if(null===e)return"";if("string"!=typeof e){s="extra whitespace";break}try{encodeURIComponent(e)}catch(s){s="invalid UTF8";break}return e;case se.BYTES:if(null===e||""===e)return new Uint8Array(0);if("string"!=typeof e)break;return function(e){let t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);let i,n=new Uint8Array(t),s=0,a=0,r=0;for(let t=0;t<e.length;t++){if(i=ue[e.charCodeAt(t)],void 0===i)switch(e[t]){case"=":a=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(a){case 0:r=i,a=1;break;case 1:n[s++]=r<<2|(48&i)>>4,r=i,a=2;break;case 2:n[s++]=(15&r)<<4|(60&i)>>2,r=i,a=3;break;case 3:n[s++]=(3&r)<<6|i,a=0}}if(1==a)throw Error("invalid base64 string.");return n.subarray(0,s)}(e)}}catch(e){s=e.message}this.assert(!1,n+(s?" - "+s:""),e)}}class Ae{constructor(e){var t;this.fields=null!==(t=e.fields)&&void 0!==t?t:[]}write(e,t){const i={},n=e;for(const e of this.fields){if(!e.oneof){let s=this.field(e,n[e.localName],t);void 0!==s&&(i[t.useProtoFieldName?e.name:e.jsonName]=s);continue}const s=n[e.oneof];if(s.oneofKind!==e.localName)continue;const a="scalar"==e.kind||"enum"==e.kind?Object.assign(Object.assign({},t),{emitDefaultValues:!0}):t;let r=this.field(e,s[e.localName],a);Be(void 0!==r),i[t.useProtoFieldName?e.name:e.jsonName]=r}return i}field(e,t,i){let n;if("map"==e.kind){Be("object"==typeof t&&null!==t);const s={};switch(e.V.kind){case"scalar":for(const[i,n]of Object.entries(t)){const t=this.scalar(e.V.T,n,e.name,!1,!0);Be(void 0!==t),s[i.toString()]=t}break;case"message":const n=e.V.T();for(const[a,r]of Object.entries(t)){const t=this.message(n,r,e.name,i);Be(void 0!==t),s[a.toString()]=t}break;case"enum":const a=e.V.T();for(const[n,r]of Object.entries(t)){Be(void 0===r||"number"==typeof r);const t=this.enum(a,r,e.name,!1,!0,i.enumAsInteger);Be(void 0!==t),s[n.toString()]=t}}(i.emitDefaultValues||Object.keys(s).length>0)&&(n=s)}else if(e.repeat){Be(Array.isArray(t));const s=[];switch(e.kind){case"scalar":for(let i=0;i<t.length;i++){const n=this.scalar(e.T,t[i],e.name,e.opt,!0);Be(void 0!==n),s.push(n)}break;case"enum":const n=e.T();for(let a=0;a<t.length;a++){Be(void 0===t[a]||"number"==typeof t[a]);const r=this.enum(n,t[a],e.name,e.opt,!0,i.enumAsInteger);Be(void 0!==r),s.push(r)}break;case"message":const a=e.T();for(let n=0;n<t.length;n++){const r=this.message(a,t[n],e.name,i);Be(void 0!==r),s.push(r)}}(i.emitDefaultValues||s.length>0||i.emitDefaultValues)&&(n=s)}else switch(e.kind){case"scalar":n=this.scalar(e.T,t,e.name,e.opt,i.emitDefaultValues);break;case"enum":n=this.enum(e.T(),t,e.name,e.opt,i.emitDefaultValues,i.enumAsInteger);break;case"message":n=this.message(e.T(),t,e.name,i)}return n}enum(e,t,i,n,s,a){if("google.protobuf.NullValue"==e[0])return s||n?null:void 0;if(void 0!==t){if(0!==t||s||n)return Be("number"==typeof t),Be(Number.isInteger(t)),a||!e[1].hasOwnProperty(t)?t:e[2]?e[2]+e[1][t]:e[1][t]}else Be(n)}message(e,t,i,n){return void 0===t?n.emitDefaultValues?null:void 0:e.internalJsonWrite(t,n)}scalar(e,t,i,n,s){if(void 0===t)return void Be(n);const a=s||n;switch(e){case se.INT32:case se.SFIXED32:case se.SINT32:return 0===t?a?0:void 0:(Re(t),t);case se.FIXED32:case se.UINT32:return 0===t?a?0:void 0:(Pe(t),t);case se.FLOAT:Le(t);case se.DOUBLE:return 0===t?a?0:void 0:(Be("number"==typeof t),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t);case se.STRING:return""===t?a?"":void 0:(Be("string"==typeof t),t);case se.BOOL:return!1===t?!a&&void 0:(Be("boolean"==typeof t),t);case se.UINT64:case se.FIXED64:Be("number"==typeof t||"string"==typeof t||"bigint"==typeof t);let e=Ee.from(t);if(e.isZero()&&!a)return;return e.toString();case se.INT64:case se.SFIXED64:case se.SINT64:Be("number"==typeof t||"string"==typeof t||"bigint"==typeof t);let i=Ne.from(t);if(i.isZero()&&!a)return;return i.toString();case se.BYTES:return Be(t instanceof Uint8Array),t.byteLength?function(e){let t,i="",n=0,s=0;for(let a=0;a<e.length;a++)switch(t=e[a],n){case 0:i+=de[t>>2],s=(3&t)<<4,n=1;break;case 1:i+=de[s|t>>4],s=(15&t)<<2,n=2;break;case 2:i+=de[s|t>>6],i+=de[63&t],n=0}return n&&(i+=de[s],i+="=",1==n&&(i+="=")),i}(t):a?"":void 0}}}function Me(e,t=ae.STRING){switch(e){case se.BOOL:return!1;case se.UINT64:case se.FIXED64:return Oe(Ee.ZERO,t);case se.INT64:case se.SFIXED64:case se.SINT64:return Oe(Ne.ZERO,t);case se.DOUBLE:case se.FLOAT:return 0;case se.BYTES:return new Uint8Array(0);case se.STRING:return"";default:return 0}}class De{constructor(e){this.info=e}prepare(){var e;if(!this.fieldNoToField){const t=null!==(e=this.info.fields)&&void 0!==e?e:[];this.fieldNoToField=new Map(t.map((e=>[e.no,e])))}}read(e,t,i,n){this.prepare();const s=void 0===n?e.len:e.pos+n;for(;e.pos<s;){const[n,s]=e.tag(),a=this.fieldNoToField.get(n);if(!a){let a=i.readUnknownField;if("throw"==a)throw new Error(`Unknown field ${n} (wire type ${s}) for ${this.info.typeName}`);let r=e.skip(s);!1!==a&&(!0===a?Q.onRead:a)(this.info.typeName,t,n,s,r);continue}let r=t,o=a.repeat,l=a.localName;switch(a.oneof&&(r=r[a.oneof],r.oneofKind!==l&&(r=t[a.oneof]={oneofKind:l})),a.kind){case"scalar":case"enum":let t="enum"==a.kind?se.INT32:a.T,n="scalar"==a.kind?a.L:void 0;if(o){let i=r[l];if(s==ee.LengthDelimited&&t!=se.STRING&&t!=se.BYTES){let s=e.uint32()+e.pos;for(;e.pos<s;)i.push(this.scalar(e,t,n))}else i.push(this.scalar(e,t,n))}else r[l]=this.scalar(e,t,n);break;case"message":if(o){let t=r[l],n=a.T().internalBinaryRead(e,e.uint32(),i);t.push(n)}else r[l]=a.T().internalBinaryRead(e,e.uint32(),i,r[l]);break;case"map":let[h,c]=this.mapEntry(a,e,i);r[l][h]=c}}}mapEntry(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[a,r]=t.tag();switch(a){case 1:n=e.K==se.BOOL?t.bool().toString():this.scalar(t,e.K,ae.STRING);break;case 2:switch(e.V.kind){case"scalar":s=this.scalar(t,e.V.T,e.V.L);break;case"enum":s=t.int32();break;case"message":s=e.V.T().internalBinaryRead(t,t.uint32(),i)}break;default:throw new Error(`Unknown field ${a} (wire type ${r}) in map entry for ${this.info.typeName}#${e.name}`)}}if(void 0===n){let t=Me(e.K);n=e.K==se.BOOL?t.toString():t}if(void 0===s)switch(e.V.kind){case"scalar":s=Me(e.V.T,e.V.L);break;case"enum":s=0;break;case"message":s=e.V.T().create()}return[n,s]}scalar(e,t,i){switch(t){case se.INT32:return e.int32();case se.STRING:return e.string();case se.BOOL:return e.bool();case se.DOUBLE:return e.double();case se.FLOAT:return e.float();case se.INT64:return Oe(e.int64(),i);case se.UINT64:return Oe(e.uint64(),i);case se.FIXED64:return Oe(e.fixed64(),i);case se.FIXED32:return e.fixed32();case se.BYTES:return e.bytes();case se.UINT32:return e.uint32();case se.SFIXED32:return e.sfixed32();case se.SFIXED64:return Oe(e.sfixed64(),i);case se.SINT32:return e.sint32();case se.SINT64:return Oe(e.sint64(),i)}}}class Ue{constructor(e){this.info=e}prepare(){if(!this.fields){const e=this.info.fields?this.info.fields.concat():[];this.fields=e.sort(((e,t)=>e.no-t.no))}}write(e,t,i){this.prepare();for(const n of this.fields){let s,a,r=n.repeat,o=n.localName;if(n.oneof){const t=e[n.oneof];if(t.oneofKind!==o)continue;s=t[o],a=!0}else s=e[o],a=!1;switch(n.kind){case"scalar":case"enum":let e="enum"==n.kind?se.INT32:n.T;if(r)if(Be(Array.isArray(s)),r==re.PACKED)this.packed(t,e,n.no,s);else for(const i of s)this.scalar(t,e,n.no,i,!0);else void 0===s?Be(n.opt):this.scalar(t,e,n.no,s,a||n.opt);break;case"message":if(r){Be(Array.isArray(s));for(const e of s)this.message(t,i,n.T(),n.no,e)}else this.message(t,i,n.T(),n.no,s);break;case"map":Be("object"==typeof s&&null!==s);for(const[e,a]of Object.entries(s))this.mapEntry(t,i,n,e,a)}}let n=i.writeUnknownFields;!1!==n&&(!0===n?Q.onWrite:n)(this.info.typeName,e,t)}mapEntry(e,t,i,n,s){e.tag(i.no,ee.LengthDelimited),e.fork();let a=n;switch(i.K){case se.INT32:case se.FIXED32:case se.UINT32:case se.SFIXED32:case se.SINT32:a=Number.parseInt(n);break;case se.BOOL:Be("true"==n||"false"==n),a="true"==n}switch(this.scalar(e,i.K,1,a,!0),i.V.kind){case"scalar":this.scalar(e,i.V.T,2,s,!0);break;case"enum":this.scalar(e,se.INT32,2,s,!0);break;case"message":this.message(e,t,i.V.T(),2,s)}e.join()}message(e,t,i,n,s){void 0!==s&&(i.internalBinaryWrite(s,e.tag(n,ee.LengthDelimited).fork(),t),e.join())}scalar(e,t,i,n,s){let[a,r,o]=this.scalarInfo(t,n);o&&!s||(e.tag(i,a),e[r](n))}packed(e,t,i,n){if(!n.length)return;Be(t!==se.BYTES&&t!==se.STRING),e.tag(i,ee.LengthDelimited),e.fork();let[,s]=this.scalarInfo(t);for(let t=0;t<n.length;t++)e[s](n[t]);e.join()}scalarInfo(e,t){let i,n=ee.Varint,s=void 0===t,a=0===t;switch(e){case se.INT32:i="int32";break;case se.STRING:a=s||!t.length,n=ee.LengthDelimited,i="string";break;case se.BOOL:a=!1===t,i="bool";break;case se.UINT32:i="uint32";break;case se.DOUBLE:n=ee.Bit64,i="double";break;case se.FLOAT:n=ee.Bit32,i="float";break;case se.INT64:a=s||Ne.from(t).isZero(),i="int64";break;case se.UINT64:a=s||Ee.from(t).isZero(),i="uint64";break;case se.FIXED64:a=s||Ee.from(t).isZero(),n=ee.Bit64,i="fixed64";break;case se.BYTES:a=s||!t.byteLength,n=ee.LengthDelimited,i="bytes";break;case se.FIXED32:n=ee.Bit32,i="fixed32";break;case se.SFIXED32:n=ee.Bit32,i="sfixed32";break;case se.SFIXED64:a=s||Ne.from(t).isZero(),n=ee.Bit64,i="sfixed64";break;case se.SINT32:i="sint32";break;case se.SINT64:a=s||Ne.from(t).isZero(),i="sint64"}return[n,i,s||a]}}const Ce={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0},je={ignoreUnknownFields:!1},Ve=Object.values;function $e(e,t,i){if(t===i)return!0;if(e!==se.BYTES)return!1;let n=t,s=i;if(n.length!==s.length)return!1;for(let e=0;e<n.length;e++)if(n[e]!=s[e])return!1;return!0}function Fe(e,t,i){if(t.length!==i.length)return!1;for(let n=0;n<t.length;n++)if(!$e(e,t[n],i[n]))return!1;return!0}function Ge(e,t,i){if(t.length!==i.length)return!1;for(let n=0;n<t.length;n++)if(!e.equals(t[n],i[n]))return!1;return!0}const Ke={writeUnknownFields:!0,writerFactory:()=>new We};class We{constructor(e){this.stack=[],this.textEncoder=null!=e?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let t=0;t<this.chunks.length;t++)e+=this.chunks[t].length;let t=new Uint8Array(e),i=0;for(let e=0;e<this.chunks.length;e++)t.set(this.chunks[e],i),i+=this.chunks[e].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(Pe(e);e>127;)this.buf.push(127&e|128),e>>>=7;return this.buf.push(e),this}int32(e){return Re(e),we(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){Le(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){Pe(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){Re(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return Re(e),we(e=(e<<1^e>>31)>>>0,this.buf),this}sfixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),n=Ne.from(e);return i.setInt32(0,n.lo,!0),i.setInt32(4,n.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),n=Ee.from(e);return i.setInt32(0,n.lo,!0),i.setInt32(4,n.hi,!0),this.raw(t)}int64(e){let t=Ne.from(e);return pe(t.lo,t.hi,this.buf),this}sint64(e){let t=Ne.from(e),i=t.hi>>31;return pe(t.lo<<1^i,(t.hi<<1|t.lo>>>31)^i,this.buf),this}uint64(e){let t=Ee.from(e);return pe(t.lo,t.hi,this.buf),this}}const He={readUnknownField:!0,readerFactory:e=>new Ye(e)};class Ye{constructor(e,t){this.varint64=ge,this.uint32=be,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=null!=t?t:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0})}tag(){let e=this.uint32(),t=e>>>3,i=7&e;if(t<=0||i<0||i>5)throw new Error("illegal tag: field no "+t+" wire type "+i);return[t,i]}skip(e){let t=this.pos;switch(e){case ee.Varint:for(;128&this.buf[this.pos++];);break;case ee.Bit64:this.pos+=4;case ee.Bit32:this.pos+=4;break;case ee.LengthDelimited:let t=this.uint32();this.pos+=t;break;case ee.StartGroup:let i;for(;(i=this.tag()[1])!==ee.EndGroup;)this.skip(i);break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(t,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}int64(){return new Ne(...this.varint64())}uint64(){return new Ee(...this.varint64())}sint64(){let[e,t]=this.varint64(),i=-(1&e);return e=(e>>>1|(1&t)<<31)^i,t=t>>>1^i,new Ne(e,t)}bool(){let[e,t]=this.varint64();return 0!==e||0!==t}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return new Ee(this.sfixed32(),this.sfixed32())}sfixed64(){return new Ne(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}const qe=Object.getOwnPropertyDescriptors(Object.getPrototypeOf({})),Je=qe[ie]={};class Xe{constructor(e,t,i){this.defaultCheckDepth=16,this.typeName=e,this.fields=t.map(oe),this.options=null!=i?i:{},Je.value=this,this.messagePrototype=Object.create(null,qe),this.refTypeCheck=new he(this),this.refJsonReader=new xe(this),this.refJsonWriter=new Ae(this),this.refBinReader=new De(this),this.refBinWriter=new Ue(this)}create(e){let t=function(e){const t=e.messagePrototype?Object.create(e.messagePrototype):Object.defineProperty({},ie,{value:e});for(let i of e.fields){let e=i.localName;if(!i.opt)if(i.oneof)t[i.oneof]={oneofKind:void 0};else if(i.repeat)t[e]=[];else switch(i.kind){case"scalar":t[e]=Me(i.T,i.L);break;case"enum":t[e]=0;break;case"map":t[e]={}}}return t}(this);return void 0!==e&&te(this,t,e),t}clone(e){let t=this.create();return te(this,t,e),t}equals(e,t){return function(e,t,i){if(t===i)return!0;if(!t||!i)return!1;for(let n of e.fields){let e=n.localName,s=n.oneof?t[n.oneof][e]:t[e],a=n.oneof?i[n.oneof][e]:i[e];switch(n.kind){case"enum":case"scalar":let e="enum"==n.kind?se.INT32:n.T;if(!(n.repeat?Fe(e,s,a):$e(e,s,a)))return!1;break;case"map":if(!("message"==n.V.kind?Ge(n.V.T(),Ve(s),Ve(a)):Fe("enum"==n.V.kind?se.INT32:n.V.T,Ve(s),Ve(a))))return!1;break;case"message":let t=n.T();if(!(n.repeat?Ge(t,s,a):t.equals(s,a)))return!1}}return!0}(this,e,t)}is(e,t=this.defaultCheckDepth){return this.refTypeCheck.is(e,t,!1)}isAssignable(e,t=this.defaultCheckDepth){return this.refTypeCheck.is(e,t,!0)}mergePartial(e,t){te(this,e,t)}fromBinary(e,t){let i=function(e){return e?Object.assign(Object.assign({},He),e):He}(t);return this.internalBinaryRead(i.readerFactory(e),e.byteLength,i)}fromJson(e,t){return this.internalJsonRead(e,function(e){return e?Object.assign(Object.assign({},je),e):je}(t))}fromJsonString(e,t){let i=JSON.parse(e);return this.fromJson(i,t)}toJson(e,t){return this.internalJsonWrite(e,function(e){return e?Object.assign(Object.assign({},Ce),e):Ce}(t))}toJsonString(e,t){var i;let n=this.toJson(e,t);return JSON.stringify(n,null,null!==(i=null==t?void 0:t.prettySpaces)&&void 0!==i?i:0)}toBinary(e,t){let i=function(e){return e?Object.assign(Object.assign({},Ke),e):Ke}(t);return this.internalBinaryWrite(e,i.writerFactory(),i).finish()}internalJsonRead(e,t,i){if(null!==e&&"object"==typeof e&&!Array.isArray(e)){let n=null!=i?i:this.create();return this.refJsonReader.read(e,n,t),n}throw new Error(`Unable to parse message ${this.typeName} from JSON ${ce(e)}.`)}internalJsonWrite(e,t){return this.refJsonWriter.write(e,t)}internalBinaryWrite(e,t,i){return this.refBinWriter.write(e,t,i),t}internalBinaryRead(e,t,i,n){let s=null!=n?n:this.create();return this.refBinReader.read(e,s,i,t),s}}var Ze;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.INPUT=2]="INPUT",e[e.GAME_STATE=5]="GAME_STATE",e[e.GAME_STATE_DELTA=11]="GAME_STATE_DELTA",e[e.PLAYER_JOIN=6]="PLAYER_JOIN",e[e.PLAYER_LEAVE=7]="PLAYER_LEAVE",e[e.PLAYER_RESPAWN=8]="PLAYER_RESPAWN",e[e.ERROR=10]="ERROR"}(Ze||(Ze={}));const ze=new class extends Xe{constructor(){super("protocol.Vector2",[{no:1,name:"x",kind:"scalar",T:1},{no:2,name:"y",kind:"scalar",T:1}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.x=0,t.y=0,void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.x=e.double();break;case 2:s.y=e.double();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){0!==e.x&&t.tag(1,ee.Bit64).double(e.x),0!==e.y&&t.tag(2,ee.Bit64).double(e.y);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},Qe=new class extends Xe{constructor(){super("protocol.InventoryItem",[{no:1,name:"type",kind:"scalar",T:5},{no:2,name:"quantity",kind:"scalar",T:5}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.type=0,t.quantity=0,void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.type=e.int32();break;case 2:s.quantity=e.int32();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){0!==e.type&&t.tag(1,ee.Varint).int32(e.type),0!==e.quantity&&t.tag(2,ee.Varint).int32(e.quantity);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},et=new class extends Xe{constructor(){super("protocol.Player",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"position",kind:"message",T:()=>ze},{no:4,name:"velocity",kind:"message",T:()=>ze},{no:5,name:"lives",kind:"scalar",T:2},{no:13,name:"invulnerable_timer",kind:"scalar",T:1},{no:6,name:"score",kind:"scalar",T:5},{no:7,name:"money",kind:"scalar",T:5},{no:8,name:"kills",kind:"scalar",T:5},{no:9,name:"rotation",kind:"scalar",T:1},{no:10,name:"bullets_left_by_weapon_type",kind:"map",K:9,V:{kind:"scalar",T:5}},{no:11,name:"night_vision_timer",kind:"scalar",T:1},{no:12,name:"is_alive",kind:"scalar",T:8},{no:14,name:"inventory",kind:"message",repeat:2,T:()=>Qe},{no:15,name:"selected_gun_type",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.username="",t.lives=0,t.invulnerableTimer=0,t.score=0,t.money=0,t.kills=0,t.rotation=0,t.bulletsLeftByWeaponType={},t.nightVisionTimer=0,t.isAlive=!1,t.inventory=[],t.selectedGunType="",void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.username=e.string();break;case 3:s.position=ze.internalBinaryRead(e,e.uint32(),i,s.position);break;case 4:s.velocity=ze.internalBinaryRead(e,e.uint32(),i,s.velocity);break;case 5:s.lives=e.float();break;case 13:s.invulnerableTimer=e.double();break;case 6:s.score=e.int32();break;case 7:s.money=e.int32();break;case 8:s.kills=e.int32();break;case 9:s.rotation=e.double();break;case 10:this.binaryReadMap10(s.bulletsLeftByWeaponType,e,i);break;case 11:s.nightVisionTimer=e.double();break;case 12:s.isAlive=e.bool();break;case 14:s.inventory.push(Qe.internalBinaryRead(e,e.uint32(),i));break;case 15:s.selectedGunType=e.string();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}binaryReadMap10(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,i]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=t.int32();break;default:throw new globalThis.Error("unknown map entry field for protocol.Player.bullets_left_by_weapon_type")}}e[n??""]=s??0}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ee.LengthDelimited).string(e.id),""!==e.username&&t.tag(2,ee.LengthDelimited).string(e.username),e.position&&ze.internalBinaryWrite(e.position,t.tag(3,ee.LengthDelimited).fork(),i).join(),e.velocity&&ze.internalBinaryWrite(e.velocity,t.tag(4,ee.LengthDelimited).fork(),i).join(),0!==e.lives&&t.tag(5,ee.Bit32).float(e.lives),0!==e.score&&t.tag(6,ee.Varint).int32(e.score),0!==e.money&&t.tag(7,ee.Varint).int32(e.money),0!==e.kills&&t.tag(8,ee.Varint).int32(e.kills),0!==e.rotation&&t.tag(9,ee.Bit64).double(e.rotation);for(let i of globalThis.Object.keys(e.bulletsLeftByWeaponType))t.tag(10,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(i).tag(2,ee.Varint).int32(e.bulletsLeftByWeaponType[i]).join();0!==e.nightVisionTimer&&t.tag(11,ee.Bit64).double(e.nightVisionTimer),!1!==e.isAlive&&t.tag(12,ee.Varint).bool(e.isAlive),0!==e.invulnerableTimer&&t.tag(13,ee.Bit64).double(e.invulnerableTimer);for(let n=0;n<e.inventory.length;n++)Qe.internalBinaryWrite(e.inventory[n],t.tag(14,ee.LengthDelimited).fork(),i).join();""!==e.selectedGunType&&t.tag(15,ee.LengthDelimited).string(e.selectedGunType);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},tt=new class extends Xe{constructor(){super("protocol.Bullet",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ze},{no:3,name:"velocity",kind:"message",T:()=>ze},{no:4,name:"owner_id",kind:"scalar",T:9},{no:5,name:"damage",kind:"scalar",T:2},{no:6,name:"is_enemy",kind:"scalar",T:8},{no:7,name:"is_active",kind:"scalar",T:8},{no:10,name:"deleted_at",kind:"scalar",T:3,L:0},{no:9,name:"inactive_ms",kind:"scalar",T:3,L:0},{no:8,name:"weapon_type",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.ownerId="",t.damage=0,t.isEnemy=!1,t.isActive=!1,t.deletedAt=0n,t.inactiveMs=0n,t.weaponType="",void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ze.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:s.velocity=ze.internalBinaryRead(e,e.uint32(),i,s.velocity);break;case 4:s.ownerId=e.string();break;case 5:s.damage=e.float();break;case 6:s.isEnemy=e.bool();break;case 7:s.isActive=e.bool();break;case 10:s.deletedAt=e.int64().toBigInt();break;case 9:s.inactiveMs=e.int64().toBigInt();break;case 8:s.weaponType=e.string();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ee.LengthDelimited).string(e.id),e.position&&ze.internalBinaryWrite(e.position,t.tag(2,ee.LengthDelimited).fork(),i).join(),e.velocity&&ze.internalBinaryWrite(e.velocity,t.tag(3,ee.LengthDelimited).fork(),i).join(),""!==e.ownerId&&t.tag(4,ee.LengthDelimited).string(e.ownerId),0!==e.damage&&t.tag(5,ee.Bit32).float(e.damage),!1!==e.isEnemy&&t.tag(6,ee.Varint).bool(e.isEnemy),!1!==e.isActive&&t.tag(7,ee.Varint).bool(e.isActive),""!==e.weaponType&&t.tag(8,ee.LengthDelimited).string(e.weaponType),0n!==e.inactiveMs&&t.tag(9,ee.Varint).int64(e.inactiveMs),0n!==e.deletedAt&&t.tag(10,ee.Varint).int64(e.deletedAt);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},it=new class extends Xe{constructor(){super("protocol.Wall",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ze},{no:3,name:"width",kind:"scalar",T:1},{no:4,name:"height",kind:"scalar",T:1},{no:5,name:"orientation",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.width=0,t.height=0,t.orientation="",void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ze.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:s.width=e.double();break;case 4:s.height=e.double();break;case 5:s.orientation=e.string();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ee.LengthDelimited).string(e.id),e.position&&ze.internalBinaryWrite(e.position,t.tag(2,ee.LengthDelimited).fork(),i).join(),0!==e.width&&t.tag(3,ee.Bit64).double(e.width),0!==e.height&&t.tag(4,ee.Bit64).double(e.height),""!==e.orientation&&t.tag(5,ee.LengthDelimited).string(e.orientation);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},nt=new class extends Xe{constructor(){super("protocol.Enemy",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ze},{no:3,name:"rotation",kind:"scalar",T:1},{no:4,name:"lives",kind:"scalar",T:2},{no:5,name:"wall_id",kind:"scalar",T:9},{no:6,name:"is_dead",kind:"scalar",T:8}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.rotation=0,t.lives=0,t.wallId="",t.isDead=!1,void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ze.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:s.rotation=e.double();break;case 4:s.lives=e.float();break;case 5:s.wallId=e.string();break;case 6:s.isDead=e.bool();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ee.LengthDelimited).string(e.id),e.position&&ze.internalBinaryWrite(e.position,t.tag(2,ee.LengthDelimited).fork(),i).join(),0!==e.rotation&&t.tag(3,ee.Bit64).double(e.rotation),0!==e.lives&&t.tag(4,ee.Bit32).float(e.lives),""!==e.wallId&&t.tag(5,ee.LengthDelimited).string(e.wallId),!1!==e.isDead&&t.tag(6,ee.Varint).bool(e.isDead);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},st=new class extends Xe{constructor(){super("protocol.Bonus",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ze},{no:3,name:"type",kind:"scalar",T:9},{no:4,name:"picked_up_by",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.type="",t.pickedUpBy="",void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ze.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:s.type=e.string();break;case 4:s.pickedUpBy=e.string();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ee.LengthDelimited).string(e.id),e.position&&ze.internalBinaryWrite(e.position,t.tag(2,ee.LengthDelimited).fork(),i).join(),""!==e.type&&t.tag(3,ee.LengthDelimited).string(e.type),""!==e.pickedUpBy&&t.tag(4,ee.LengthDelimited).string(e.pickedUpBy);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},at=new class extends Xe{constructor(){super("protocol.ShopItem",[{no:1,name:"quantity",kind:"scalar",T:5},{no:2,name:"pack_size",kind:"scalar",T:5},{no:3,name:"price",kind:"scalar",T:5}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.quantity=0,t.packSize=0,t.price=0,void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.quantity=e.int32();break;case 2:s.packSize=e.int32();break;case 3:s.price=e.int32();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){0!==e.quantity&&t.tag(1,ee.Varint).int32(e.quantity),0!==e.packSize&&t.tag(2,ee.Varint).int32(e.packSize),0!==e.price&&t.tag(3,ee.Varint).int32(e.price);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},rt=new class extends Xe{constructor(){super("protocol.Shop",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ze},{no:3,name:"inventory",kind:"map",K:5,V:{kind:"message",T:()=>at}},{no:4,name:"name",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.inventory={},t.name="",void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ze.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:this.binaryReadMap3(s.inventory,e,i);break;case 4:s.name=e.string();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}binaryReadMap3(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.int32();break;case 2:s=at.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.Shop.inventory")}}e[n??0]=s??at.create()}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ee.LengthDelimited).string(e.id),e.position&&ze.internalBinaryWrite(e.position,t.tag(2,ee.LengthDelimited).fork(),i).join();for(let n of globalThis.Object.keys(e.inventory))t.tag(3,ee.LengthDelimited).fork().tag(1,ee.Varint).int32(parseInt(n)),t.tag(2,ee.LengthDelimited).fork(),at.internalBinaryWrite(e.inventory[n],t,i),t.join().join();""!==e.name&&t.tag(4,ee.LengthDelimited).string(e.name);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},ot=new class extends Xe{constructor(){super("protocol.InputMessage",[{no:1,name:"forward",kind:"scalar",T:8},{no:2,name:"backward",kind:"scalar",T:8},{no:3,name:"left",kind:"scalar",T:8},{no:4,name:"right",kind:"scalar",T:8},{no:5,name:"shoot",kind:"scalar",T:8},{no:6,name:"item_key",kind:"map",K:5,V:{kind:"scalar",T:8}},{no:7,name:"purchase_item_key",kind:"map",K:5,V:{kind:"scalar",T:8}}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.forward=!1,t.backward=!1,t.left=!1,t.right=!1,t.shoot=!1,t.itemKey={},t.purchaseItemKey={},void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.forward=e.bool();break;case 2:s.backward=e.bool();break;case 3:s.left=e.bool();break;case 4:s.right=e.bool();break;case 5:s.shoot=e.bool();break;case 6:this.binaryReadMap6(s.itemKey,e,i);break;case 7:this.binaryReadMap7(s.purchaseItemKey,e,i);break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}binaryReadMap6(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,i]=t.tag();switch(e){case 1:n=t.int32();break;case 2:s=t.bool();break;default:throw new globalThis.Error("unknown map entry field for protocol.InputMessage.item_key")}}e[n??0]=s??!1}binaryReadMap7(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,i]=t.tag();switch(e){case 1:n=t.int32();break;case 2:s=t.bool();break;default:throw new globalThis.Error("unknown map entry field for protocol.InputMessage.purchase_item_key")}}e[n??0]=s??!1}internalBinaryWrite(e,t,i){!1!==e.forward&&t.tag(1,ee.Varint).bool(e.forward),!1!==e.backward&&t.tag(2,ee.Varint).bool(e.backward),!1!==e.left&&t.tag(3,ee.Varint).bool(e.left),!1!==e.right&&t.tag(4,ee.Varint).bool(e.right),!1!==e.shoot&&t.tag(5,ee.Varint).bool(e.shoot);for(let i of globalThis.Object.keys(e.itemKey))t.tag(6,ee.LengthDelimited).fork().tag(1,ee.Varint).int32(parseInt(i)).tag(2,ee.Varint).bool(e.itemKey[i]).join();for(let i of globalThis.Object.keys(e.purchaseItemKey))t.tag(7,ee.LengthDelimited).fork().tag(1,ee.Varint).int32(parseInt(i)).tag(2,ee.Varint).bool(e.purchaseItemKey[i]).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},lt=new class extends Xe{constructor(){super("protocol.GameStateMessage",[{no:1,name:"players",kind:"map",K:9,V:{kind:"message",T:()=>et}},{no:2,name:"bullets",kind:"map",K:9,V:{kind:"message",T:()=>tt}},{no:3,name:"walls",kind:"map",K:9,V:{kind:"message",T:()=>it}},{no:4,name:"enemies",kind:"map",K:9,V:{kind:"message",T:()=>nt}},{no:5,name:"bonuses",kind:"map",K:9,V:{kind:"message",T:()=>st}},{no:7,name:"shops",kind:"map",K:9,V:{kind:"message",T:()=>rt}},{no:8,name:"players_shops",kind:"scalar",repeat:2,T:9},{no:6,name:"timestamp",kind:"scalar",T:3,L:0}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.players={},t.bullets={},t.walls={},t.enemies={},t.bonuses={},t.shops={},t.playersShops=[],t.timestamp=0n,void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:this.binaryReadMap1(s.players,e,i);break;case 2:this.binaryReadMap2(s.bullets,e,i);break;case 3:this.binaryReadMap3(s.walls,e,i);break;case 4:this.binaryReadMap4(s.enemies,e,i);break;case 5:this.binaryReadMap5(s.bonuses,e,i);break;case 7:this.binaryReadMap7(s.shops,e,i);break;case 8:s.playersShops.push(e.string());break;case 6:s.timestamp=e.int64().toBigInt();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}binaryReadMap1(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=et.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateMessage.players")}}e[n??""]=s??et.create()}binaryReadMap2(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=tt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateMessage.bullets")}}e[n??""]=s??tt.create()}binaryReadMap3(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=it.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateMessage.walls")}}e[n??""]=s??it.create()}binaryReadMap4(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=nt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateMessage.enemies")}}e[n??""]=s??nt.create()}binaryReadMap5(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=st.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateMessage.bonuses")}}e[n??""]=s??st.create()}binaryReadMap7(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=rt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateMessage.shops")}}e[n??""]=s??rt.create()}internalBinaryWrite(e,t,i){for(let n of globalThis.Object.keys(e.players))t.tag(1,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),et.internalBinaryWrite(e.players[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.bullets))t.tag(2,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),tt.internalBinaryWrite(e.bullets[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.walls))t.tag(3,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),it.internalBinaryWrite(e.walls[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.enemies))t.tag(4,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),nt.internalBinaryWrite(e.enemies[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.bonuses))t.tag(5,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),st.internalBinaryWrite(e.bonuses[n],t,i),t.join().join();0n!==e.timestamp&&t.tag(6,ee.Varint).int64(e.timestamp);for(let n of globalThis.Object.keys(e.shops))t.tag(7,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),rt.internalBinaryWrite(e.shops[n],t,i),t.join().join();for(let i=0;i<e.playersShops.length;i++)t.tag(8,ee.LengthDelimited).string(e.playersShops[i]);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},ht=new class extends Xe{constructor(){super("protocol.GameStateDeltaMessage",[{no:1,name:"updated_players",kind:"map",K:9,V:{kind:"message",T:()=>et}},{no:2,name:"removed_players",kind:"scalar",repeat:2,T:9},{no:3,name:"updated_bullets",kind:"map",K:9,V:{kind:"message",T:()=>tt}},{no:4,name:"removed_bullets",kind:"map",K:9,V:{kind:"message",T:()=>tt}},{no:5,name:"updated_walls",kind:"map",K:9,V:{kind:"message",T:()=>it}},{no:6,name:"removed_walls",kind:"scalar",repeat:2,T:9},{no:7,name:"updated_enemies",kind:"map",K:9,V:{kind:"message",T:()=>nt}},{no:8,name:"removed_enemies",kind:"scalar",repeat:2,T:9},{no:9,name:"updated_bonuses",kind:"map",K:9,V:{kind:"message",T:()=>st}},{no:10,name:"removed_bonuses",kind:"scalar",repeat:2,T:9},{no:12,name:"updated_shops",kind:"map",K:9,V:{kind:"message",T:()=>rt}},{no:13,name:"removed_shops",kind:"scalar",repeat:2,T:9},{no:14,name:"players_shops",kind:"scalar",repeat:2,T:9},{no:11,name:"timestamp",kind:"scalar",T:3,L:0}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.updatedPlayers={},t.removedPlayers=[],t.updatedBullets={},t.removedBullets={},t.updatedWalls={},t.removedWalls=[],t.updatedEnemies={},t.removedEnemies=[],t.updatedBonuses={},t.removedBonuses=[],t.updatedShops={},t.removedShops=[],t.playersShops=[],t.timestamp=0n,void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:this.binaryReadMap1(s.updatedPlayers,e,i);break;case 2:s.removedPlayers.push(e.string());break;case 3:this.binaryReadMap3(s.updatedBullets,e,i);break;case 4:this.binaryReadMap4(s.removedBullets,e,i);break;case 5:this.binaryReadMap5(s.updatedWalls,e,i);break;case 6:s.removedWalls.push(e.string());break;case 7:this.binaryReadMap7(s.updatedEnemies,e,i);break;case 8:s.removedEnemies.push(e.string());break;case 9:this.binaryReadMap9(s.updatedBonuses,e,i);break;case 10:s.removedBonuses.push(e.string());break;case 12:this.binaryReadMap12(s.updatedShops,e,i);break;case 13:s.removedShops.push(e.string());break;case 14:s.playersShops.push(e.string());break;case 11:s.timestamp=e.int64().toBigInt();break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}binaryReadMap1(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=et.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_players")}}e[n??""]=s??et.create()}binaryReadMap3(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=tt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_bullets")}}e[n??""]=s??tt.create()}binaryReadMap4(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=tt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.removed_bullets")}}e[n??""]=s??tt.create()}binaryReadMap5(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=it.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_walls")}}e[n??""]=s??it.create()}binaryReadMap7(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=nt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_enemies")}}e[n??""]=s??nt.create()}binaryReadMap9(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=st.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_bonuses")}}e[n??""]=s??st.create()}binaryReadMap12(e,t,i){let n,s,a=t.uint32(),r=t.pos+a;for(;t.pos<r;){let[e,a]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=rt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_shops")}}e[n??""]=s??rt.create()}internalBinaryWrite(e,t,i){for(let n of globalThis.Object.keys(e.updatedPlayers))t.tag(1,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),et.internalBinaryWrite(e.updatedPlayers[n],t,i),t.join().join();for(let i=0;i<e.removedPlayers.length;i++)t.tag(2,ee.LengthDelimited).string(e.removedPlayers[i]);for(let n of globalThis.Object.keys(e.updatedBullets))t.tag(3,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),tt.internalBinaryWrite(e.updatedBullets[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.removedBullets))t.tag(4,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),tt.internalBinaryWrite(e.removedBullets[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.updatedWalls))t.tag(5,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),it.internalBinaryWrite(e.updatedWalls[n],t,i),t.join().join();for(let i=0;i<e.removedWalls.length;i++)t.tag(6,ee.LengthDelimited).string(e.removedWalls[i]);for(let n of globalThis.Object.keys(e.updatedEnemies))t.tag(7,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),nt.internalBinaryWrite(e.updatedEnemies[n],t,i),t.join().join();for(let i=0;i<e.removedEnemies.length;i++)t.tag(8,ee.LengthDelimited).string(e.removedEnemies[i]);for(let n of globalThis.Object.keys(e.updatedBonuses))t.tag(9,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),st.internalBinaryWrite(e.updatedBonuses[n],t,i),t.join().join();for(let i=0;i<e.removedBonuses.length;i++)t.tag(10,ee.LengthDelimited).string(e.removedBonuses[i]);0n!==e.timestamp&&t.tag(11,ee.Varint).int64(e.timestamp);for(let n of globalThis.Object.keys(e.updatedShops))t.tag(12,ee.LengthDelimited).fork().tag(1,ee.LengthDelimited).string(n),t.tag(2,ee.LengthDelimited).fork(),rt.internalBinaryWrite(e.updatedShops[n],t,i),t.join().join();for(let i=0;i<e.removedShops.length;i++)t.tag(13,ee.LengthDelimited).string(e.removedShops[i]);for(let i=0;i<e.playersShops.length;i++)t.tag(14,ee.LengthDelimited).string(e.playersShops[i]);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},ct=new class extends Xe{constructor(){super("protocol.PlayerJoinMessage",[{no:1,name:"player",kind:"message",T:()=>et}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();if(1===t)s.player=et.internalBinaryRead(e,e.uint32(),i,s.player);else{let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){e.player&&et.internalBinaryWrite(e.player,t.tag(1,ee.LengthDelimited).fork(),i).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},dt=new class extends Xe{constructor(){super("protocol.PlayerLeaveMessage",[{no:1,name:"player_id",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.playerId="",void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();if(1===t)s.playerId=e.string();else{let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){""!==e.playerId&&t.tag(1,ee.LengthDelimited).string(e.playerId);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},ut=new class extends Xe{constructor(){super("protocol.PlayerRespawnMessage",[])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();{let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},gt=new class extends Xe{constructor(){super("protocol.ErrorMessage",[{no:1,name:"message",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.message="",void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();if(1===t)s.message=e.string();else{let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){""!==e.message&&t.tag(1,ee.LengthDelimited).string(e.message);let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}},pt=new class extends Xe{constructor(){super("protocol.GameMessage",[{no:1,name:"type",kind:"enum",T:()=>["protocol.MessageType",Ze]},{no:3,name:"input",kind:"message",oneof:"payload",T:()=>ot},{no:5,name:"game_state",kind:"message",oneof:"payload",T:()=>lt},{no:11,name:"game_state_delta",kind:"message",oneof:"payload",T:()=>ht},{no:6,name:"player_join",kind:"message",oneof:"payload",T:()=>ct},{no:7,name:"player_leave",kind:"message",oneof:"payload",T:()=>dt},{no:8,name:"player_respawn",kind:"message",oneof:"payload",T:()=>ut},{no:10,name:"error",kind:"message",oneof:"payload",T:()=>gt}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.type=0,t.payload={oneofKind:void 0},void 0!==e&&te(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),a=e.pos+t;for(;e.pos<a;){let[t,n]=e.tag();switch(t){case 1:s.type=e.int32();break;case 3:s.payload={oneofKind:"input",input:ot.internalBinaryRead(e,e.uint32(),i,s.payload.input)};break;case 5:s.payload={oneofKind:"gameState",gameState:lt.internalBinaryRead(e,e.uint32(),i,s.payload.gameState)};break;case 11:s.payload={oneofKind:"gameStateDelta",gameStateDelta:ht.internalBinaryRead(e,e.uint32(),i,s.payload.gameStateDelta)};break;case 6:s.payload={oneofKind:"playerJoin",playerJoin:ct.internalBinaryRead(e,e.uint32(),i,s.payload.playerJoin)};break;case 7:s.payload={oneofKind:"playerLeave",playerLeave:dt.internalBinaryRead(e,e.uint32(),i,s.payload.playerLeave)};break;case 8:s.payload={oneofKind:"playerRespawn",playerRespawn:ut.internalBinaryRead(e,e.uint32(),i,s.payload.playerRespawn)};break;case 10:s.payload={oneofKind:"error",error:gt.internalBinaryRead(e,e.uint32(),i,s.payload.error)};break;default:let a=i.readUnknownField;if("throw"===a)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let r=e.skip(n);!1!==a&&(!0===a?Q.onRead:a)(this.typeName,s,t,n,r)}}return s}internalBinaryWrite(e,t,i){0!==e.type&&t.tag(1,ee.Varint).int32(e.type),"input"===e.payload.oneofKind&&ot.internalBinaryWrite(e.payload.input,t.tag(3,ee.LengthDelimited).fork(),i).join(),"gameState"===e.payload.oneofKind&&lt.internalBinaryWrite(e.payload.gameState,t.tag(5,ee.LengthDelimited).fork(),i).join(),"playerJoin"===e.payload.oneofKind&&ct.internalBinaryWrite(e.payload.playerJoin,t.tag(6,ee.LengthDelimited).fork(),i).join(),"playerLeave"===e.payload.oneofKind&&dt.internalBinaryWrite(e.payload.playerLeave,t.tag(7,ee.LengthDelimited).fork(),i).join(),"playerRespawn"===e.payload.oneofKind&&ut.internalBinaryWrite(e.payload.playerRespawn,t.tag(8,ee.LengthDelimited).fork(),i).join(),"error"===e.payload.oneofKind&&gt.internalBinaryWrite(e.payload.error,t.tag(10,ee.LengthDelimited).fork(),i).join(),"gameStateDelta"===e.payload.oneofKind&&ht.internalBinaryWrite(e.payload.gameStateDelta,t.tag(11,ee.LengthDelimited).fork(),i).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?Q.onWrite:n)(this.typeName,e,t),t}};class ft{static instance;socket=null;_gameStateHandler=null;_gameStateDeltaHandler=null;_playerJoinedHandler=null;_playerLeftHandler=null;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=1e3;sessionId=null;messageQueue=[];binaryMode=!0;constructor(){}static getInstance(){return ft.instance||(ft.instance=new ft),ft.instance}connect(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.close(),this.sessionId=e;const t=Z.getInstance().getToken(),i=`${n.startsWith("https")?"wss":"ws"}://${n.replace(/^https?:\/\//,"")}/ws?sessionId=${e}&token=${t}&protocol=${this.binaryMode?"binary":"json"}`;return this.socket=new WebSocket(i),this.binaryMode&&(this.socket.binaryType="arraybuffer"),this.setupEventListeners(),this.socket}disconnect(){this.socket&&(this.socket.close(),this.socket=null,this.sessionId=null,this.messageQueue=[])}getSocket(){return this.socket}emit(e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return console.warn("Attempting to emit without socket connection"),void this.messageQueue.push(e);this.socket.send(this.binaryMode?pt.toBinary(e):pt.toJsonString(e))}setupEventListeners(){this.socket&&(this.socket.onopen=()=>{for(console.log("Connected to WebSocket server"),this.reconnectAttempts=0;this.messageQueue.length>0;){const e=this.messageQueue.shift();e&&this.emit(e)}},this.socket.onclose=e=>{console.log("Disconnected from WebSocket server",e.code,e.reason),1e3!==e.code&&this.reconnectAttempts<this.maxReconnectAttempts&&this.sessionId&&(this.reconnectAttempts++,console.log(`Reconnecting... Attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`),setTimeout((()=>{this.sessionId&&this.connect(this.sessionId)}),this.reconnectDelay*this.reconnectAttempts))},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onmessage=e=>{try{const t=this.binaryMode?pt.fromBinary(new Uint8Array(e.data)):pt.fromJsonString(e.data);this.handleMessage(t)}catch(e){console.error("Failed to parse WebSocket message:",e)}})}handleMessage({payload:e}){switch(e.oneofKind){case"gameState":this._gameStateHandler?.(e.gameState);break;case"gameStateDelta":this._gameStateDeltaHandler?.(e.gameStateDelta);break;case"playerJoin":this._playerJoinedHandler?.(e.playerJoin);break;case"playerLeave":this._playerLeftHandler?.(e.playerLeave);break;default:console.warn("Unknown WebSocket event:",e.oneofKind)}}onGameState(e){this._gameStateHandler=e}onGameStateDelta(e){this._gameStateDeltaHandler=e}onPlayerJoined(e){this._playerJoinedHandler=e}onPlayerLeft(e){this._playerLeftHandler=e}}class yt{static instance;currentSession=null;socketService;constructor(){this.socketService=ft.getInstance()}static getInstance(){return yt.instance||(yt.instance=new yt),yt.instance}async listSessions(){return await z.get("/sessions")}async startSession(e){const t=await z.post("/sessions",{name:e});return this.currentSession=t,this.socketService.connect(t.id),t}async joinSession(e){const t=await z.post(`/sessions/${e}/join`);return this.currentSession=t,this.socketService.connect(t.id),t}async deleteSession(e){await z.delete(`/sessions/${e}`),this.currentSession?.id===e&&(this.currentSession=null,this.socketService.disconnect())}async endSession(){this.currentSession&&(this.socketService.disconnect(),this.currentSession=null)}async addSessionChunks(e){if(!this.currentSession)throw new Error("No active session");return this.currentSession}async updateSessionChunk(e){return this.addSessionChunks({chunks:[e]})}async fetchSessionChunks(){if(!this.currentSession)throw new Error("No active session");const e=await z.get(`/sessions/${this.currentSession.id}/chunks`);return this.currentSession=e,e}getCurrentSession(){return this.currentSession}notifyRespawn(){this.currentSession?this.socketService.emit({type:Ze.PLAYER_RESPAWN,payload:{oneofKind:"playerRespawn",playerRespawn:ut.create()}}):console.warn("Attempting to notify about respawn without active session")}notifyInput(e){this.socketService.emit({type:Ze.INPUT,payload:{oneofKind:"input",input:e}})}onGameState(e){this.socketService.onGameState(e)}onGameStateDelta(e){this.socketService.onGameStateDelta(e)}onPlayerJoined(e){this.socketService.onPlayerJoined(e)}onPlayerLeft(e){this.socketService.onPlayerLeft(e)}}class mt{_Player;_Enemy;_Wall;_Bonus;_OtherPlayer;_Shop;_BulletManager;_multiplayerMode;CHUNK_SIZE=2e3;_player=null;_otherPlayers={};_enemies=[];_walls=[];_bonuses=[];_shops=[];_gameOver=!1;floorTexture=null;inventoryItemTextures={};chunks=new Map;_cameraPoint=new i(0,0);_torchRadius=200;_debug=!1;_sessionManager=yt.getInstance();_bulletManager;_lastChangesetTimestamp=0;_bonusPickupCache=new Set;_previousInputState={forward:!1,backward:!1,left:!1,right:!1,shoot:!1,itemKey:{},purchaseItemKey:{}};_inputStateSubmitTimestamp=0;get debug(){return this._debug}toggleDebug(){this._debug=!this._debug}get gameOver(){return this._gameOver}get player(){return this._player}get otherPlayers(){return Object.values(this._otherPlayers)}getOtherPlayerById(e){return this._otherPlayers[e]||null}get walls(){return this._walls}get enemies(){return this._enemies}get bonuses(){return this._bonuses}get shops(){return this._shops}get cameraPoint(){return this._cameraPoint}get torchRadius(){return this._torchRadius}get multiplayerMode(){return this._multiplayerMode}constructor(e,t,i,n,s,a,r,o){this._Player=e,this._Enemy=t,this._Wall=i,this._Bonus=n,this._OtherPlayer=s,this._Shop=a,this._BulletManager=r,this._multiplayerMode=o;const l=Y.getInstance();l.loadSound(w.TORCH).then((()=>{l.playSound(w.TORCH,{volume:1,loop:!0})})),W(y.FLOOR).then((e=>{this.floorTexture=e})),Object.entries(R).forEach((([e,t])=>{W(t).then((t=>{this.inventoryItemTextures[Number(e)]=t}))})),this._bulletManager=new this._BulletManager(this)}addOtherPlayer(e){const t=new i(e.position.x,e.position.y),n=new this._OtherPlayer(this,t,e.rotation,e.id,e.username);this._otherPlayers[e.id]=n,n.applyFromGameState(e)}removeOtherPlayer(e){delete this._otherPlayers[e]}getChunkLeftTop(e){return new i(Math.floor(e.x/this.CHUNK_SIZE),Math.floor(e.y/this.CHUNK_SIZE))}update(e){if(!this.gameOver){this._player&&(this._player.update(e),this._cameraPoint=this._player.getPosition().clone());for(const t of Object.values(this._otherPlayers))t.update(e)}}endGame(){this._gameOver||(this._gameOver=!0,Y.getInstance().playSound(w.GAME_OVER,{when:1.5}))}drawFloor(e){if(this.floorTexture){const t=this.floorTexture.width/2,i=this.floorTexture.height/2,n=this.cameraPoint.x%t-t,s=this.cameraPoint.y%i-i;for(let o=-720/i-1;o<r/i+2;o++)for(let r=-1280/t-1;r<a/t+2;r++)e.drawImage(this.floorTexture,-n-r*t,-s-o*i,t,i)}if(this.debug){const t=this.getChunkLeftTop(this.cameraPoint);e.strokeStyle="yellow",e.lineWidth=1;for(let n=-1;n<=1;n++)for(let s=-1;s<=1;s++){const a=(t.x+s)*this.CHUNK_SIZE,r=(t.y+n)*this.CHUNK_SIZE,o=this.worldToScreenCoordinates(new i(a,r));e.strokeRect(o.x,o.y,this.CHUNK_SIZE,this.CHUNK_SIZE),e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(o.x+this.CHUNK_SIZE,o.y+this.CHUNK_SIZE),e.moveTo(o.x+this.CHUNK_SIZE,o.y),e.lineTo(o.x,o.y+this.CHUNK_SIZE),e.closePath(),e.stroke()}}}draw(e,t,i){e.clearRect(0,0,a,r),this.drawFloor(e),this._shops.forEach((t=>t.draw(e,i))),this._walls.forEach((t=>t.draw(e,i))),this._enemies.forEach((t=>t.draw(e,i))),this._bonuses.forEach((t=>t.draw(e,i))),Object.values(this._otherPlayers).forEach((t=>{t.draw(e,i)})),this._player&&this._player.draw(e,i),this._bulletManager.draw(e,i),this.drawDarknessOverlay(t),this.drawUI(i)}drawDarknessOverlay(e){if(!this._player||!this._player.isAlive())return e.fillStyle=l,void e.fillRect(0,0,a,r);if(this._player.hasNightVision())return e.fillStyle=this._player.isNightVisionFading()?"#006000a0":"#009600a0",void e.fillRect(0,0,a,r);const t=[this._player,...this.otherPlayers.filter((e=>e.isAlive()&&!e.hasNightVision()))],i=.97*this._torchRadius+Math.random()*this._torchRadius*.06;e.fillStyle=l,e.fillRect(0,0,a,r),e.globalCompositeOperation="destination-out",t.forEach((t=>{const n=this.worldToScreenCoordinates(t.getTorchPoint()),s=e.createRadialGradient(n.x,n.y,0,n.x,n.y,i);s.addColorStop(0,"#ffffffff"),s.addColorStop(1,"#ffffff00"),e.fillStyle=s,e.fillRect(0,0,a,r),e.fillRect(0,0,a,r)})),e.globalCompositeOperation="source-over"}worldToScreenCoordinates(e){return e.movedBy(640-this._cameraPoint.x,360-this._cameraPoint.y)}handleInput(e,t){if(!this._player)return;const i=e.has("KeyW")||e.has("ArrowUp"),n=e.has("KeyS")||e.has("ArrowDown"),s=e.has("KeyA")||e.has("ArrowLeft"),a=e.has("KeyD")||e.has("ArrowRight"),r=e.has("Space"),o=Date.now(),l={},h={};for(let t=0;t<=9;t++)if(e.has(`Digit${t}`)){const e=this.shops.find((e=>e.hasPlayer()&&e.isModalOpen));if(e){const i=e.inventory;h[Number(Object.keys(i).filter((e=>i[Number(e)].quantity>0))[0==t?9:t-1])??null]=!0}else l[t]=!0}if(this._previousInputState)for(const e of Object.keys(this._previousInputState.purchaseItemKey))h[Number(e)]||this.handleShoppingAttempt(Number(e));(i!==this._previousInputState.forward||n!==this._previousInputState.backward||s!==this._previousInputState.left||a!==this._previousInputState.right||r!==this._previousInputState.shoot||JSON.stringify(l)!==JSON.stringify(this._previousInputState.itemKey)||JSON.stringify(h)!==JSON.stringify(this._previousInputState.purchaseItemKey)||o-this._inputStateSubmitTimestamp>1e3)&&(this._sessionManager.notifyInput({forward:i,backward:n,left:s,right:a,shoot:r,itemKey:l,purchaseItemKey:h}),this._previousInputState={forward:i,backward:n,left:s,right:a,shoot:r,itemKey:l,purchaseItemKey:h},this._inputStateSubmitTimestamp=o)}handleShoppingAttempt(e){if(Object.values(x).includes(e)&&this._player?.hasInventoryItem(e))return void Y.getInstance().playSound(w.MISTAKE);const t=this.shops.find((e=>e.hasPlayer()&&e.isModalOpen));if(t&&t.inventory[e]){const i=t.inventory[e],n=i.price*i.packSize;this._player&&this._player.money<=n&&Y.getInstance().playSound(w.MISTAKE)}}restart(){this._sessionManager.notifyRespawn()}drawUI(e){if(this._player){if(e.textAlign="left",this.gameOver)e.fillStyle="white",e.font="48px Rubik Distressed",e.textAlign="center",e.fillText("Game Over",640,360),e.font=`24px ${o}`,e.fillStyle="yellow",e.fillText(`Your Posthumous Score: ${this._player.score.toFixed(0)}`,640,400),e.fillStyle="magenta",e.fillText("Press R to Restart",640,440);else{e.fillStyle="white",e.font=`22px ${o}`,e.fillText(`Lives: ${Array(Math.floor(this._player.lives)).fill("‚ù§Ô∏è").join(" ")}`,10,30),e.fillStyle="yellow",e.fillText(`Money: ${this._player.money.toFixed(0)}$`,10,60),e.fillStyle="cyan";const t=M[this._player.selectedGunType],i=this._player.bulletsLeft,n=0===i?"-":i<6?Array(i).fill(t).join(""):`${t} x ${i}`;e.fillText(`Bullets: ${n}`,10,90),this._player.hasNightVision()&&(e.fillStyle="#90ff90",e.fillText(`Night Vision: ${this._player.nightVisionTimer.toFixed(0)}`,10,120))}if(this._player.drawUI(e),this._shops.forEach((t=>t.drawUI(e))),this.debug){const t=this._enemies.length+this._walls.length+this._bonuses.length+this._shops.length+Object.values(this._otherPlayers).length+(this._player?1:0);e.fillStyle="white",e.font=`12px ${o}`,e.fillText(`Chunk: ${this.getChunkLeftTop(this.cameraPoint)}`,10,668),e.fillText(`Number of world objects: ${t}`,10,654),e.fillText(`Camera position: ${this.cameraPoint}`,10,640),e.fillText(`Number of chunks: ${this.chunks.size}`,10,626),e.fillText(`Host: ${this._sessionManager.getCurrentSession()?.host.username}`,10,612),e.fillText(`Session ID: ${this._sessionManager.getCurrentSession()?.id}`,10,598),e.fillText(`Session: ${this._sessionManager.getCurrentSession()?.name}`,10,584)}}}getInventoryTexture(e){return this.inventoryItemTextures[e]||null}applyGameState(e,t){this._player=this._Player.fromGameState(this,e.players[t]);for(const t of Object.values(e.players))t.id!==this._player.id&&(this._otherPlayers[t.id]||this.addOtherPlayer(t));for(const t of Object.values(e.walls))this._walls.find((e=>e.id===t.id))||this._walls.push(new this._Wall(this,new i(t.position.x,t.position.y),t.width,t.height,t.orientation,t.id));for(const t of Object.values(e.enemies)){const e=this._enemies.find((e=>e.id===t.id));e?e.applyFromGameState(t):this._enemies.push(new this._Enemy(this,this._walls.find((e=>e.id===t.wallId)),t))}for(const t of Object.values(e.bonuses))this._bonuses.find((e=>e.id===t.id))||this._bonuses.push(new this._Bonus(this,t));for(const t of Object.values(e.shops))this._shops.find((e=>e.id===t.id))||this._shops.push(new this._Shop(this,t));for(const t of e.playersShops){const e=this._shops.find((e=>e.id===t));e&&e.handlePlayerEnter()}}applyGameStateDelta(e){if(e.timestamp<=this._lastChangesetTimestamp)return void console.log(`Ignoring out-of-order changeset. Last: ${this._lastChangesetTimestamp}, Received: ${e.timestamp}`,e);this._lastChangesetTimestamp=Number(e.timestamp);const t=!!this._player&&0===this._player.bulletsLeft;for(const t of Object.values(e.updatedPlayers))if(t.id!==this._player?.id)this._otherPlayers[t.id]?this._otherPlayers[t.id].applyFromGameState(t):this.addOtherPlayer(t);else{if(t.isAlive&&!this._player.isAlive()){const e=Y.getInstance();e.playSound(w.SPAWN),e.stopSound(w.GAME_OVER),this._gameOver=!1}this._player.applyFromGameState(t)}for(const t of e.removedPlayers)this.removeOtherPlayer(t);for(const t of Object.values(e.updatedWalls))this._walls.find((e=>e.id===t.id))||this._walls.push(new this._Wall(this,new i(t.position.x,t.position.y),t.width,t.height,t.orientation,t.id));for(const t of e.removedWalls)this._walls=this._walls.filter((e=>e.id!==t));for(const t of Object.values(e.updatedEnemies)){let e=this._enemies.find((e=>e.id===t.id));if(e)e.applyFromGameState(t);else{const i=this._walls.find((e=>e.id===t.wallId));if(!i){console.log(`Error: Wall ${t.wallId} is undefined for Enemy ${t.id}`);continue}e=new this._Enemy(this,i,t),this._enemies.push(e)}}for(const t of e.removedEnemies)this._enemies=this._enemies.filter((e=>e.id!==t));for(const t of Object.values(e.updatedBonuses))t.pickedUpBy?(this._bonuses=this._bonuses.filter((e=>e.id!==t.id)),t.pickedUpBy!==this._player?.id||this._bonusPickupCache.has(t.id)||(Y.getInstance().playSound(w.BONUS_PICKUP),this._bonusPickupCache.add(t.id))):this._bonuses.find((e=>e.id===t.id))||this._bonuses.push(new this._Bonus(this,t));for(const i of Object.values(e.updatedBullets)){const e=this._bulletManager.getBulletById(i.id);e?e.getPosition().setTo(i.position.x,i.position.y):(i.ownerId!==this._player?.id||!t||0!==this._player.bulletsLeft||this._bulletManager.hasSoundPlayedForBullet(i)||L.includes(i.weaponType)||Y.getInstance().playSound(w.PLAYER_BULLET_RECHARGE,{volume:.5}),this._bulletManager.applyFromGameState(i))}for(const i of Object.values(e.removedBullets))this._bulletManager.getBulletById(i.id)||i.ownerId!==this._player?.id||!t||0!==this._player.bulletsLeft||this._bulletManager.hasSoundPlayedForBullet(i)||L.includes(i.weaponType)||Y.getInstance().playSound(w.PLAYER_BULLET_RECHARGE,{volume:.5}),this._bulletManager.applyFromGameState(i,!0);for(const t of Object.values(e.updatedShops)){const e=this._shops.find((e=>e.id===t.id));e?e.applyFromGameState(t):this._shops.push(new this._Shop(this,t))}for(const t of e.removedShops)this._shops=this._shops.filter((e=>e.id!==t));for(const t of Object.values(this._shops))e.playersShops.includes(t.id)?t.handlePlayerEnter():t.handlePlayerExit()}toggleInventory(){this._player?.toggleInventory()}openShopModal(){this._shops.forEach((e=>{e.hasPlayer()&&!e.isModalOpen&&e.openModal()}))}closeShopModal(){this._shops.forEach((e=>{e.hasPlayer()&&e.isModalOpen&&e.closeModal()}))}isPlayerInShop(){return this._shops.some((e=>e.hasPlayer()))}}class wt extends K{world;_image=null;_layoutImage=null;_inventory={};_isEnteredByPlayer=!1;_modalOpen=!1;_name="";constructor(e,t){super(new i(t.position.x,t.position.y),64,64,t.id),this.world=e,this._inventory=t.inventory||{},this._name=t.name,W(y.SHOP).then((e=>{this._image=e})),W(y.SHOP_LAYOUT).then((e=>{this._layoutImage=e}))}handlePlayerEnter(){this._isEnteredByPlayer||(this._isEnteredByPlayer=!0,Y.getInstance().playSound(w.ENTER_SHOP))}handlePlayerExit(){this._isEnteredByPlayer=!1,this._modalOpen=!1}hasPlayer(){return this._isEnteredByPlayer}openModal(){this._modalOpen=!this._modalOpen}closeModal(){this._modalOpen=!1}get inventory(){return this._inventory}get isModalOpen(){return this._modalOpen}draw(e,t){if(!this._image||!this.world.player)return;const i=this.world.player;let n=(this.getPosition().distanceTo(i.getPosition())<=this.world.torchRadius+this.width||i.hasNightVision())&&!this.world.gameOver;for(const e of this.world.otherPlayers)if(!e.hasNightVision()&&this.getPosition().distanceTo(e.getPosition())<=this.world.torchRadius+this.width){n=!0;break}if(!n)return;const s=this.world.worldToScreenCoordinates(this.getPosition());e.save(),e.translate(s.x,s.y),e.drawImage(this._image,-this.width/2,-this.height/2,this.width,this.height),e.font=`14px ${o}`;const a=e.measureText(this._name),r=a.width+6,l=a.actualBoundingBoxAscent+6;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(-r/2,this.height/2+30,r,l),e.fillStyle="white",e.textAlign="center",e.fillText(this._name,0,this.height/2+30+a.actualBoundingBoxAscent+3),e.restore(),this.world.debug&&(t.save(),t.translate(s.x,s.y),t.strokeStyle="turquoise",t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),t.restore())}drawUI(e){if(this._isEnteredByPlayer)if(this._modalOpen){if(!this._layoutImage)return;e.save();const t=this._layoutImage.width,i=this._layoutImage.height,n=(e.canvas.width-t)/2,s=(e.canvas.height-i)/2;e.drawImage(this._layoutImage,n,s,t,i);const a=5,r=400,l=72;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect((e.canvas.width-r)/2-a,e.canvas.height-88-a,r+2*a,l+2*a);const h=Object.values(this._inventory).filter((e=>e.quantity>0)).length,c=h>9?"Press buttons from 1 through 9 and 0 to make a purchase.":0===h?"No items available for purchase.":1===h?"Press button 1 to make a purchase.":`Press button from 1 through ${h} to make a purchase.`;e.fillStyle="white",e.textAlign="center",e.font=`14px ${o}`,e.fillText("üü® - available, üü• - not enough money, üü© - already owned",e.canvas.width/2,e.canvas.height-72),e.fillText(c,e.canvas.width/2,e.canvas.height-50),e.fillText("Press Escape to close the Shop.",e.canvas.width/2,e.canvas.height-28);const d=n+148,u=s+72,g=53;let p=0;e.fillStyle="#f7e78cff",e.font=`20px ${o}`,e.textAlign="center",e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=4,e.fillText("Item",d+28,u-20),e.fillText("Pack Size",d+140,u-20),e.fillText("Price",d+290,u-20),e.fillText("Stock",d+400,u-20),e.restore();for(const[t,i]of Object.entries(this._inventory)){if(i.quantity<=0)continue;const n=d,s=u+p*g,a=this.world.getInventoryTexture(Number(t));a&&e.drawImage(a,n-a.width/2+g/2,s-a.height/2+g/2,a.width,a.height),e.save(),e.fillStyle="#f7e78cff";const r=this.world.player,l=Number(t),h=Object.values(x).includes(l);r&&r.money<i.price*i.packSize&&(e.fillStyle="#ff4d4dff"),h&&r&&r.hasInventoryItem(l)&&(e.fillStyle="#4dff4dff"),e.font=`20px ${o}`,e.textAlign="right",e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=4,e.fillText(`${i.packSize}`,n+174,s+g/2+5),e.fillText("$"+i.price*i.packSize,n+328,s+g/2+5),e.fillText(`${i.quantity}`,n+418,s+g/2+5),e.fillText(""+(p+1)%10,n-10,s+g/2+5),e.restore(),p++}}else e.save(),e.fillStyle="white",e.textAlign="center",e.font=`14px ${o}`,e.fillText("Press Enter to visit the Shop",e.canvas.width/2,e.canvas.height-160),e.restore()}applyFromGameState(e){this._inventory=e.inventory||{}}}class bt extends K{world;_name;_images={blaster:null,shotgun:null,railgun:null,rocket_launcher:null};_bloodImage=null;_rotation=0;_bullets=[];_invulnerableTimer=0;_lives=5;_nightVisionTimer=0;_weaponType="blaster";dead=!1;get rotation(){return this._rotation}get nightVisionTimer(){return this._nightVisionTimer}get name(){return this._name}constructor(e,t,i,n,s){super(t,24,24,n),this.world=e,this._name=s,this._rotation=i,W(D.blaster).then((e=>{this._images.blaster=e})),W(D.shotgun).then((e=>{this._images.shotgun=e})),W(D.railgun).then((e=>{this._images.railgun=e})),W(D.rocket_launcher).then((e=>{this._images.rocket_launcher=e})),W(y.BLOOD).then((e=>{this._bloodImage=e}))}getGunPoint(){return this.getPosition().movedByPointCoordinates(h.inverted()).moveByPointCoordinates(c).rotateAroundPointCoordinates(this.getPosition(),this._rotation)}moveTo(e){this._point.setToPointCoordinates(e)}rotate(e){this._rotation=e}update(e){this._invulnerableTimer>0&&(this._invulnerableTimer=Math.max(0,this._invulnerableTimer-e))}draw(e,t){if(this._bullets.forEach((i=>{i.draw(e,t)})),!this._images[this._weaponType]||!this.world.player||this.world.gameOver)return;const n=this.world.worldToScreenCoordinates(this.getPosition());let s=!0;if((!this.world.player.hasNightVision()&&this.hasNightVision()||!this.isAlive())&&(s=this.getPosition().distanceTo(this.world.player.getTorchPoint())<=this.world.torchRadius+this.width),!s)return;this.drawUI(t);const a=5*this._invulnerableTimer/1,r=a-Math.floor(a)<.5;if(e.save(),e.translate(n.x,n.y),(this.dead||!this._invulnerableTimer||r)&&!this.world.gameOver){e.rotate(this._rotation*Math.PI/180);const t=this.dead?32:64,n=this.dead?new i(-t/2,-t/2):h.inverted();this.dead&&this._bloodImage&&e.drawImage(this._bloodImage,-this.width/2,-this.height/2,this.width,this.height),!this.dead&&this._images[this._weaponType]&&e.drawImage(this._images[this._weaponType],n.x,n.y,t,t),e.rotate(-this._rotation*Math.PI/180)}if(e.restore(),this.world.debug){t.strokeStyle="red",t.strokeRect(-this.width/2+n.x,-this.height/2+n.y,this.width,this.height),t.fillStyle="magenta",t.beginPath(),t.arc(n.x,n.y,2,0,2*Math.PI),t.fill(),t.fillStyle="magenta";const e=this.world.worldToScreenCoordinates(this.getGunPoint());t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill()}}isAlive(){return this._lives>0}get lives(){return this._lives}drawUI(e){const t=this.world.worldToScreenCoordinates(this.getPosition());e.font=`14px ${o}`;const i=e.measureText(this.name),n=i.width+6,s=i.actualBoundingBoxAscent+6;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(t.x-n/2,t.y+this.height/2+30,n,s),e.fillStyle="white",e.textAlign="center",e.fillText(this.name,t.x,t.y+this.height/2+30+i.actualBoundingBoxAscent+3)}isInvulnerable(){return this._invulnerableTimer>0}hasNightVision(){return!1}isNightVisionFading(){return!1}getTorchPoint(){return this.getPosition().movedByPointCoordinates(h.inverted()).moveByPointCoordinates(d).rotateAroundPointCoordinates(this.getPosition(),this._rotation)}applyFromGameState(e){this._point.setTo(e.position.x,e.position.y),this._rotation=e.rotation,this._lives=e.lives,this.dead=!e.isAlive,this._invulnerableTimer=e.invulnerableTimer,this._nightVisionTimer=e.nightVisionTimer,this._weaponType=e.selectedGunType}}class kt{x;y;constructor(e,t){this.x=e,this.y=t}add(e){return new kt(this.x+e.x,this.y+e.y)}subtract(e){return new kt(this.x-e.x,this.y-e.y)}multiply(e){return new kt(this.x*e,this.y*e)}normalize(){const e=Math.sqrt(this.x*this.x+this.y*this.y);return 0===e?new kt(0,0):new kt(this.x/e,this.y/e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}static fromAngle(e){return new kt(-Math.sin(e),Math.cos(e))}getAngle(){return 270+180*Math.atan2(this.y,this.x)/Math.PI}}class _t extends K{world;rotation;isEnemy;ownerId;_velocity;_speed;_active=!0;_inactiveMs=0;_weaponType="blaster";static _imageRocket=null;static _imageRocketBlast=null;get weaponType(){return this._weaponType}get inactiveMs(){return this._inactiveMs}get active(){return this._active}get velocity(){return this._velocity}set active(e){this._active=e}constructor(e,t,i,n,s,a){super(t,8,8,a),this.world=e,this.rotation=i,this.isEnemy=n,this.ownerId=s,this._speed=n?240:420,this._velocity=kt.fromAngle(i*Math.PI/180).multiply(this._speed),_t._imageRocket||W(y.BULLET_ROCKET).then((e=>{_t._imageRocket=e})),_t._imageRocketBlast||W(m.EXPLOSION.image).then((e=>{document.body.appendChild(e),e.style.display="none",_t._imageRocketBlast=e}))}static fromGameState(e,t){const n=new _t(e,new i(t.position?.x??0,t.position?.y??0),t.velocity?Math.atan2(t.velocity.y,t.velocity.x)*(180/Math.PI):0,t.isEnemy,t.ownerId,t.id);return n._weaponType=t.weaponType,t.isActive||(n._active=!1),t.velocity&&(n._velocity=new kt(t.velocity.x,t.velocity.y)),n._weaponType=t.weaponType,n._inactiveMs=Number(t.inactiveMs??0),n}draw(e,t,i){if(!this._active&&!["railgun","rocket_launcher"].includes(this._weaponType))return;const n=this.world.worldToScreenCoordinates(this.getPosition());if(e.save(),e.translate(n.x,n.y),"railgun"===this._weaponType){e.strokeStyle=this.isEnemy?f:u,e.lineWidth=2,e.beginPath(),e.moveTo(0,0);const t=this.velocity.x,i=this.velocity.y;e.lineTo(t,i),e.stroke();const n=20,s=e.createRadialGradient(t,i,0,t,i,n);return s.addColorStop(0,this.isEnemy?f:u),s.addColorStop(1,"transparent"),e.fillStyle=s,e.beginPath(),e.arc(t,i,n,0,2*Math.PI),e.fill(),void e.restore()}if("rocket_launcher"===this._weaponType&&_t._imageRocket){if(!this._active&&_t._imageRocketBlast&&i){const t=_t._imageRocketBlast.width/m.EXPLOSION.frameCount,n=_t._imageRocketBlast.height,s=m.EXPLOSION.duration,a=Math.floor(i/s*m.EXPLOSION.frameCount);return a>=m.EXPLOSION.frameCount||e.drawImage(_t._imageRocketBlast,a*t,0,t,n,-t/2,-n/2,t,n),void e.restore()}const t=Math.atan2(this.velocity.y,this.velocity.x)+Math.PI/2;e.rotate(t);const n=_t._imageRocket.width,s=_t._imageRocket.height;return e.drawImage(_t._imageRocket,-n/2,-s/2,n,s),void e.restore()}e.rotate(this.rotation*Math.PI/180),e.fillStyle=this.isEnemy?f:u,e.beginPath(),e.arc(0,0,this.width/2,0,2*Math.PI),e.fill(),e.restore()}}class Tt{world;_bullets=new Map;_bulletsSoundCache=new Set;_bulletsRemovedSoundCache=new Set;get bullets(){return Array.from(this._bullets.values())}constructor(e){this.world=e}getBulletCacheKey(e){let t=`${e.id}`;return"shotgun"!==e.weaponType||e.isActive||(t=`${e.ownerId}-${e.deletedAt}`),t}applyFromGameState(e,t){const i=_t.fromGameState(this.world,e);if(t&&i.active)return void this._bullets.delete(i.id);const n=i.getPosition().distanceTo(this.world.player.getPosition()),s=2*this.world.torchRadius,a=n>=s?0:1-n/s,r=this.getBulletCacheKey(e);if(this._bulletsSoundCache.has(r)||(this._bulletsSoundCache.add(r),Y.getInstance().playSound(P[i.weaponType]||w.BULLET,{volume:a})),!i.active){const e=U[i.weaponType];if(i.inactiveMs>=e)return void this._bullets.delete(i.id);"rocket_launcher"===i.weaponType&&(this._bulletsRemovedSoundCache.has(r)||(Y.getInstance().playSound(w.ROCKET_BLAST,{volume:a,offset:i.inactiveMs}),this._bulletsRemovedSoundCache.add(r)))}this._bullets.set(i.id,i)}getBulletById(e){return this._bullets.get(e)||null}hasSoundPlayedForBullet(e){const t=this.getBulletCacheKey(e);return this._bulletsSoundCache.has(t)}draw(e,t){this.bullets.forEach((i=>{if(i.active)i.draw(e,t);else{const n=U[i.weaponType],s=i.inactiveMs;if(s>=n)return this._bullets.delete(i.id),this._bulletsSoundCache.delete(i.id),void this._bulletsRemovedSoundCache.delete(i.id);i.draw(e,t,s)}}))}}class vt{_canvas;_lightCanvas;_uiCanvas;_ctx;_lightCtx;_uiCtx;_lastTime=0;_world=null;_activeKeys=new Set;_authManager;_sessionManager;_started=!1;get world(){return this._world}constructor(){this._canvas=document.getElementById("gameCanvas"),this._lightCanvas=document.getElementById("lightCanvas"),this._uiCanvas=document.getElementById("uiCanvas"),[this._canvas,this._lightCanvas,this._uiCanvas].forEach((e=>{e.width=a,e.height=r})),this._ctx=this._canvas.getContext("2d"),this._lightCtx=this._lightCanvas.getContext("2d"),this._uiCtx=this._uiCanvas.getContext("2d"),this._authManager=Z.getInstance(),this._sessionManager=yt.getInstance(),this.setupEventListeners()}static async loadResources(){const e=Y.getInstance();await Promise.all([W(y.FLOOR),W(y.PLAYER),W(y.ENEMY),W(y.WALL),e.loadSound(w.PLAYER_HURT),e.loadSound(w.PLAYER_DEAD),e.loadSound(w.ENEMY_HURT),e.loadSound(w.TORCH)]),e.loadSound(w.PLAYER_BULLET_RECHARGE),e.loadSound(w.BONUS_PICKUP),e.loadSound(w.GAME_OVER),e.loadSound(w.BULLET),e.loadSound(w.SHOTGUN),e.loadSound(w.RAILGUN),e.loadSound(w.ROCKET_LAUNCHER),e.loadSound(w.ROCKET_BLAST),e.loadSound(w.SPAWN),e.loadSound(w.ENTER_SHOP),e.loadSound(w.MONEY_SPENT),e.loadSound(w.MISTAKE),W(y.BLOOD),W(y.AID_KIT),W(y.GOGGLES),W(y.SHOP)}setupEventListeners(){window.addEventListener("keydown",(e=>{this._activeKeys.add(e.code),this.handleKeyDown(e)})),window.addEventListener("keyup",(e=>{this._activeKeys.delete(e.code)})),window.addEventListener("mousemove",(e=>this.handleMouseMove(e))),window.addEventListener("mousedown",(e=>this.handleMouseDown(e))),this._sessionManager.onGameState((e=>{if(this._world){const t=this._authManager.getUserData();this._world.applyGameState(e,t.id)}})),this._sessionManager.onGameStateDelta((e=>{this._world&&this._world.applyGameStateDelta(e)})),this._sessionManager.onPlayerJoined((({player:e})=>{e&&this._world&&this._world.addOtherPlayer(e)})),this._sessionManager.onPlayerLeft((({playerId:e})=>{this._world&&this._world.removeOtherPlayer(e)}))}handleKeyDown(e){"F3"===e.key&&this._world?.toggleDebug(),"KeyR"===e.code&&this._world?.gameOver&&this._world?.restart(),"KeyE"!==e.code&&"Backquote"!==e.code||this._world?.toggleInventory(),"Enter"===e.code&&this._world?.openShopModal(),"Escape"===e.code&&this._world?.closeShopModal()}handleMouseMove(e){const t=this._canvas.getBoundingClientRect();e.clientX,t.left,e.clientY,t.top}handleMouseDown(e){if(0===e.button){const t=this._canvas.getBoundingClientRect();e.clientX,t.left,e.clientY,t.top}}async start(e){if(e){const t=this._authManager.getUserData(),i=e.host&&t&&e.host.id===t.id?"host":"guest";this._world=new mt(J,q,X,H,bt,wt,Tt,i),this._started=!0,requestAnimationFrame((e=>this.gameLoop(e)))}}gameLoop(e){if(!this._started)return;const t=(e-this._lastTime)/1e3;this._lastTime=e,this._world?.handleInput(this._activeKeys,t),this._world?.update(t),this.draw(),requestAnimationFrame((e=>this.gameLoop(e)))}stop(){this._started=!1,Y.getInstance().stopAllSounds()}draw(){[this._ctx,this._uiCtx,this._lightCtx].forEach((e=>{e.clearRect(0,0,this._canvas.width,this._canvas.height)})),this._world?.draw(this._ctx,this._lightCtx,this._uiCtx)}}class St{static instance;leaderboardData=[];constructor(){}static getInstance(){return St.instance||(St.instance=new St),St.instance}async getLeaderboard(){const e=await z.get("/leaderboard/global");return this.leaderboardData=e,e}getCurrentLeaderboard(){return this.leaderboardData}async refreshLeaderboard(){return this.getLeaderboard()}}const It=Z.getInstance(),Et=St.getInstance(),Nt=yt.getInstance();let Bt=null;function Rt(e){return document.getElementById(e)}function Pt(){const e=window.location.pathname.match(/\/([a-f0-9-]+)$/i);return e?e[1]:null}function Lt(e){window.history.pushState({},"",`${e}`)}function Ot(){window.history.pushState({},"","")}function xt(e){document.querySelectorAll(".screen").forEach((e=>{e.style.setProperty("display","none")})),Rt(e+"Screen")?.style.setProperty("display","flex")}function At(e){const t=Rt("leaderboardList");t&&(0!==e.length?t.innerHTML=e.slice(0,10).map(((e,t)=>`\n            <li class="leaderboard-item">\n                <span class="rank">#${t+1}</span> \n                <span class="username">${e.username}</span> \n                <span class="session">For the battle at ${e.sessionName}</span>\n                <span class="score">${e.score}</span>\n            </li>\n        `)).join(""):t.innerHTML='<li class="leaderboard-empty">No scores yet. Be the first!</li>')}function Mt(e){const t=Rt("sessionsList");if(!t)return;if(0===e.length)return void(t.innerHTML='<li class="sessions-empty">No active sessions</li>');const i=It.getUserData()?.id;t.innerHTML=e.map((e=>{const t=Object.keys(e.players).length,n=e.max_players||4,s=e.host.id===i,a=`<button ${s?"":'disabled title="You must be the host to delete this session"'} class="session-delete" data-session-id="${e.id}" onclick="event.stopPropagation()">üóëÔ∏è</button>`;return`\n                <li class="session-item" data-session-id="${e.id}">\n                    <div class="session-info">\n                        <span class="session-name">"${e.name}"<span class="session-host">${s?"You":e.host.username}</span></span>\n                        <span class="session-players">${t}/${n}</span>\n                    </div>\n                    ${a}\n                </li>\n            `})).join(""),t.querySelectorAll(".session-item").forEach((e=>{e.addEventListener("click",(async()=>{const t=e.dataset.sessionId;if(t){Bt=new vt;try{const e=await Nt.joinSession(t);Lt(t),await Bt.start(e),xt("game")}catch(e){console.error("Failed to join session:",e);const t=document.querySelector("#leaderboardScreen .error");t&&(t.textContent="Failed to join session. Please try again.",t.style.setProperty("display","block"))}}}))})),t.querySelectorAll(".session-delete").forEach((e=>{e.addEventListener("click",(async t=>{t.stopPropagation();const i=e.dataset.sessionId;if(i&&confirm("Are you sure you want to delete this session?"))try{await Nt.deleteSession(i),Mt(await Nt.listSessions())}catch(e){console.error("Failed to delete session:",e);const t=document.querySelector("#leaderboardScreen .error");t&&(t.textContent="Failed to delete session. Please try again.",t.style.setProperty("display","block"))}}))}))}window.onload=async()=>{try{It.initToken(),await It.checkAuthStatus(),await vt.loadResources();const e=Pt();if(e)try{Bt=new vt;const t=await Nt.joinSession(e);return await Bt.start(t),void xt("game")}catch(e){console.error("Failed to join session from URL:",e),Ot()}const[t,i]=await Promise.all([Et.getLeaderboard(),Nt.listSessions()]);At(t),Mt(i),xt("leaderboard"),Rt("username").textContent=It.getUserData().username}catch(e){console.error(e),function(){const e=Rt("loader");e&&e.style.setProperty("display","none")}(),function(){const e=Rt("loginButton");e&&e.style.setProperty("display","flex")}()}},Rt("loginButton")?.addEventListener("click",(async()=>{if(!It.isPerformingRequest())try{await It.getAuthUrl(),It.openAuthPage()}catch(e){console.error("Authentication failed:",e)}})),Rt("sessionsTab")?.addEventListener("click",(()=>{Rt("sessionsTab")?.classList.add("active"),Rt("leaderboardTab")?.classList.remove("active");const e=Rt("sessions"),t=Rt("leaderboard");e&&(e.style.display="block"),t&&(t.style.display="none")})),Rt("leaderboardTab")?.addEventListener("click",(()=>{Rt("leaderboardTab")?.classList.add("active"),Rt("sessionsTab")?.classList.remove("active");const e=Rt("sessions"),t=Rt("leaderboard");e&&(e.style.display="none"),t&&(t.style.display="block")})),Rt("startGameButton")?.addEventListener("click",(async()=>{const e=Rt("sessionNameModal"),t=Rt("sessionNameInput");e&&t&&(t.value=function(){const e=["Silly","Crazy","Brave","Sneaky","Mighty","Clumsy","Epic","Fancy","Grumpy","Happy","Sleepy","Dancing","Flying","Invisible","Legendary","Mysterious","Chaotic","Funky","Bizarre","Magical"],t=["Dragon","Goblin","Wizard","Knight","Potato","Unicorn","Troll","Ninja","Pirate","Skeleton","Chicken","Banana","Mushroom","Phoenix","Penguin","Donut","Cactus","Platypus","Waffle","Pickles"],i=["Dungeon","Castle","Cave","Tower","Forest","Swamp","Mountain","Island","Kingdom","Realm","Lair","Temple","Abyss","Palace","Fortress"];return`${e[Math.floor(Math.random()*e.length)]} ${t[Math.floor(Math.random()*t.length)]} ${i[Math.floor(Math.random()*i.length)]}`}(),e.classList.add("show"),t.focus(),t.select())})),Rt("cancelSessionButton")?.addEventListener("click",(()=>{const e=Rt("sessionNameModal");e&&e.classList.remove("show")})),Rt("createSessionButton")?.addEventListener("click",(async()=>{const e=Rt("sessionNameModal"),t=Rt("sessionNameInput"),i=t?.value.trim()||"";if(i){e&&e.classList.remove("show"),Bt&&Bt.stop(),Bt=new vt;try{const e=await Nt.startSession(i);Lt(e.id),await Bt.start(e),xt("game")}catch(e){if(console.error("Game initialization failed:",e),"object"==typeof e&&e&&"message"in e&&"string"==typeof e.message){const e=document.querySelector("#leaderboardScreen .error");e&&(e.textContent="There's a problem on our end. Please try again later.",e.style.setProperty("display","block"))}}}})),Rt("sessionNameInput")?.addEventListener("keypress",(e=>{"Enter"===e.key&&Rt("createSessionButton")?.click()})),document.addEventListener("keydown",(e=>{if("Escape"===e.key){const e=Rt("sessionNameModal");e?.classList.contains("show")&&e.classList.remove("show")}})),window.addEventListener("popstate",(async()=>{const e=Pt();if(e)try{Bt&&Bt.stop(),Bt=new vt;const t=await Nt.joinSession(e);await Bt.start(t),xt("game")}catch(e){console.error("Failed to join session from URL:",e),Ot(),xt("leaderboard")}else{const e=document.querySelector(".screen[style*='display: flex']");if("gameScreen"===e?.id){try{await Nt.endSession(),Bt?.stop()}catch(e){console.error("Error ending session:",e)}const[e,t]=await Promise.all([Et.getLeaderboard(),Nt.listSessions()]);At(e),Mt(t);const i=It.getUserData();i&&(Rt("username").textContent=i.username),xt("leaderboard")}}}))})();