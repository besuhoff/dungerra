(()=>{"use strict";var e="/dungerra/";const t={floorTexture:e+"assets/ba86869b6bcdfdb23fcd.png",wallTexture:e+"assets/1ff0e9fd7756fa67a6e3.jpg",playerTexture:e+"assets/36842061eecde0146548.png",playerShotgunTexture:e+"assets/82149cdcc18d151a09cc.png",playerRailgunTexture:e+"assets/dba6046f9eea37c5faa3.png",playerRocketLauncherTexture:e+"assets/1be230d8a1c34654da1d.png",enemyTexture:e+"assets/c2abb91c965fee2c144b.png",enemyLieutenantTexture:e+"assets/7a7a84a73f8c10a43fae.png",enemyTowerTexture:e+"assets/4ce6e21a9a8fa832a537.png",enemyTowerTurretTexture:e+"assets/d8754d9f147ba7ec6069.png",enemyTowerRuinedTexture:e+"assets/971ef01dfec714ac7a93.png",bloodTexture:e+"assets/aad741dfe71af677f795.png",aidKitTexture:e+"assets/79e186c8dd3fba9deccb.png",gogglesTexture:e+"assets/731b2b0db1a708ca3175.png",heartTexture:e+"assets/502866806875110ceeae.png",shopTexturne:e+"assets/20d0728d9980c79a46d8.png",inventoryTexture:e+"assets/01c4effa1c7f6f4277bb.png",itemRailgunTexture:e+"assets/20d94331a249251f72fd.png",itemRocketLauncherTexture:e+"assets/2028a209c1d45ed223b8.png",itemShotgunTexture:e+"assets/0864d380ef9d32f4dd3d.png",itemBlasterTexture:e+"assets/3ede2d2991151e8bf272.png",itemAmmoShotgunTexture:e+"assets/ff336fc71319c4a55ec6.png",itemAmmoRocketLauncherTexture:e+"assets/a376fa91ea6835a98345.png",itemAmmoRailgunTexture:e+"assets/ca67a899bd13b1db165d.png",bulletRocketTexture:e+"assets/4f4294a77c4b4f4b1dce.png",shopLayoutTexture:e+"assets/06f02911d0ba2229b770.png",chestTexture:e+"assets/2af5eb44d29a59f3b662.png",explosionAnimation:{image:e+"assets/116019dff1c51461403b.png",frameCount:17,duration:800},bulletSound:e+"assets/5d47cbddfd7640ba29a0.ogg",torchSound:e+"assets/ac5ce9bd2dc980bf1754.ogg",gameOverSound:e+"assets/81f4739e205d4712bde7.ogg",playerHurtSound:e+"assets/0aaf114e55619a91fd22.ogg",playerDeadSound:e+"assets/f7f66f7a50db67b654e0.ogg",enemyHurtSound:e+"assets/a5236b0656b6d63f174a.ogg",playerBulletRechargeSound:e+"assets/671b1542dbb4caf26fa4.ogg",bonusPickupSound:e+"assets/a0eba45f5e6c41de422f.ogg",spawnSound:e+"assets/912af0db42bb5d4e3612.ogg",rocketLauncherSound:e+"assets/50dad2a267c55ca22618.ogg",rocketBlastSound:e+"assets/b7af1b74e0e69193962f.ogg",railgunSound:e+"assets/6c87a33a2b9e9e7791fc.ogg",shotgunSound:e+"assets/65b2382668c942f8e10e.ogg",enterShopSound:e+"assets/c61abe865ca7c71e3bc5.ogg",moneySpentSound:e+"assets/3ab75845dc3c04dc66ed.ogg",mistakeSound:e+"assets/48dd75ca19d8333cad68.ogg",towerHitSound:e+"assets/a04ba58e567086903cb2.ogg",towerCrashSound:e+"assets/49b6c846c0986a23e375.ogg"};class i{_x;_y;constructor(e,t){this._x=e,this._y=t}get x(){return this._x}get y(){return this._y}toString(){return`(${this._x.toFixed(2)}, ${this._y.toFixed(2)})`}equals(e){return this._x===e.x&&this._y===e.y}subtract(e){return this._x-=e.x,this._y-=e.y,this}subtracted(e){return this.clone().subtract(e)}clone(){return new i(this._x,this._y)}setTo(e,t){return this._x=e,this._y=t,this}setToPointCoordinates(e){return this.setTo(e.x,e.y)}moveBy(e,t){return this._x+=e,this._y+=t,this}movedBy(e,t){return this.clone().moveBy(e,t)}moveByPointCoordinates(e){return this.moveBy(e.x,e.y)}movedByPointCoordinates(e){return this.clone().moveByPointCoordinates(e)}invertAgainstPointCoordinates(e){return this.moveBy(2*(e.x-this._x),2*(e.y-this._y))}invertedAgainstPointCoordinates(e){return this.clone().invertAgainstPointCoordinates(e)}invert(){return this.invertAgainstPointCoordinates(new i(0,0))}inverted(){return this.clone().invert()}rotateAroundPointCoordinates(e,t){const i=Math.cos(t*Math.PI/180),n=Math.sin(t*Math.PI/180),s=this._x-e._x,r=this._y-e.y;return this._x=s*i-r*n+e._x,this._y=s*n+r*i+e.y,this}rotatedAroundPointCoordinates(e,t){return this.clone().rotateAroundPointCoordinates(e,t)}rotate(e){return this.rotateAroundPointCoordinates(new i(0,0),e)}rotated(e){return this.clone().rotate(e)}distanceTo(e){return Math.sqrt((this._x-e.x)**2+(this.y-e.y)**2)}}const n="https://dungeon-game-go.onrender.com",s=`${n}/api/v1`,r=1280,a=720,o="Texturina",l="#000000E6",h=new i(31,26),d=new i(-10,20),c=new i(7,11),u="#00FFFF",p=new i(31,26),g=new i(90,90),y=new i(-1,28),f=new i(0,80),m="#FF0000",w={FLOOR:t.floorTexture,WALL:t.wallTexture,PLAYER:t.playerTexture,PLAYER_SHOTGUN:t.playerShotgunTexture,PLAYER_RAILGUN:t.playerRailgunTexture,PLAYER_ROCKET_LAUNCHER:t.playerRocketLauncherTexture,ENEMY:t.enemyTexture,ENEMY_LIEUTENANT:t.enemyLieutenantTexture,ENEMY_TOWER:t.enemyTowerTurretTexture,ENEMY_TOWER_BACK:t.enemyTowerTexture,ENEMY_TOWER_RUINED:t.enemyTowerRuinedTexture,BLOOD:t.bloodTexture,AID_KIT:t.aidKitTexture,GOGGLES:t.gogglesTexture,CHEST:t.chestTexture,HEART:t.heartTexture,SHOP:t.shopTexturne,SHOP_LAYOUT:t.shopLayoutTexture,INVENTORY:t.inventoryTexture,ITEM_RAILGUN:t.itemRailgunTexture,ITEM_ROCKET_LAUNCHER:t.itemRocketLauncherTexture,ITEM_SHOTGUN:t.itemShotgunTexture,ITEM_BLASTER:t.itemBlasterTexture,ITEM_AMMO_SHOTGUN:t.itemAmmoShotgunTexture,ITEM_AMMO_ROCKET_LAUNCHER:t.itemAmmoRocketLauncherTexture,ITEM_AMMO_RAILGUN:t.itemAmmoRailgunTexture,BULLET_ROCKET:t.bulletRocketTexture},b={EXPLOSION:t.explosionAnimation},k={BULLET:t.bulletSound,TORCH:t.torchSound,GAME_OVER:t.gameOverSound,PLAYER_HURT:t.playerHurtSound,PLAYER_DEAD:t.playerDeadSound,ENEMY_HURT:t.enemyHurtSound,PLAYER_BULLET_RECHARGE:t.playerBulletRechargeSound,BONUS_PICKUP:t.bonusPickupSound,SPAWN:t.spawnSound,ROCKET_LAUNCHER:t.rocketLauncherSound,ROCKET_BLAST:t.rocketBlastSound,RAILGUN:t.railgunSound,SHOTGUN:t.shotgunSound,ENTER_SHOP:t.enterShopSound,MONEY_SPENT:t.moneySpentSound,MISTAKE:t.mistakeSound,TOWER_HIT:t.towerHitSound,TOWER_CRASH:t.towerCrashSound},T="pr",_="lt",v="tw",S={[T]:1,[_]:2,[v]:30},E={[T]:w.ENEMY,[_]:w.ENEMY_LIEUTENANT,[v]:w.ENEMY_TOWER},I={[T]:w.BLOOD,[_]:w.BLOOD,[v]:w.ENEMY_TOWER_RUINED},B=1,N=2,R=3,P=4,L=22,O=23,x=24,A=7,U=8,D=[22,23,24],M={[B]:w.ITEM_BLASTER,[N]:w.ITEM_SHOTGUN,[R]:w.ITEM_ROCKET_LAUNCHER,[P]:w.ITEM_RAILGUN,[L]:w.ITEM_AMMO_SHOTGUN,[O]:w.ITEM_AMMO_ROCKET_LAUNCHER,[x]:w.ITEM_AMMO_RAILGUN,[U]:w.AID_KIT,[A]:w.GOGGLES},C={blaster:k.BULLET,shotgun:k.SHOTGUN,railgun:k.RAILGUN,rocket_launcher:k.ROCKET_LAUNCHER},j=["railgun","rocket_launcher"],$={shotgun:22,rocket_launcher:23,railgun:24},V={blaster:1,shotgun:2,rocket_launcher:3,railgun:4},F=[7,8],W={blaster:"‚óè",shotgun:"‚Åç",railgun:"‚ö°",rocket_launcher:"üöÄ"},G={blaster:w.PLAYER,shotgun:w.PLAYER_SHOTGUN,railgun:w.PLAYER_RAILGUN,rocket_launcher:w.PLAYER_ROCKET_LAUNCHER},K={blaster:0,shotgun:0,railgun:200,rocket_launcher:b.EXPLOSION.duration},H={[T]:m,[_]:"#0004ffff"},Y={[T]:24,[_]:24,[v]:120},q={[T]:y,[_]:y,[v]:f},J={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let X;const Z=new Uint8Array(16);function z(){if(!X){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");X=crypto.getRandomValues.bind(crypto)}return X(Z)}const Q=[];for(let e=0;e<256;++e)Q.push((e+256).toString(16).slice(1));const ee=function(e,t,i){if(J.randomUUID&&!t&&!e)return J.randomUUID();const n=(e=e||{}).random||(e.rng||z)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=n[e];return t}return function(e,t=0){return(Q[e[t+0]]+Q[e[t+1]]+Q[e[t+2]]+Q[e[t+3]]+"-"+Q[e[t+4]]+Q[e[t+5]]+"-"+Q[e[t+6]]+Q[e[t+7]]+"-"+Q[e[t+8]]+Q[e[t+9]]+"-"+Q[e[t+10]]+Q[e[t+11]]+Q[e[t+12]]+Q[e[t+13]]+Q[e[t+14]]+Q[e[t+15]]).toLowerCase()}(n)};class te{_point;_width;_height;_id;static _objectNumber=0;static get objectCount(){return te._objectNumber}get id(){return this._id}constructor(e,t,i,n=ee()){this._point=e,this._width=t,this._height=i,this._id=n,te._objectNumber++}get x(){return this._point.x}get y(){return this._point.y}get width(){return this._width}get height(){return this._height}getPosition(){return this._point}moveBy(e,t){this._point.moveBy(e,t)}getCollisionRect(e=0,t=0){return{left:this.x-this.width/2+e,top:this.y-this.height/2+t,width:this.width,height:this.height}}checkCollision(e,t,i,n){const s=this.getCollisionRect();return s.left<e+i&&s.left+s.width>e&&s.top<t+n&&s.top+s.height>t}checkCollisionWithObject(e){const t=e.getCollisionRect();return this.checkCollision(t.left,t.top,t.width,t.height)}}function ie(e){return new Promise(((t,i)=>{const n=new Image;n.onload=()=>t(n),n.onerror=t=>i(new Error(`Failed to load image: ${e}`)),n.src=e}))}class ne extends te{world;_type;_belongsToPlayer=!1;image=null;get type(){return this._type}get belongsToPlayer(){return this._belongsToPlayer}constructor(e,t){let n="",s=0;"aid_kit"===t.type?(n=w.AID_KIT,s=32):"goggles"===t.type?(n=w.GOGGLES,s=32):"chest"===t.type&&(n=w.CHEST,s=32),super(new i(t.position.x,t.position.y),s,s,t.id),this.world=e,this._type=t.type,this._belongsToPlayer=t.droppedBy===e.player?.id,ie(n).then((e=>{this.image=e}))}draw(e){if(!this.image||!this.world.player||this.world.gameOver)return;const t=this.world.player;let i=(this.getPosition().distanceTo(t.getPosition())<=this.world.torchRadius+this.width||t.hasNightVision())&&!this.world.gameOver;for(const e of this.world.otherPlayers)if(!e.hasNightVision()&&this.getPosition().distanceTo(e.getPosition())<=this.world.torchRadius+this.width){i=!0;break}if(!i)return;const n=this.world.worldToScreenCoordinates(this.getPosition());e.save(),e.translate(n.x,n.y),e.drawImage(this.image,-this.width/2,-this.height/2,this.width,this.height),e.restore()}}class se{static instance;audioContext;soundBuffers;loadingPromises;activeSources=new Map;constructor(){this.audioContext=new AudioContext,this.soundBuffers=new Map,this.loadingPromises=new Map}static getInstance(){return se.instance||(se.instance=new se),se.instance}async loadSound(e){if(this.soundBuffers.has(e)||this.loadingPromises.has(e))return;const t=fetch(e).then((e=>e.arrayBuffer())).then((e=>this.audioContext.decodeAudioData(e))).then((t=>{this.soundBuffers.set(e,t)}));this.loadingPromises.set(e,t),await t}playSound(e,t){const i=this.soundBuffers.get(e);if(!i)return void console.warn(`Sound not loaded: ${e}`);const n=this.audioContext.createBufferSource();n.buffer=i,n.loop=t?.loop??!1;const s=this.audioContext.createGain();s.gain.value=t?.volume??1,n.connect(s),s.connect(this.audioContext.destination),this.activeSources.has(e)||this.activeSources.set(e,new Set),this.activeSources.get(e).add(n),n.onended=()=>{const t=this.activeSources.get(e);t&&t.delete(n)},n.start(t?.when??0,t?.offset??0)}stopSound(e){const t=this.activeSources.get(e);t&&(t.forEach((e=>{try{e.stop()}catch(e){}})),t.clear())}stopAllSounds(){this.activeSources.forEach(((e,t)=>{e.forEach((e=>{try{e.stop()}catch(e){}})),e.clear()}))}}class re extends te{world;_wall;_enemyTowerBg=null;_image=null;deadImage=null;dead=!1;_lives=1;_rotation=0;_type;get lives(){return this._lives}get wall(){return this._wall}constructor(e,t,n){const s=Y[t.type],r=t.position??{x:0,y:0};super(new i(r.x,r.y),s,s,t.id),this.world=e,this._wall=n,this._rotation=t.rotation,this._lives=t.lives,this.dead=!t.isAlive,this._type=t.type,ie(E[this._type]).then((e=>{this._image=e})),ie(w.ENEMY_TOWER_BACK).then((e=>{this._enemyTowerBg=e})),ie(I[this._type]).then((e=>{this.deadImage=e}))}get rotation(){return this._rotation}getGunPoint(){return this.getPosition().movedByPointCoordinates(q[this._type]).rotateAroundPointCoordinates(this.getPosition(),this.rotation)}draw(e,t){if(this.world.gameOver)return;const n=this.world.player;if(!this._image||!n)return;let s=!1;if(n.isAlive()&&n.hasNightVision())s=!0;else{const e=[n,...this.world.otherPlayers.filter((e=>e.isAlive()&&!e.hasNightVision()))];for(const t of e){const e=this.getPosition().distanceTo(t.getTorchPoint());s=s||e<=this.world.torchRadius+this.width}}const r=this.world.worldToScreenCoordinates(this.getPosition());e.save(),e.translate(r.x,r.y);let a=this.dead?32:64,l=this.dead?new i(-a/2,-a/2):p.inverted();const h=v;if(this._type===h&&(a=180,l=g.inverted()),this.dead&&s&&this.deadImage&&e.drawImage(this.deadImage,l.x,l.y,a,a),!this.dead&&s){this._type===h&&this._enemyTowerBg&&e.drawImage(this._enemyTowerBg,l.x,l.y,a,a),e.rotate(this.rotation*Math.PI/180),e.drawImage(this._image,l.x,l.y,a,a),e.rotate(-this.rotation*Math.PI/180);const t=this.width,i=5,n=this._lives/S[this._type];e.fillStyle="red",e.fillRect(-t/2,this.height/2+i+6,t,i),e.fillStyle="lime",e.fillRect(-t/2,this.height/2+i+6,t*n,i)}if(e.restore(),this.world.debug){if(t.save(),t.translate(r.x,r.y),t.strokeStyle="#00ff00",t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),!this.dead){t.rotate(this.rotation*Math.PI/180),t.fillStyle="magenta";const e=q[this._type];t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill(),t.rotate(-this.rotation*Math.PI/180)}this._wall&&(t.fillStyle="white",t.font=`12px ${o}`,t.textAlign="left",t.fillText(`Wall #${this._wall.id}`,-20,24),t.fillText(`Position: ${this.getPosition()}`,-20,36)),t.restore()}}isAlive(){return!this.dead}isInvulnerable(){return!1}applyFromGameStateDelta(e){if(e.position&&(this._point.setTo(e.position.x,e.position.y),this._rotation=e.position.rotation),e.lives){if(e.lives.lives<this._lives){const t=this.getPosition().distanceTo(this.world.player.getPosition()),i=2*this.world.torchRadius,n=t>=i?0:1-t/i,s=se.getInstance(),r=this._type===v?e.lives.isAlive?k.TOWER_HIT:k.TOWER_CRASH:k.ENEMY_HURT;s.playSound(r,{volume:n})}this._lives=e.lives.lives,this.dead=!e.lives.isAlive}}}class ae extends te{world;_nightVisionTimer=0;_rotation=0;_bulletsLeft=6;_kills=0;_money=0;_score=0;_selectedGunType="blaster";_inventory=[];_images={blaster:null,shotgun:null,railgun:null,rocket_launcher:null};_imageDead=null;_inventoryImage=null;_inventoryOpen=!0;_invulnerableTimer=0;_debugData={};_lives=0;get money(){return this._money}get score(){return this._score}get kills(){return this._kills}get bulletsLeft(){return this._bulletsLeft}get rotation(){return this._rotation}get nightVisionTimer(){return this._nightVisionTimer}get selectedGunType(){return this._selectedGunType}get inventory(){return this._inventory}hasInventoryItem(e){return this._inventory.some((t=>t.type===e&&t.quantity>0))}toggleInventory(){this._inventoryOpen=!this._inventoryOpen}static createFromSessionPlayer(e,t){const n=new ae(e,new i(t.position.x,t.position.y),t.position.rotation,t.player_id);return n._lives=t.lives,n._kills=t.kills,n._money=t.money,n}constructor(e,t,i,n=""){super(t,24,24,n),this.world=e,this._rotation=i,ie(G.blaster).then((e=>{this._images.blaster=e})),ie(G.shotgun).then((e=>{this._images.shotgun=e})),ie(G.railgun).then((e=>{this._images.railgun=e})),ie(G.rocket_launcher).then((e=>{this._images.rocket_launcher=e})),ie(w.INVENTORY).then((e=>{this._inventoryImage=e})),ie(w.BLOOD).then((e=>{this._imageDead=e}))}getGunPoint(){return this.getPosition().movedByPointCoordinates(d).rotateAroundPointCoordinates(this.getPosition(),this._rotation)}getTorchPoint(){return this.getPosition().movedByPointCoordinates(c).rotateAroundPointCoordinates(this.getPosition(),this._rotation)}takeDamage(e){this._lives-=e,se.getInstance().playSound(this._lives>0?k.PLAYER_HURT:k.PLAYER_DEAD)}hasNightVision(){return this._nightVisionTimer>0}isNightVisionFading(){return this._nightVisionTimer<2&&this._nightVisionTimer%.2<.1}update(e){this._invulnerableTimer>0&&(this._invulnerableTimer=Math.max(0,this._invulnerableTimer-e)),this._nightVisionTimer>0&&(this._nightVisionTimer=Math.max(0,this._nightVisionTimer-e))}draw(e,t){if(this.world.gameOver)return;if(!this._images[this._selectedGunType]||!this._imageDead)return;const i=this.world.worldToScreenCoordinates(this.getPosition());e.save();const n=5*this._invulnerableTimer/1,s=n-Math.floor(n)<.5,r=h.inverted();if(e.translate(i.x,i.y),this._invulnerableTimer<=0||s){this.isAlive()?this._images[this._selectedGunType]:this._imageDead;const t=this.isAlive()?64:32;e.rotate(this._rotation*Math.PI/180),e.drawImage(this.isAlive()?this._images[this._selectedGunType]:this._imageDead,r.x,r.y,t,t),e.rotate(-this._rotation*Math.PI/180)}if(e.restore(),this.world.debug){t.strokeStyle="red",t.strokeRect(-this.width/2+i.x,-this.height/2+i.y,this.width,this.height),t.fillStyle="magenta",t.beginPath(),t.arc(i.x,i.y,2,0,2*Math.PI),t.fill(),t.fillStyle="magenta";const e=this.world.worldToScreenCoordinates(this.getGunPoint());t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill(),t.fillStyle="cyan";const n=this.world.worldToScreenCoordinates(this.getTorchPoint());t.beginPath(),t.arc(n.x,n.y,2,0,2*Math.PI),t.fill()}}drawUI(e){if(this._inventoryImage&&!this.world.gameOver&&this._inventoryOpen){e.save(),e.globalAlpha=.7;const t=this._inventoryImage.width,i=this._inventoryImage.height,n=30,s=42;e.drawImage(this._inventoryImage,640-t/2,a-i-n,t,i),this._inventory&&this._inventory.forEach((r=>{if(!r.quantity)return;const l=this.world.getInventoryTexture(r.type);if(!l)return;const h=D.includes(r.type),d=(h?r.type-20:r.type)*s-s/2,c=h?s/2:1.5*s;e.drawImage(l,640-t/2+d-l.width/2,a-i-n+c-l.height/2,l.width,l.height),r.quantity>1&&(e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(640-t/2+d-s/2,a-i-n+c+s/2-16,l.width,16),e.fillStyle="white",e.font=`16px ${o}`,e.textAlign="right",e.fillText(`x${r.quantity}`,640-t/2+d+s/2-4,a-i-n+c+s/2-4)),r.type===V[this._selectedGunType]&&(e.strokeStyle="yellow",e.lineWidth=2,e.strokeRect(640-t/2+d-s/2,a-i-n+c-s/2,s,s))})),e.restore()}this.world.debug&&(e.fillStyle="white",e.font=`12px ${o}`,e.textAlign="left",e.fillText(`Collision hits: ${this._debugData.collisionHits}`,10,e.canvas.height-38),e.fillText(`Player position: ${this.getPosition()}`,10,e.canvas.height-24),e.fillText(`Rotation: ${this._rotation}`,10,e.canvas.height-10))}isAlive(){return this._lives>0}die(){}get lives(){return this._lives}recordKill(e){this._kills++,this._money+=e}isInvulnerable(){return this._invulnerableTimer>0}static fromGameState(e,t){const n=new i(t.position.x,t.position.y),s=new ae(e,n,t.rotation,t.id);return s._lives=t.lives,s._kills=t.kills,s._money=t.money,s._score=t.score,s._selectedGunType=t.selectedGunType,s._inventory=t.inventory,s._bulletsLeft=t.bulletsLeftByWeaponType[s._selectedGunType]??0,s._invulnerableTimer=t.invulnerableTimer,s._nightVisionTimer=t.nightVisionTimer,s}applyFromGameStateDelta(e){e.score&&(this._score=e.score.score,this._money=e.score.money,this._kills=e.score.kills),e.position&&(this.getPosition().setTo(e.position.x,e.position.y),this._rotation=e.position.rotation),e.lives&&(this._lives>e.lives.lives?this.takeDamage(this._lives-e.lives.lives):this._lives<e.lives.lives&&(this._lives=e.lives.lives)),this.isAlive()||this.world.endGame();const t=e.inventory?.selectedGunType??this._selectedGunType;t===this._selectedGunType&&!j.includes(this._selectedGunType)&&e.playerBullets&&this._bulletsLeft<e.playerBullets.bulletsLeftByWeaponType[this._selectedGunType]&&se.getInstance().playSound(k.PLAYER_BULLET_RECHARGE,{volume:.5});const i=e.inventory?.inventory??this._inventory;if(j.includes(t)){const e=$[t],n=i.find((t=>t.type===e));this._bulletsLeft=n?.quantity??0}else e.playerBullets&&(this._bulletsLeft=e.playerBullets.bulletsLeftByWeaponType[t]??0);this._selectedGunType=t,e.timers&&(this._invulnerableTimer=e.timers.invulnerableTimer,this._nightVisionTimer=e.timers.nightVisionTimer),e.inventory&&(this.world.isPlayerInShop()?e.inventory.inventory.forEach((e=>{const t=this._inventory.find((t=>t.type===e.type));(!t||e.quantity>t.quantity)&&se.getInstance().playSound(k.MONEY_SPENT)})):this._inventory.filter((e=>F.includes(e.type))).forEach((t=>{const i=e.inventory.inventory.find((e=>e.type===t.type));(!i||i.quantity<t.quantity)&&se.getInstance().playSound(k.BONUS_PICKUP)})),this._inventory=e.inventory.inventory)}}class oe extends te{world;_orientation;image=null;constructor(e,t,i,n,s,r){super(t,i,n,r),this.world=e,this._orientation=s,ie(w.WALL).then((e=>{this.image=e}))}get orientation(){return this._orientation}draw(e,t){if(!this.image)return;const i=this.world.worldToScreenCoordinates(this.getLeftTopCorner());t.save(),t.translate(i.x,i.y),e.save(),e.translate(i.x,i.y);let[n,s]=[this._width,this._height];if("vertical"===this._orientation&&([n,s]=[this._height,this._width]),"vertical"===this._orientation&&(e.rotate(Math.PI/2),e.translate(0,-this.width),t.rotate(Math.PI/2),t.translate(0,-this.width)),e.drawImage(this.image,0,0,n,s),this.world.debug&&(t.strokeStyle="red",t.strokeRect(0,0,n,s),t.fillStyle="white",t.font=`12px ${o}`,t.fillText(`#${this.id} ${this.getPosition()}`,2,12),t.fillText(`Width: ${this.width}, Height: ${this.height}`,2,24)),e.restore(),t.restore(),this.world.debug){const e=this.world.worldToScreenCoordinates(this.getPosition());t.fillStyle="magenta",t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill()}}getCollisionRect(){const{x:e,y:t}=this.getLeftTopCorner();return{left:e,top:t,width:this._width,height:this.height}}getLeftTopCorner(){let e=0,t=0;return"vertical"==this.orientation?e=this._width/2:t=this.height/2,this.getPosition().movedBy(-e,-t)}}class le{static instance;userData=null;authUrl=null;performingRequest=!1;_token=null;urls={login:"/auth/google/url",user:"/auth/user"};constructor(){}static getInstance(){return le.instance||(le.instance=new le),le.instance}async get(e,t={}){this.performingRequest=!0;try{const i=await fetch(s+e,{method:"GET",...t,headers:{...t.headers,Authorization:`Bearer ${this.getToken()}`}});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);return i.json()}catch(e){throw console.error("Request failed: ",e),e}finally{this.performingRequest=!1}}initToken(){let e=new URLSearchParams(window.location.search).get("token");e?(localStorage.setItem("token",e),history.pushState({},"",window.location.pathname)):e=localStorage.getItem("token"),this._token=e}getToken(){return this._token}async getAuthUrl(){const e=await this.get(this.urls.login);return this.authUrl=e.url,this.authUrl}async checkAuthStatus(){const e=await this.get(this.urls.user);return this.userData=e,e}isPerformingRequest(){return this.performingRequest}getUserData(){return this.userData}openAuthPage(){this.authUrl&&(window.location.href=this.authUrl)}}class he{static getUrl(e,t){const i=new URL(s+e);return t&&Object.entries(t).forEach((([e,t])=>{i.searchParams.append(e,t)})),i.toString()}static async request(e,t={}){const{params:i,...n}=t,s=this.getUrl(e,i),r=le.getInstance(),a=new Headers(t.headers||{});a.set("Content-Type","application/json");const o=r.getToken();o&&a.set("Authorization",`Bearer ${o}`);const l=await fetch(s,{...n,headers:a});if(!l.ok){const e=new Error;throw e.message=await l.text(),e.code=l.status,e}return l.json()}static async get(e,t={}){return this.request(e,{...t,method:"GET"})}static async post(e,t,i={}){return this.request(e,{...i,method:"POST",body:t?JSON.stringify(t):void 0})}static async patch(e,t,i={}){return this.request(e,{...i,method:"PATCH",body:JSON.stringify(t)})}static async delete(e,t={}){return this.request(e,{...t,method:"DELETE"})}}var de,ce;function ue(e,t,i){let n,s,r=i;for(let i of e.fields){let e=i.localName;if(i.oneof){const a=r[i.oneof];if(null==(null==a?void 0:a.oneofKind))continue;if(n=a[e],s=t[i.oneof],s.oneofKind=a.oneofKind,null==n){delete s[e];continue}}else if(n=r[e],s=t,null==n)continue;switch(i.repeat&&(s[e].length=n.length),i.kind){case"scalar":case"enum":if(i.repeat)for(let t=0;t<n.length;t++)s[e][t]=n[t];else s[e]=n;break;case"message":let t=i.T();if(i.repeat)for(let i=0;i<n.length;i++)s[e][i]=t.create(n[i]);else void 0===s[e]?s[e]=t.create(n):t.mergePartial(s[e],n);break;case"map":switch(i.V.kind){case"scalar":case"enum":Object.assign(s[e],n);break;case"message":let t=i.V.T();for(let i of Object.keys(n))s[e][i]=t.create(n[i])}}}}!function(e){e.symbol=Symbol.for("protobuf-ts/unknown"),e.onRead=(i,n,s,r,a)=>{(t(n)?n[e.symbol]:n[e.symbol]=[]).push({no:s,wireType:r,data:a})},e.onWrite=(t,i,n)=>{for(let{no:t,wireType:s,data:r}of e.list(i))n.tag(t,s).raw(r)},e.list=(i,n)=>{if(t(i)){let t=i[e.symbol];return n?t.filter((e=>e.no==n)):t}return[]},e.last=(t,i)=>e.list(t,i).slice(-1)[0];const t=t=>t&&Array.isArray(t[e.symbol])}(de||(de={})),function(e){e[e.Varint=0]="Varint",e[e.Bit64=1]="Bit64",e[e.LengthDelimited=2]="LengthDelimited",e[e.StartGroup=3]="StartGroup",e[e.EndGroup=4]="EndGroup",e[e.Bit32=5]="Bit32"}(ce||(ce={}));const pe=Symbol.for("protobuf-ts/message-type");function ge(e){let t=!1;const i=[];for(let n=0;n<e.length;n++){let s=e.charAt(n);"_"==s?t=!0:/\d/.test(s)?(i.push(s),t=!0):t?(i.push(s.toUpperCase()),t=!1):0==n?i.push(s.toLowerCase()):i.push(s)}return i.join("")}var ye,fe,me;function we(e){var t,i,n,s;return e.localName=null!==(t=e.localName)&&void 0!==t?t:ge(e.name),e.jsonName=null!==(i=e.jsonName)&&void 0!==i?i:ge(e.name),e.repeat=null!==(n=e.repeat)&&void 0!==n?n:me.NO,e.opt=null!==(s=e.opt)&&void 0!==s?s:!e.repeat&&!e.oneof&&"message"==e.kind,e}function be(e){if("object"!=typeof e||null===e||!e.hasOwnProperty("oneofKind"))return!1;switch(typeof e.oneofKind){case"string":return void 0!==e[e.oneofKind]&&2==Object.keys(e).length;case"undefined":return 1==Object.keys(e).length;default:return!1}}!function(e){e[e.DOUBLE=1]="DOUBLE",e[e.FLOAT=2]="FLOAT",e[e.INT64=3]="INT64",e[e.UINT64=4]="UINT64",e[e.INT32=5]="INT32",e[e.FIXED64=6]="FIXED64",e[e.FIXED32=7]="FIXED32",e[e.BOOL=8]="BOOL",e[e.STRING=9]="STRING",e[e.BYTES=12]="BYTES",e[e.UINT32=13]="UINT32",e[e.SFIXED32=15]="SFIXED32",e[e.SFIXED64=16]="SFIXED64",e[e.SINT32=17]="SINT32",e[e.SINT64=18]="SINT64"}(ye||(ye={})),function(e){e[e.BIGINT=0]="BIGINT",e[e.STRING=1]="STRING",e[e.NUMBER=2]="NUMBER"}(fe||(fe={})),function(e){e[e.NO=0]="NO",e[e.PACKED=1]="PACKED",e[e.UNPACKED=2]="UNPACKED"}(me||(me={}));class ke{constructor(e){var t;this.fields=null!==(t=e.fields)&&void 0!==t?t:[]}prepare(){if(this.data)return;const e=[],t=[],i=[];for(let n of this.fields)if(n.oneof)i.includes(n.oneof)||(i.push(n.oneof),e.push(n.oneof),t.push(n.oneof));else switch(t.push(n.localName),n.kind){case"scalar":case"enum":n.opt&&!n.repeat||e.push(n.localName);break;case"message":n.repeat&&e.push(n.localName);break;case"map":e.push(n.localName)}this.data={req:e,known:t,oneofs:Object.values(i)}}is(e,t,i=!1){if(t<0)return!0;if(null==e||"object"!=typeof e)return!1;this.prepare();let n=Object.keys(e),s=this.data;if(n.length<s.req.length||s.req.some((e=>!n.includes(e))))return!1;if(!i&&n.some((e=>!s.known.includes(e))))return!1;if(t<1)return!0;for(const n of s.oneofs){const s=e[n];if(!be(s))return!1;if(void 0===s.oneofKind)continue;const r=this.fields.find((e=>e.localName===s.oneofKind));if(!r)return!1;if(!this.field(s[s.oneofKind],r,i,t))return!1}for(const n of this.fields)if(void 0===n.oneof&&!this.field(e[n.localName],n,i,t))return!1;return!0}field(e,t,i,n){let s=t.repeat;switch(t.kind){case"scalar":return void 0===e?t.opt:s?this.scalars(e,t.T,n,t.L):this.scalar(e,t.T,t.L);case"enum":return void 0===e?t.opt:s?this.scalars(e,ye.INT32,n):this.scalar(e,ye.INT32);case"message":return void 0===e||(s?this.messages(e,t.T(),i,n):this.message(e,t.T(),i,n));case"map":if("object"!=typeof e||null===e)return!1;if(n<2)return!0;if(!this.mapKeys(e,t.K,n))return!1;switch(t.V.kind){case"scalar":return this.scalars(Object.values(e),t.V.T,n,t.V.L);case"enum":return this.scalars(Object.values(e),ye.INT32,n);case"message":return this.messages(Object.values(e),t.V.T(),i,n)}}return!0}message(e,t,i,n){return i?t.isAssignable(e,n):t.is(e,n)}messages(e,t,i,n){if(!Array.isArray(e))return!1;if(n<2)return!0;if(i){for(let i=0;i<e.length&&i<n;i++)if(!t.isAssignable(e[i],n-1))return!1}else for(let i=0;i<e.length&&i<n;i++)if(!t.is(e[i],n-1))return!1;return!0}scalar(e,t,i){let n=typeof e;switch(t){case ye.UINT64:case ye.FIXED64:case ye.INT64:case ye.SFIXED64:case ye.SINT64:switch(i){case fe.BIGINT:return"bigint"==n;case fe.NUMBER:return"number"==n&&!isNaN(e);default:return"string"==n}case ye.BOOL:return"boolean"==n;case ye.STRING:return"string"==n;case ye.BYTES:return e instanceof Uint8Array;case ye.DOUBLE:case ye.FLOAT:return"number"==n&&!isNaN(e);default:return"number"==n&&Number.isInteger(e)}}scalars(e,t,i,n){if(!Array.isArray(e))return!1;if(i<2)return!0;if(Array.isArray(e))for(let s=0;s<e.length&&s<i;s++)if(!this.scalar(e[s],t,n))return!1;return!0}mapKeys(e,t,i){let n=Object.keys(e);switch(t){case ye.INT32:case ye.FIXED32:case ye.SFIXED32:case ye.SINT32:case ye.UINT32:return this.scalars(n.slice(0,i).map((e=>parseInt(e))),t,i);case ye.BOOL:return this.scalars(n.slice(0,i).map((e=>"true"==e||"false"!=e&&e)),t,i);default:return this.scalars(n,t,i,fe.STRING)}}}function Te(e){let t=typeof e;if("object"==t){if(Array.isArray(e))return"array";if(null===e)return"null"}return t}let _e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),ve=[];for(let e=0;e<_e.length;e++)ve[_e[e].charCodeAt(0)]=e;function Se(){let e=0,t=0;for(let i=0;i<28;i+=7){let n=this.buf[this.pos++];if(e|=(127&n)<<i,!(128&n))return this.assertBounds(),[e,t]}let i=this.buf[this.pos++];if(e|=(15&i)<<28,t=(112&i)>>4,!(128&i))return this.assertBounds(),[e,t];for(let i=3;i<=31;i+=7){let n=this.buf[this.pos++];if(t|=(127&n)<<i,!(128&n))return this.assertBounds(),[e,t]}throw new Error("invalid varint")}function Ee(e,t,i){for(let n=0;n<28;n+=7){const s=e>>>n,r=!(s>>>7==0&&0==t),a=255&(r?128|s:s);if(i.push(a),!r)return}const n=e>>>28&15|(7&t)<<4,s=!!(t>>3);if(i.push(255&(s?128|n:n)),s){for(let e=3;e<31;e+=7){const n=t>>>e,s=!(n>>>7==0),r=255&(s?128|n:n);if(i.push(r),!s)return}i.push(t>>>31&1)}}ve["-".charCodeAt(0)]=_e.indexOf("+"),ve["_".charCodeAt(0)]=_e.indexOf("/");const Ie=4294967296;function Be(e){let t="-"==e[0];t&&(e=e.slice(1));const i=1e6;let n=0,s=0;function r(t,r){const a=Number(e.slice(t,r));s*=i,n=n*i+a,n>=Ie&&(s+=n/Ie|0,n%=Ie)}return r(-24,-18),r(-18,-12),r(-12,-6),r(-6),[t,n,s]}function Ne(e,t){if(t>>>0<=2097151)return""+(Ie*t+(e>>>0));let i=(e>>>24|t<<8)>>>0&16777215,n=t>>16&65535,s=(16777215&e)+6777216*i+6710656*n,r=i+8147497*n,a=2*n,o=1e7;function l(e,t){let i=e?String(e):"";return t?"0000000".slice(i.length)+i:i}return s>=o&&(r+=Math.floor(s/o),s%=o),r>=o&&(a+=Math.floor(r/o),r%=o),l(a,0)+l(r,a)+l(s,1)}function Re(e,t){if(e>=0){for(;e>127;)t.push(127&e|128),e>>>=7;t.push(e)}else{for(let i=0;i<9;i++)t.push(127&e|128),e>>=7;t.push(1)}}function Pe(){let e=this.buf[this.pos++],t=127&e;if(!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<7,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<14,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<21,!(128&e))return this.assertBounds(),t;e=this.buf[this.pos++],t|=(15&e)<<28;for(let t=5;128&e&&t<10;t++)e=this.buf[this.pos++];if(128&e)throw new Error("invalid varint");return this.assertBounds(),t>>>0}let Le;function Oe(e){if(!e)throw new Error("BigInt unavailable, see https://github.com/timostamm/protobuf-ts/blob/v1.0.8/MANUAL.md#bigint-support")}!function(){const e=new DataView(new ArrayBuffer(8)),t=void 0!==globalThis.BigInt&&"function"==typeof e.getBigInt64&&"function"==typeof e.getBigUint64&&"function"==typeof e.setBigInt64&&"function"==typeof e.setBigUint64;Le=t?{MIN:BigInt("-9223372036854775808"),MAX:BigInt("9223372036854775807"),UMIN:BigInt("0"),UMAX:BigInt("18446744073709551615"),C:BigInt,V:e}:void 0}();const xe=/^-?[0-9]+$/,Ae=4294967296,Ue=2147483648;class De{constructor(e,t){this.lo=0|e,this.hi=0|t}isZero(){return 0==this.lo&&0==this.hi}toNumber(){let e=this.hi*Ae+(this.lo>>>0);if(!Number.isSafeInteger(e))throw new Error("cannot convert to safe number");return e}}class Me extends De{static from(e){if(Le)switch(typeof e){case"string":if("0"==e)return this.ZERO;if(""==e)throw new Error("string is no integer");e=Le.C(e);case"number":if(0===e)return this.ZERO;e=Le.C(e);case"bigint":if(!e)return this.ZERO;if(e<Le.UMIN)throw new Error("signed value for ulong");if(e>Le.UMAX)throw new Error("ulong too large");return Le.V.setBigUint64(0,e,!0),new Me(Le.V.getInt32(0,!0),Le.V.getInt32(4,!0))}else switch(typeof e){case"string":if("0"==e)return this.ZERO;if(e=e.trim(),!xe.test(e))throw new Error("string is no integer");let[t,i,n]=Be(e);if(t)throw new Error("signed value for ulong");return new Me(i,n);case"number":if(0==e)return this.ZERO;if(!Number.isSafeInteger(e))throw new Error("number is no integer");if(e<0)throw new Error("signed value for ulong");return new Me(e,e/Ae)}throw new Error("unknown value "+typeof e)}toString(){return Le?this.toBigInt().toString():Ne(this.lo,this.hi)}toBigInt(){return Oe(Le),Le.V.setInt32(0,this.lo,!0),Le.V.setInt32(4,this.hi,!0),Le.V.getBigUint64(0,!0)}}Me.ZERO=new Me(0,0);class Ce extends De{static from(e){if(Le)switch(typeof e){case"string":if("0"==e)return this.ZERO;if(""==e)throw new Error("string is no integer");e=Le.C(e);case"number":if(0===e)return this.ZERO;e=Le.C(e);case"bigint":if(!e)return this.ZERO;if(e<Le.MIN)throw new Error("signed long too small");if(e>Le.MAX)throw new Error("signed long too large");return Le.V.setBigInt64(0,e,!0),new Ce(Le.V.getInt32(0,!0),Le.V.getInt32(4,!0))}else switch(typeof e){case"string":if("0"==e)return this.ZERO;if(e=e.trim(),!xe.test(e))throw new Error("string is no integer");let[t,i,n]=Be(e);if(t){if(n>Ue||n==Ue&&0!=i)throw new Error("signed long too small")}else if(n>=Ue)throw new Error("signed long too large");let s=new Ce(i,n);return t?s.negate():s;case"number":if(0==e)return this.ZERO;if(!Number.isSafeInteger(e))throw new Error("number is no integer");return e>0?new Ce(e,e/Ae):new Ce(-e,-e/Ae).negate()}throw new Error("unknown value "+typeof e)}isNegative(){return!!(this.hi&Ue)}negate(){let e=~this.hi,t=this.lo;return t?t=1+~t:e+=1,new Ce(t,e)}toString(){if(Le)return this.toBigInt().toString();if(this.isNegative()){let e=this.negate();return"-"+Ne(e.lo,e.hi)}return Ne(this.lo,this.hi)}toBigInt(){return Oe(Le),Le.V.setInt32(0,this.lo,!0),Le.V.setInt32(4,this.hi,!0),Le.V.getBigInt64(0,!0)}}function je(e,t){if(!e)throw new Error(t)}function $e(e){if("number"!=typeof e)throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>2147483647||e<-2147483648)throw new Error("invalid int 32: "+e)}function Ve(e){if("number"!=typeof e)throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>4294967295||e<0)throw new Error("invalid uint 32: "+e)}function Fe(e){if("number"!=typeof e)throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>34028234663852886e22||e<-34028234663852886e22))throw new Error("invalid float 32: "+e)}function We(e,t){switch(t){case fe.BIGINT:return e.toBigInt();case fe.NUMBER:return e.toNumber();default:return e.toString()}}Ce.ZERO=new Ce(0,0);class Ge{constructor(e){this.info=e}prepare(){var e;if(void 0===this.fMap){this.fMap={};const t=null!==(e=this.info.fields)&&void 0!==e?e:[];for(const e of t)this.fMap[e.name]=e,this.fMap[e.jsonName]=e,this.fMap[e.localName]=e}}assert(e,t,i){if(!e){let e=Te(i);throw"number"!=e&&"boolean"!=e||(e=i.toString()),new Error(`Cannot parse JSON ${e} for ${this.info.typeName}#${t}`)}}read(e,t,i){this.prepare();const n=[];for(const[r,a]of Object.entries(e)){const e=this.fMap[r];if(!e){if(!i.ignoreUnknownFields)throw new Error(`Found unknown field while reading ${this.info.typeName} from JSON format. JSON key: ${r}`);continue}const o=e.localName;let l;if(e.oneof){if(null===a&&("enum"!==e.kind||"google.protobuf.NullValue"!==e.T()[0]))continue;if(n.includes(e.oneof))throw new Error(`Multiple members of the oneof group "${e.oneof}" of ${this.info.typeName} are present in JSON.`);n.push(e.oneof),l=t[e.oneof]={oneofKind:o}}else l=t;if("map"==e.kind){if(null===a)continue;this.assert(null!==(s=a)&&"object"==typeof s&&!Array.isArray(s),e.name,a);const t=l[o];for(const[n,s]of Object.entries(a)){let r;switch(this.assert(null!==s,e.name+" map value",null),e.V.kind){case"message":r=e.V.T().internalJsonRead(s,i);break;case"enum":if(r=this.enum(e.V.T(),s,e.name,i.ignoreUnknownFields),!1===r)continue;break;case"scalar":r=this.scalar(s,e.V.T,e.V.L,e.name)}this.assert(void 0!==r,e.name+" map value",s);let a=n;e.K==ye.BOOL&&(a="true"==a||"false"!=a&&a),a=this.scalar(a,e.K,fe.STRING,e.name).toString(),t[a]=r}}else if(e.repeat){if(null===a)continue;this.assert(Array.isArray(a),e.name,a);const t=l[o];for(const n of a){let s;switch(this.assert(null!==n,e.name,null),e.kind){case"message":s=e.T().internalJsonRead(n,i);break;case"enum":if(s=this.enum(e.T(),n,e.name,i.ignoreUnknownFields),!1===s)continue;break;case"scalar":s=this.scalar(n,e.T,e.L,e.name)}this.assert(void 0!==s,e.name,a),t.push(s)}}else switch(e.kind){case"message":if(null===a&&"google.protobuf.Value"!=e.T().typeName){this.assert(void 0===e.oneof,e.name+" (oneof member)",null);continue}l[o]=e.T().internalJsonRead(a,i,l[o]);break;case"enum":if(null===a)continue;let t=this.enum(e.T(),a,e.name,i.ignoreUnknownFields);if(!1===t)continue;l[o]=t;break;case"scalar":if(null===a)continue;l[o]=this.scalar(a,e.T,e.L,e.name)}}var s}enum(e,t,i,n){if("google.protobuf.NullValue"==e[0]&&je(null===t||"NULL_VALUE"===t,`Unable to parse field ${this.info.typeName}#${i}, enum ${e[0]} only accepts null.`),null===t)return 0;switch(typeof t){case"number":return je(Number.isInteger(t),`Unable to parse field ${this.info.typeName}#${i}, enum can only be integral number, got ${t}.`),t;case"string":let s=t;e[2]&&t.substring(0,e[2].length)===e[2]&&(s=t.substring(e[2].length));let r=e[1][s];return(void 0!==r||!n)&&(je("number"==typeof r,`Unable to parse field ${this.info.typeName}#${i}, enum ${e[0]} has no value for "${t}".`),r)}je(!1,`Unable to parse field ${this.info.typeName}#${i}, cannot parse enum value from ${typeof t}".`)}scalar(e,t,i,n){let s;try{switch(t){case ye.DOUBLE:case ye.FLOAT:if(null===e)return 0;if("NaN"===e)return Number.NaN;if("Infinity"===e)return Number.POSITIVE_INFINITY;if("-Infinity"===e)return Number.NEGATIVE_INFINITY;if(""===e){s="empty string";break}if("string"==typeof e&&e.trim().length!==e.length){s="extra whitespace";break}if("string"!=typeof e&&"number"!=typeof e)break;let n=Number(e);if(Number.isNaN(n)){s="not a number";break}if(!Number.isFinite(n)){s="too large or small";break}return t==ye.FLOAT&&Fe(n),n;case ye.INT32:case ye.FIXED32:case ye.SFIXED32:case ye.SINT32:case ye.UINT32:if(null===e)return 0;let r;if("number"==typeof e?r=e:""===e?s="empty string":"string"==typeof e&&(e.trim().length!==e.length?s="extra whitespace":r=Number(e)),void 0===r)break;return t==ye.UINT32?Ve(r):$e(r),r;case ye.INT64:case ye.SFIXED64:case ye.SINT64:if(null===e)return We(Ce.ZERO,i);if("number"!=typeof e&&"string"!=typeof e)break;return We(Ce.from(e),i);case ye.FIXED64:case ye.UINT64:if(null===e)return We(Me.ZERO,i);if("number"!=typeof e&&"string"!=typeof e)break;return We(Me.from(e),i);case ye.BOOL:if(null===e)return!1;if("boolean"!=typeof e)break;return e;case ye.STRING:if(null===e)return"";if("string"!=typeof e){s="extra whitespace";break}try{encodeURIComponent(e)}catch(s){s="invalid UTF8";break}return e;case ye.BYTES:if(null===e||""===e)return new Uint8Array(0);if("string"!=typeof e)break;return function(e){let t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);let i,n=new Uint8Array(t),s=0,r=0,a=0;for(let t=0;t<e.length;t++){if(i=ve[e.charCodeAt(t)],void 0===i)switch(e[t]){case"=":r=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:a=i,r=1;break;case 1:n[s++]=a<<2|(48&i)>>4,a=i,r=2;break;case 2:n[s++]=(15&a)<<4|(60&i)>>2,a=i,r=3;break;case 3:n[s++]=(3&a)<<6|i,r=0}}if(1==r)throw Error("invalid base64 string.");return n.subarray(0,s)}(e)}}catch(e){s=e.message}this.assert(!1,n+(s?" - "+s:""),e)}}class Ke{constructor(e){var t;this.fields=null!==(t=e.fields)&&void 0!==t?t:[]}write(e,t){const i={},n=e;for(const e of this.fields){if(!e.oneof){let s=this.field(e,n[e.localName],t);void 0!==s&&(i[t.useProtoFieldName?e.name:e.jsonName]=s);continue}const s=n[e.oneof];if(s.oneofKind!==e.localName)continue;const r="scalar"==e.kind||"enum"==e.kind?Object.assign(Object.assign({},t),{emitDefaultValues:!0}):t;let a=this.field(e,s[e.localName],r);je(void 0!==a),i[t.useProtoFieldName?e.name:e.jsonName]=a}return i}field(e,t,i){let n;if("map"==e.kind){je("object"==typeof t&&null!==t);const s={};switch(e.V.kind){case"scalar":for(const[i,n]of Object.entries(t)){const t=this.scalar(e.V.T,n,e.name,!1,!0);je(void 0!==t),s[i.toString()]=t}break;case"message":const n=e.V.T();for(const[r,a]of Object.entries(t)){const t=this.message(n,a,e.name,i);je(void 0!==t),s[r.toString()]=t}break;case"enum":const r=e.V.T();for(const[n,a]of Object.entries(t)){je(void 0===a||"number"==typeof a);const t=this.enum(r,a,e.name,!1,!0,i.enumAsInteger);je(void 0!==t),s[n.toString()]=t}}(i.emitDefaultValues||Object.keys(s).length>0)&&(n=s)}else if(e.repeat){je(Array.isArray(t));const s=[];switch(e.kind){case"scalar":for(let i=0;i<t.length;i++){const n=this.scalar(e.T,t[i],e.name,e.opt,!0);je(void 0!==n),s.push(n)}break;case"enum":const n=e.T();for(let r=0;r<t.length;r++){je(void 0===t[r]||"number"==typeof t[r]);const a=this.enum(n,t[r],e.name,e.opt,!0,i.enumAsInteger);je(void 0!==a),s.push(a)}break;case"message":const r=e.T();for(let n=0;n<t.length;n++){const a=this.message(r,t[n],e.name,i);je(void 0!==a),s.push(a)}}(i.emitDefaultValues||s.length>0||i.emitDefaultValues)&&(n=s)}else switch(e.kind){case"scalar":n=this.scalar(e.T,t,e.name,e.opt,i.emitDefaultValues);break;case"enum":n=this.enum(e.T(),t,e.name,e.opt,i.emitDefaultValues,i.enumAsInteger);break;case"message":n=this.message(e.T(),t,e.name,i)}return n}enum(e,t,i,n,s,r){if("google.protobuf.NullValue"==e[0])return s||n?null:void 0;if(void 0!==t){if(0!==t||s||n)return je("number"==typeof t),je(Number.isInteger(t)),r||!e[1].hasOwnProperty(t)?t:e[2]?e[2]+e[1][t]:e[1][t]}else je(n)}message(e,t,i,n){return void 0===t?n.emitDefaultValues?null:void 0:e.internalJsonWrite(t,n)}scalar(e,t,i,n,s){if(void 0===t)return void je(n);const r=s||n;switch(e){case ye.INT32:case ye.SFIXED32:case ye.SINT32:return 0===t?r?0:void 0:($e(t),t);case ye.FIXED32:case ye.UINT32:return 0===t?r?0:void 0:(Ve(t),t);case ye.FLOAT:Fe(t);case ye.DOUBLE:return 0===t?r?0:void 0:(je("number"==typeof t),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t);case ye.STRING:return""===t?r?"":void 0:(je("string"==typeof t),t);case ye.BOOL:return!1===t?!r&&void 0:(je("boolean"==typeof t),t);case ye.UINT64:case ye.FIXED64:je("number"==typeof t||"string"==typeof t||"bigint"==typeof t);let e=Me.from(t);if(e.isZero()&&!r)return;return e.toString();case ye.INT64:case ye.SFIXED64:case ye.SINT64:je("number"==typeof t||"string"==typeof t||"bigint"==typeof t);let i=Ce.from(t);if(i.isZero()&&!r)return;return i.toString();case ye.BYTES:return je(t instanceof Uint8Array),t.byteLength?function(e){let t,i="",n=0,s=0;for(let r=0;r<e.length;r++)switch(t=e[r],n){case 0:i+=_e[t>>2],s=(3&t)<<4,n=1;break;case 1:i+=_e[s|t>>4],s=(15&t)<<2,n=2;break;case 2:i+=_e[s|t>>6],i+=_e[63&t],n=0}return n&&(i+=_e[s],i+="=",1==n&&(i+="=")),i}(t):r?"":void 0}}}function He(e,t=fe.STRING){switch(e){case ye.BOOL:return!1;case ye.UINT64:case ye.FIXED64:return We(Me.ZERO,t);case ye.INT64:case ye.SFIXED64:case ye.SINT64:return We(Ce.ZERO,t);case ye.DOUBLE:case ye.FLOAT:return 0;case ye.BYTES:return new Uint8Array(0);case ye.STRING:return"";default:return 0}}class Ye{constructor(e){this.info=e}prepare(){var e;if(!this.fieldNoToField){const t=null!==(e=this.info.fields)&&void 0!==e?e:[];this.fieldNoToField=new Map(t.map((e=>[e.no,e])))}}read(e,t,i,n){this.prepare();const s=void 0===n?e.len:e.pos+n;for(;e.pos<s;){const[n,s]=e.tag(),r=this.fieldNoToField.get(n);if(!r){let r=i.readUnknownField;if("throw"==r)throw new Error(`Unknown field ${n} (wire type ${s}) for ${this.info.typeName}`);let a=e.skip(s);!1!==r&&(!0===r?de.onRead:r)(this.info.typeName,t,n,s,a);continue}let a=t,o=r.repeat,l=r.localName;switch(r.oneof&&(a=a[r.oneof],a.oneofKind!==l&&(a=t[r.oneof]={oneofKind:l})),r.kind){case"scalar":case"enum":let t="enum"==r.kind?ye.INT32:r.T,n="scalar"==r.kind?r.L:void 0;if(o){let i=a[l];if(s==ce.LengthDelimited&&t!=ye.STRING&&t!=ye.BYTES){let s=e.uint32()+e.pos;for(;e.pos<s;)i.push(this.scalar(e,t,n))}else i.push(this.scalar(e,t,n))}else a[l]=this.scalar(e,t,n);break;case"message":if(o){let t=a[l],n=r.T().internalBinaryRead(e,e.uint32(),i);t.push(n)}else a[l]=r.T().internalBinaryRead(e,e.uint32(),i,a[l]);break;case"map":let[h,d]=this.mapEntry(r,e,i);a[l][h]=d}}}mapEntry(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[r,a]=t.tag();switch(r){case 1:n=e.K==ye.BOOL?t.bool().toString():this.scalar(t,e.K,fe.STRING);break;case 2:switch(e.V.kind){case"scalar":s=this.scalar(t,e.V.T,e.V.L);break;case"enum":s=t.int32();break;case"message":s=e.V.T().internalBinaryRead(t,t.uint32(),i)}break;default:throw new Error(`Unknown field ${r} (wire type ${a}) in map entry for ${this.info.typeName}#${e.name}`)}}if(void 0===n){let t=He(e.K);n=e.K==ye.BOOL?t.toString():t}if(void 0===s)switch(e.V.kind){case"scalar":s=He(e.V.T,e.V.L);break;case"enum":s=0;break;case"message":s=e.V.T().create()}return[n,s]}scalar(e,t,i){switch(t){case ye.INT32:return e.int32();case ye.STRING:return e.string();case ye.BOOL:return e.bool();case ye.DOUBLE:return e.double();case ye.FLOAT:return e.float();case ye.INT64:return We(e.int64(),i);case ye.UINT64:return We(e.uint64(),i);case ye.FIXED64:return We(e.fixed64(),i);case ye.FIXED32:return e.fixed32();case ye.BYTES:return e.bytes();case ye.UINT32:return e.uint32();case ye.SFIXED32:return e.sfixed32();case ye.SFIXED64:return We(e.sfixed64(),i);case ye.SINT32:return e.sint32();case ye.SINT64:return We(e.sint64(),i)}}}class qe{constructor(e){this.info=e}prepare(){if(!this.fields){const e=this.info.fields?this.info.fields.concat():[];this.fields=e.sort(((e,t)=>e.no-t.no))}}write(e,t,i){this.prepare();for(const n of this.fields){let s,r,a=n.repeat,o=n.localName;if(n.oneof){const t=e[n.oneof];if(t.oneofKind!==o)continue;s=t[o],r=!0}else s=e[o],r=!1;switch(n.kind){case"scalar":case"enum":let e="enum"==n.kind?ye.INT32:n.T;if(a)if(je(Array.isArray(s)),a==me.PACKED)this.packed(t,e,n.no,s);else for(const i of s)this.scalar(t,e,n.no,i,!0);else void 0===s?je(n.opt):this.scalar(t,e,n.no,s,r||n.opt);break;case"message":if(a){je(Array.isArray(s));for(const e of s)this.message(t,i,n.T(),n.no,e)}else this.message(t,i,n.T(),n.no,s);break;case"map":je("object"==typeof s&&null!==s);for(const[e,r]of Object.entries(s))this.mapEntry(t,i,n,e,r)}}let n=i.writeUnknownFields;!1!==n&&(!0===n?de.onWrite:n)(this.info.typeName,e,t)}mapEntry(e,t,i,n,s){e.tag(i.no,ce.LengthDelimited),e.fork();let r=n;switch(i.K){case ye.INT32:case ye.FIXED32:case ye.UINT32:case ye.SFIXED32:case ye.SINT32:r=Number.parseInt(n);break;case ye.BOOL:je("true"==n||"false"==n),r="true"==n}switch(this.scalar(e,i.K,1,r,!0),i.V.kind){case"scalar":this.scalar(e,i.V.T,2,s,!0);break;case"enum":this.scalar(e,ye.INT32,2,s,!0);break;case"message":this.message(e,t,i.V.T(),2,s)}e.join()}message(e,t,i,n,s){void 0!==s&&(i.internalBinaryWrite(s,e.tag(n,ce.LengthDelimited).fork(),t),e.join())}scalar(e,t,i,n,s){let[r,a,o]=this.scalarInfo(t,n);o&&!s||(e.tag(i,r),e[a](n))}packed(e,t,i,n){if(!n.length)return;je(t!==ye.BYTES&&t!==ye.STRING),e.tag(i,ce.LengthDelimited),e.fork();let[,s]=this.scalarInfo(t);for(let t=0;t<n.length;t++)e[s](n[t]);e.join()}scalarInfo(e,t){let i,n=ce.Varint,s=void 0===t,r=0===t;switch(e){case ye.INT32:i="int32";break;case ye.STRING:r=s||!t.length,n=ce.LengthDelimited,i="string";break;case ye.BOOL:r=!1===t,i="bool";break;case ye.UINT32:i="uint32";break;case ye.DOUBLE:n=ce.Bit64,i="double";break;case ye.FLOAT:n=ce.Bit32,i="float";break;case ye.INT64:r=s||Ce.from(t).isZero(),i="int64";break;case ye.UINT64:r=s||Me.from(t).isZero(),i="uint64";break;case ye.FIXED64:r=s||Me.from(t).isZero(),n=ce.Bit64,i="fixed64";break;case ye.BYTES:r=s||!t.byteLength,n=ce.LengthDelimited,i="bytes";break;case ye.FIXED32:n=ce.Bit32,i="fixed32";break;case ye.SFIXED32:n=ce.Bit32,i="sfixed32";break;case ye.SFIXED64:r=s||Ce.from(t).isZero(),n=ce.Bit64,i="sfixed64";break;case ye.SINT32:i="sint32";break;case ye.SINT64:r=s||Ce.from(t).isZero(),i="sint64"}return[n,i,s||r]}}const Je={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0},Xe={ignoreUnknownFields:!1},Ze=Object.values;function ze(e,t,i){if(t===i)return!0;if(e!==ye.BYTES)return!1;let n=t,s=i;if(n.length!==s.length)return!1;for(let e=0;e<n.length;e++)if(n[e]!=s[e])return!1;return!0}function Qe(e,t,i){if(t.length!==i.length)return!1;for(let n=0;n<t.length;n++)if(!ze(e,t[n],i[n]))return!1;return!0}function et(e,t,i){if(t.length!==i.length)return!1;for(let n=0;n<t.length;n++)if(!e.equals(t[n],i[n]))return!1;return!0}const tt={writeUnknownFields:!0,writerFactory:()=>new it};class it{constructor(e){this.stack=[],this.textEncoder=null!=e?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let t=0;t<this.chunks.length;t++)e+=this.chunks[t].length;let t=new Uint8Array(e),i=0;for(let e=0;e<this.chunks.length;e++)t.set(this.chunks[e],i),i+=this.chunks[e].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(Ve(e);e>127;)this.buf.push(127&e|128),e>>>=7;return this.buf.push(e),this}int32(e){return $e(e),Re(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){Fe(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){Ve(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){$e(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return $e(e),Re(e=(e<<1^e>>31)>>>0,this.buf),this}sfixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),n=Ce.from(e);return i.setInt32(0,n.lo,!0),i.setInt32(4,n.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),i=new DataView(t.buffer),n=Me.from(e);return i.setInt32(0,n.lo,!0),i.setInt32(4,n.hi,!0),this.raw(t)}int64(e){let t=Ce.from(e);return Ee(t.lo,t.hi,this.buf),this}sint64(e){let t=Ce.from(e),i=t.hi>>31;return Ee(t.lo<<1^i,(t.hi<<1|t.lo>>>31)^i,this.buf),this}uint64(e){let t=Me.from(e);return Ee(t.lo,t.hi,this.buf),this}}const nt={readUnknownField:!0,readerFactory:e=>new st(e)};class st{constructor(e,t){this.varint64=Se,this.uint32=Pe,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=null!=t?t:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0})}tag(){let e=this.uint32(),t=e>>>3,i=7&e;if(t<=0||i<0||i>5)throw new Error("illegal tag: field no "+t+" wire type "+i);return[t,i]}skip(e){let t=this.pos;switch(e){case ce.Varint:for(;128&this.buf[this.pos++];);break;case ce.Bit64:this.pos+=4;case ce.Bit32:this.pos+=4;break;case ce.LengthDelimited:let t=this.uint32();this.pos+=t;break;case ce.StartGroup:let i;for(;(i=this.tag()[1])!==ce.EndGroup;)this.skip(i);break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(t,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}int64(){return new Ce(...this.varint64())}uint64(){return new Me(...this.varint64())}sint64(){let[e,t]=this.varint64(),i=-(1&e);return e=(e>>>1|(1&t)<<31)^i,t=t>>>1^i,new Ce(e,t)}bool(){let[e,t]=this.varint64();return 0!==e||0!==t}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return new Me(this.sfixed32(),this.sfixed32())}sfixed64(){return new Ce(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}const rt=Object.getOwnPropertyDescriptors(Object.getPrototypeOf({})),at=rt[pe]={};class ot{constructor(e,t,i){this.defaultCheckDepth=16,this.typeName=e,this.fields=t.map(we),this.options=null!=i?i:{},at.value=this,this.messagePrototype=Object.create(null,rt),this.refTypeCheck=new ke(this),this.refJsonReader=new Ge(this),this.refJsonWriter=new Ke(this),this.refBinReader=new Ye(this),this.refBinWriter=new qe(this)}create(e){let t=function(e){const t=e.messagePrototype?Object.create(e.messagePrototype):Object.defineProperty({},pe,{value:e});for(let i of e.fields){let e=i.localName;if(!i.opt)if(i.oneof)t[i.oneof]={oneofKind:void 0};else if(i.repeat)t[e]=[];else switch(i.kind){case"scalar":t[e]=He(i.T,i.L);break;case"enum":t[e]=0;break;case"map":t[e]={}}}return t}(this);return void 0!==e&&ue(this,t,e),t}clone(e){let t=this.create();return ue(this,t,e),t}equals(e,t){return function(e,t,i){if(t===i)return!0;if(!t||!i)return!1;for(let n of e.fields){let e=n.localName,s=n.oneof?t[n.oneof][e]:t[e],r=n.oneof?i[n.oneof][e]:i[e];switch(n.kind){case"enum":case"scalar":let e="enum"==n.kind?ye.INT32:n.T;if(!(n.repeat?Qe(e,s,r):ze(e,s,r)))return!1;break;case"map":if(!("message"==n.V.kind?et(n.V.T(),Ze(s),Ze(r)):Qe("enum"==n.V.kind?ye.INT32:n.V.T,Ze(s),Ze(r))))return!1;break;case"message":let t=n.T();if(!(n.repeat?et(t,s,r):t.equals(s,r)))return!1}}return!0}(this,e,t)}is(e,t=this.defaultCheckDepth){return this.refTypeCheck.is(e,t,!1)}isAssignable(e,t=this.defaultCheckDepth){return this.refTypeCheck.is(e,t,!0)}mergePartial(e,t){ue(this,e,t)}fromBinary(e,t){let i=function(e){return e?Object.assign(Object.assign({},nt),e):nt}(t);return this.internalBinaryRead(i.readerFactory(e),e.byteLength,i)}fromJson(e,t){return this.internalJsonRead(e,function(e){return e?Object.assign(Object.assign({},Xe),e):Xe}(t))}fromJsonString(e,t){let i=JSON.parse(e);return this.fromJson(i,t)}toJson(e,t){return this.internalJsonWrite(e,function(e){return e?Object.assign(Object.assign({},Je),e):Je}(t))}toJsonString(e,t){var i;let n=this.toJson(e,t);return JSON.stringify(n,null,null!==(i=null==t?void 0:t.prettySpaces)&&void 0!==i?i:0)}toBinary(e,t){let i=function(e){return e?Object.assign(Object.assign({},tt),e):tt}(t);return this.internalBinaryWrite(e,i.writerFactory(),i).finish()}internalJsonRead(e,t,i){if(null!==e&&"object"==typeof e&&!Array.isArray(e)){let n=null!=i?i:this.create();return this.refJsonReader.read(e,n,t),n}throw new Error(`Unable to parse message ${this.typeName} from JSON ${Te(e)}.`)}internalJsonWrite(e,t){return this.refJsonWriter.write(e,t)}internalBinaryWrite(e,t,i){return this.refBinWriter.write(e,t,i),t}internalBinaryRead(e,t,i,n){let s=null!=n?n:this.create();return this.refBinReader.read(e,s,i,t),s}}var lt;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.INPUT=2]="INPUT",e[e.GAME_STATE=5]="GAME_STATE",e[e.GAME_STATE_DELTA=11]="GAME_STATE_DELTA",e[e.PLAYER_JOIN=6]="PLAYER_JOIN",e[e.PLAYER_LEAVE=7]="PLAYER_LEAVE",e[e.PLAYER_RESPAWN=8]="PLAYER_RESPAWN",e[e.ERROR=10]="ERROR"}(lt||(lt={}));const ht=new class extends ot{constructor(){super("protocol.Vector2",[{no:1,name:"x",kind:"scalar",T:1},{no:2,name:"y",kind:"scalar",T:1}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.x=0,t.y=0,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.x=e.double();break;case 2:s.y=e.double();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){0!==e.x&&t.tag(1,ce.Bit64).double(e.x),0!==e.y&&t.tag(2,ce.Bit64).double(e.y);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},dt=new class extends ot{constructor(){super("protocol.InventoryItem",[{no:1,name:"type",kind:"scalar",T:5},{no:2,name:"quantity",kind:"scalar",T:5}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.type=0,t.quantity=0,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.type=e.int32();break;case 2:s.quantity=e.int32();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){0!==e.type&&t.tag(1,ce.Varint).int32(e.type),0!==e.quantity&&t.tag(2,ce.Varint).int32(e.quantity);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},ct=new class extends ot{constructor(){super("protocol.Player",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"position",kind:"message",T:()=>ht},{no:4,name:"velocity",kind:"message",T:()=>ht},{no:5,name:"lives",kind:"scalar",T:2},{no:13,name:"invulnerable_timer",kind:"scalar",T:1},{no:6,name:"score",kind:"scalar",T:5},{no:7,name:"money",kind:"scalar",T:5},{no:8,name:"kills",kind:"scalar",T:5},{no:9,name:"rotation",kind:"scalar",T:1},{no:10,name:"bullets_left_by_weapon_type",kind:"map",K:9,V:{kind:"scalar",T:5}},{no:11,name:"night_vision_timer",kind:"scalar",T:1},{no:12,name:"is_alive",kind:"scalar",T:8},{no:14,name:"inventory",kind:"message",repeat:2,T:()=>dt},{no:15,name:"selected_gun_type",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.username="",t.lives=0,t.invulnerableTimer=0,t.score=0,t.money=0,t.kills=0,t.rotation=0,t.bulletsLeftByWeaponType={},t.nightVisionTimer=0,t.isAlive=!1,t.inventory=[],t.selectedGunType="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.username=e.string();break;case 3:s.position=ht.internalBinaryRead(e,e.uint32(),i,s.position);break;case 4:s.velocity=ht.internalBinaryRead(e,e.uint32(),i,s.velocity);break;case 5:s.lives=e.float();break;case 13:s.invulnerableTimer=e.double();break;case 6:s.score=e.int32();break;case 7:s.money=e.int32();break;case 8:s.kills=e.int32();break;case 9:s.rotation=e.double();break;case 10:this.binaryReadMap10(s.bulletsLeftByWeaponType,e,i);break;case 11:s.nightVisionTimer=e.double();break;case 12:s.isAlive=e.bool();break;case 14:s.inventory.push(dt.internalBinaryRead(e,e.uint32(),i));break;case 15:s.selectedGunType=e.string();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}binaryReadMap10(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,i]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=t.int32();break;default:throw new globalThis.Error("unknown map entry field for protocol.Player.bullets_left_by_weapon_type")}}e[n??""]=s??0}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ce.LengthDelimited).string(e.id),""!==e.username&&t.tag(2,ce.LengthDelimited).string(e.username),e.position&&ht.internalBinaryWrite(e.position,t.tag(3,ce.LengthDelimited).fork(),i).join(),e.velocity&&ht.internalBinaryWrite(e.velocity,t.tag(4,ce.LengthDelimited).fork(),i).join(),0!==e.lives&&t.tag(5,ce.Bit32).float(e.lives),0!==e.score&&t.tag(6,ce.Varint).int32(e.score),0!==e.money&&t.tag(7,ce.Varint).int32(e.money),0!==e.kills&&t.tag(8,ce.Varint).int32(e.kills),0!==e.rotation&&t.tag(9,ce.Bit64).double(e.rotation);for(let i of globalThis.Object.keys(e.bulletsLeftByWeaponType))t.tag(10,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(i).tag(2,ce.Varint).int32(e.bulletsLeftByWeaponType[i]).join();0!==e.nightVisionTimer&&t.tag(11,ce.Bit64).double(e.nightVisionTimer),!1!==e.isAlive&&t.tag(12,ce.Varint).bool(e.isAlive),0!==e.invulnerableTimer&&t.tag(13,ce.Bit64).double(e.invulnerableTimer);for(let n=0;n<e.inventory.length;n++)dt.internalBinaryWrite(e.inventory[n],t.tag(14,ce.LengthDelimited).fork(),i).join();""!==e.selectedGunType&&t.tag(15,ce.LengthDelimited).string(e.selectedGunType);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},ut=new class extends ot{constructor(){super("protocol.Bullet",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ht},{no:3,name:"velocity",kind:"message",T:()=>ht},{no:4,name:"owner_id",kind:"scalar",T:9},{no:5,name:"damage",kind:"scalar",T:2},{no:6,name:"is_enemy",kind:"scalar",T:8},{no:11,name:"enemy_type",kind:"scalar",T:9},{no:7,name:"is_active",kind:"scalar",T:8},{no:10,name:"deleted_at",kind:"scalar",T:3,L:0},{no:9,name:"inactive_ms",kind:"scalar",T:3,L:0},{no:8,name:"weapon_type",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.ownerId="",t.damage=0,t.isEnemy=!1,t.enemyType="",t.isActive=!1,t.deletedAt=0n,t.inactiveMs=0n,t.weaponType="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ht.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:s.velocity=ht.internalBinaryRead(e,e.uint32(),i,s.velocity);break;case 4:s.ownerId=e.string();break;case 5:s.damage=e.float();break;case 6:s.isEnemy=e.bool();break;case 11:s.enemyType=e.string();break;case 7:s.isActive=e.bool();break;case 10:s.deletedAt=e.int64().toBigInt();break;case 9:s.inactiveMs=e.int64().toBigInt();break;case 8:s.weaponType=e.string();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ce.LengthDelimited).string(e.id),e.position&&ht.internalBinaryWrite(e.position,t.tag(2,ce.LengthDelimited).fork(),i).join(),e.velocity&&ht.internalBinaryWrite(e.velocity,t.tag(3,ce.LengthDelimited).fork(),i).join(),""!==e.ownerId&&t.tag(4,ce.LengthDelimited).string(e.ownerId),0!==e.damage&&t.tag(5,ce.Bit32).float(e.damage),!1!==e.isEnemy&&t.tag(6,ce.Varint).bool(e.isEnemy),!1!==e.isActive&&t.tag(7,ce.Varint).bool(e.isActive),""!==e.weaponType&&t.tag(8,ce.LengthDelimited).string(e.weaponType),0n!==e.inactiveMs&&t.tag(9,ce.Varint).int64(e.inactiveMs),0n!==e.deletedAt&&t.tag(10,ce.Varint).int64(e.deletedAt),""!==e.enemyType&&t.tag(11,ce.LengthDelimited).string(e.enemyType);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},pt=new class extends ot{constructor(){super("protocol.Wall",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ht},{no:3,name:"width",kind:"scalar",T:1},{no:4,name:"height",kind:"scalar",T:1},{no:5,name:"orientation",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.width=0,t.height=0,t.orientation="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ht.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:s.width=e.double();break;case 4:s.height=e.double();break;case 5:s.orientation=e.string();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ce.LengthDelimited).string(e.id),e.position&&ht.internalBinaryWrite(e.position,t.tag(2,ce.LengthDelimited).fork(),i).join(),0!==e.width&&t.tag(3,ce.Bit64).double(e.width),0!==e.height&&t.tag(4,ce.Bit64).double(e.height),""!==e.orientation&&t.tag(5,ce.LengthDelimited).string(e.orientation);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},gt=new class extends ot{constructor(){super("protocol.Enemy",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ht},{no:3,name:"rotation",kind:"scalar",T:1},{no:4,name:"lives",kind:"scalar",T:2},{no:5,name:"wall_id",kind:"scalar",T:9},{no:6,name:"is_alive",kind:"scalar",T:8},{no:7,name:"type",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.rotation=0,t.lives=0,t.wallId="",t.isAlive=!1,t.type="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ht.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:s.rotation=e.double();break;case 4:s.lives=e.float();break;case 5:s.wallId=e.string();break;case 6:s.isAlive=e.bool();break;case 7:s.type=e.string();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ce.LengthDelimited).string(e.id),e.position&&ht.internalBinaryWrite(e.position,t.tag(2,ce.LengthDelimited).fork(),i).join(),0!==e.rotation&&t.tag(3,ce.Bit64).double(e.rotation),0!==e.lives&&t.tag(4,ce.Bit32).float(e.lives),""!==e.wallId&&t.tag(5,ce.LengthDelimited).string(e.wallId),!1!==e.isAlive&&t.tag(6,ce.Varint).bool(e.isAlive),""!==e.type&&t.tag(7,ce.LengthDelimited).string(e.type);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},yt=new class extends ot{constructor(){super("protocol.Bonus",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ht},{no:3,name:"type",kind:"scalar",T:9},{no:4,name:"picked_up_by",kind:"scalar",T:9},{no:5,name:"dropped_by",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.type="",t.pickedUpBy="",t.droppedBy="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ht.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:s.type=e.string();break;case 4:s.pickedUpBy=e.string();break;case 5:s.droppedBy=e.string();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ce.LengthDelimited).string(e.id),e.position&&ht.internalBinaryWrite(e.position,t.tag(2,ce.LengthDelimited).fork(),i).join(),""!==e.type&&t.tag(3,ce.LengthDelimited).string(e.type),""!==e.pickedUpBy&&t.tag(4,ce.LengthDelimited).string(e.pickedUpBy),""!==e.droppedBy&&t.tag(5,ce.LengthDelimited).string(e.droppedBy);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},ft=new class extends ot{constructor(){super("protocol.ShopItem",[{no:1,name:"quantity",kind:"scalar",T:5},{no:2,name:"pack_size",kind:"scalar",T:5},{no:3,name:"price",kind:"scalar",T:5}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.quantity=0,t.packSize=0,t.price=0,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.quantity=e.int32();break;case 2:s.packSize=e.int32();break;case 3:s.price=e.int32();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){0!==e.quantity&&t.tag(1,ce.Varint).int32(e.quantity),0!==e.packSize&&t.tag(2,ce.Varint).int32(e.packSize),0!==e.price&&t.tag(3,ce.Varint).int32(e.price);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},mt=new class extends ot{constructor(){super("protocol.Shop",[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"position",kind:"message",T:()=>ht},{no:3,name:"inventory",kind:"map",K:5,V:{kind:"message",T:()=>ft}},{no:4,name:"name",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.id="",t.inventory={},t.name="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.id=e.string();break;case 2:s.position=ht.internalBinaryRead(e,e.uint32(),i,s.position);break;case 3:this.binaryReadMap3(s.inventory,e,i);break;case 4:s.name=e.string();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}binaryReadMap3(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.int32();break;case 2:s=ft.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.Shop.inventory")}}e[n??0]=s??ft.create()}internalBinaryWrite(e,t,i){""!==e.id&&t.tag(1,ce.LengthDelimited).string(e.id),e.position&&ht.internalBinaryWrite(e.position,t.tag(2,ce.LengthDelimited).fork(),i).join();for(let n of globalThis.Object.keys(e.inventory))t.tag(3,ce.LengthDelimited).fork().tag(1,ce.Varint).int32(parseInt(n)),t.tag(2,ce.LengthDelimited).fork(),ft.internalBinaryWrite(e.inventory[n],t,i),t.join().join();""!==e.name&&t.tag(4,ce.LengthDelimited).string(e.name);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},wt=new class extends ot{constructor(){super("protocol.InputMessage",[{no:1,name:"forward",kind:"scalar",T:8},{no:2,name:"backward",kind:"scalar",T:8},{no:3,name:"left",kind:"scalar",T:8},{no:4,name:"right",kind:"scalar",T:8},{no:5,name:"shoot",kind:"scalar",T:8},{no:6,name:"item_key",kind:"map",K:5,V:{kind:"scalar",T:8}},{no:7,name:"purchase_item_key",kind:"map",K:5,V:{kind:"scalar",T:8}}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.forward=!1,t.backward=!1,t.left=!1,t.right=!1,t.shoot=!1,t.itemKey={},t.purchaseItemKey={},void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.forward=e.bool();break;case 2:s.backward=e.bool();break;case 3:s.left=e.bool();break;case 4:s.right=e.bool();break;case 5:s.shoot=e.bool();break;case 6:this.binaryReadMap6(s.itemKey,e,i);break;case 7:this.binaryReadMap7(s.purchaseItemKey,e,i);break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}binaryReadMap6(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,i]=t.tag();switch(e){case 1:n=t.int32();break;case 2:s=t.bool();break;default:throw new globalThis.Error("unknown map entry field for protocol.InputMessage.item_key")}}e[n??0]=s??!1}binaryReadMap7(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,i]=t.tag();switch(e){case 1:n=t.int32();break;case 2:s=t.bool();break;default:throw new globalThis.Error("unknown map entry field for protocol.InputMessage.purchase_item_key")}}e[n??0]=s??!1}internalBinaryWrite(e,t,i){!1!==e.forward&&t.tag(1,ce.Varint).bool(e.forward),!1!==e.backward&&t.tag(2,ce.Varint).bool(e.backward),!1!==e.left&&t.tag(3,ce.Varint).bool(e.left),!1!==e.right&&t.tag(4,ce.Varint).bool(e.right),!1!==e.shoot&&t.tag(5,ce.Varint).bool(e.shoot);for(let i of globalThis.Object.keys(e.itemKey))t.tag(6,ce.LengthDelimited).fork().tag(1,ce.Varint).int32(parseInt(i)).tag(2,ce.Varint).bool(e.itemKey[i]).join();for(let i of globalThis.Object.keys(e.purchaseItemKey))t.tag(7,ce.LengthDelimited).fork().tag(1,ce.Varint).int32(parseInt(i)).tag(2,ce.Varint).bool(e.purchaseItemKey[i]).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},bt=new class extends ot{constructor(){super("protocol.PositionUpdate",[{no:1,name:"x",kind:"scalar",T:1},{no:2,name:"y",kind:"scalar",T:1},{no:3,name:"rotation",kind:"scalar",T:1}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.x=0,t.y=0,t.rotation=0,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.x=e.double();break;case 2:s.y=e.double();break;case 3:s.rotation=e.double();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){0!==e.x&&t.tag(1,ce.Bit64).double(e.x),0!==e.y&&t.tag(2,ce.Bit64).double(e.y),0!==e.rotation&&t.tag(3,ce.Bit64).double(e.rotation);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},kt=new class extends ot{constructor(){super("protocol.TimersUpdate",[{no:1,name:"invulnerable_timer",kind:"scalar",T:1},{no:2,name:"night_vision_timer",kind:"scalar",T:1}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.invulnerableTimer=0,t.nightVisionTimer=0,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.invulnerableTimer=e.double();break;case 2:s.nightVisionTimer=e.double();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){0!==e.invulnerableTimer&&t.tag(1,ce.Bit64).double(e.invulnerableTimer),0!==e.nightVisionTimer&&t.tag(2,ce.Bit64).double(e.nightVisionTimer);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},Tt=new class extends ot{constructor(){super("protocol.LivesUpdate",[{no:1,name:"lives",kind:"scalar",T:2},{no:2,name:"is_alive",kind:"scalar",T:8}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.lives=0,t.isAlive=!1,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.lives=e.float();break;case 2:s.isAlive=e.bool();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){0!==e.lives&&t.tag(1,ce.Bit32).float(e.lives),!1!==e.isAlive&&t.tag(2,ce.Varint).bool(e.isAlive);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},_t=new class extends ot{constructor(){super("protocol.InventoryUpdate",[{no:1,name:"inventory",kind:"message",repeat:2,T:()=>dt},{no:2,name:"selected_gun_type",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.inventory=[],t.selectedGunType="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.inventory.push(dt.internalBinaryRead(e,e.uint32(),i));break;case 2:s.selectedGunType=e.string();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){for(let n=0;n<e.inventory.length;n++)dt.internalBinaryWrite(e.inventory[n],t.tag(1,ce.LengthDelimited).fork(),i).join();""!==e.selectedGunType&&t.tag(2,ce.LengthDelimited).string(e.selectedGunType);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},vt=new class extends ot{constructor(){super("protocol.ScoreUpdate",[{no:1,name:"score",kind:"scalar",T:5},{no:2,name:"money",kind:"scalar",T:5},{no:3,name:"kills",kind:"scalar",T:5}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.score=0,t.money=0,t.kills=0,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.score=e.int32();break;case 2:s.money=e.int32();break;case 3:s.kills=e.int32();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){0!==e.score&&t.tag(1,ce.Varint).int32(e.score),0!==e.money&&t.tag(2,ce.Varint).int32(e.money),0!==e.kills&&t.tag(3,ce.Varint).int32(e.kills);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},St=new class extends ot{constructor(){super("protocol.PlayerBulletsUpdate",[{no:1,name:"bullets_left_by_weapon_type",kind:"map",K:9,V:{kind:"scalar",T:5}}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.bulletsLeftByWeaponType={},void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();if(1===t)this.binaryReadMap1(s.bulletsLeftByWeaponType,e,i);else{let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}binaryReadMap1(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,i]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=t.int32();break;default:throw new globalThis.Error("unknown map entry field for protocol.PlayerBulletsUpdate.bullets_left_by_weapon_type")}}e[n??""]=s??0}internalBinaryWrite(e,t,i){for(let i of globalThis.Object.keys(e.bulletsLeftByWeaponType))t.tag(1,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(i).tag(2,ce.Varint).int32(e.bulletsLeftByWeaponType[i]).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},Et=new class extends ot{constructor(){super("protocol.PlayerUpdate",[{no:1,name:"position",kind:"message",T:()=>bt},{no:2,name:"timers",kind:"message",T:()=>kt},{no:3,name:"lives",kind:"message",T:()=>Tt},{no:4,name:"inventory",kind:"message",T:()=>_t},{no:5,name:"score",kind:"message",T:()=>vt},{no:6,name:"player_bullets",kind:"message",T:()=>St}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.position=bt.internalBinaryRead(e,e.uint32(),i,s.position);break;case 2:s.timers=kt.internalBinaryRead(e,e.uint32(),i,s.timers);break;case 3:s.lives=Tt.internalBinaryRead(e,e.uint32(),i,s.lives);break;case 4:s.inventory=_t.internalBinaryRead(e,e.uint32(),i,s.inventory);break;case 5:s.score=vt.internalBinaryRead(e,e.uint32(),i,s.score);break;case 6:s.playerBullets=St.internalBinaryRead(e,e.uint32(),i,s.playerBullets);break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){e.position&&bt.internalBinaryWrite(e.position,t.tag(1,ce.LengthDelimited).fork(),i).join(),e.timers&&kt.internalBinaryWrite(e.timers,t.tag(2,ce.LengthDelimited).fork(),i).join(),e.lives&&Tt.internalBinaryWrite(e.lives,t.tag(3,ce.LengthDelimited).fork(),i).join(),e.inventory&&_t.internalBinaryWrite(e.inventory,t.tag(4,ce.LengthDelimited).fork(),i).join(),e.score&&vt.internalBinaryWrite(e.score,t.tag(5,ce.LengthDelimited).fork(),i).join(),e.playerBullets&&St.internalBinaryWrite(e.playerBullets,t.tag(6,ce.LengthDelimited).fork(),i).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}};new class extends ot{constructor(){super("protocol.DeletionUpdate",[{no:1,name:"is_active",kind:"scalar",T:8},{no:2,name:"deleted_at",kind:"scalar",T:3,L:0}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.isActive=!1,t.deletedAt=0n,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.isActive=e.bool();break;case 2:s.deletedAt=e.int64().toBigInt();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){!1!==e.isActive&&t.tag(1,ce.Varint).bool(e.isActive),0n!==e.deletedAt&&t.tag(2,ce.Varint).int64(e.deletedAt);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}};const It=new class extends ot{constructor(){super("protocol.EnemyUpdate",[{no:1,name:"position",kind:"message",T:()=>bt},{no:2,name:"lives",kind:"message",T:()=>Tt}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.position=bt.internalBinaryRead(e,e.uint32(),i,s.position);break;case 2:s.lives=Tt.internalBinaryRead(e,e.uint32(),i,s.lives);break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){e.position&&bt.internalBinaryWrite(e.position,t.tag(1,ce.LengthDelimited).fork(),i).join(),e.lives&&Tt.internalBinaryWrite(e.lives,t.tag(2,ce.LengthDelimited).fork(),i).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},Bt=new class extends ot{constructor(){super("protocol.BonusUpdate",[{no:1,name:"picked_up_by",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.pickedUpBy="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();if(1===t)s.pickedUpBy=e.string();else{let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){""!==e.pickedUpBy&&t.tag(1,ce.LengthDelimited).string(e.pickedUpBy);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},Nt=new class extends ot{constructor(){super("protocol.ShopUpdate",[{no:1,name:"inventory",kind:"map",K:5,V:{kind:"message",T:()=>ft}}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.inventory={},void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();if(1===t)this.binaryReadMap1(s.inventory,e,i);else{let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}binaryReadMap1(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.int32();break;case 2:s=ft.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.ShopUpdate.inventory")}}e[n??0]=s??ft.create()}internalBinaryWrite(e,t,i){for(let n of globalThis.Object.keys(e.inventory))t.tag(1,ce.LengthDelimited).fork().tag(1,ce.Varint).int32(parseInt(n)),t.tag(2,ce.LengthDelimited).fork(),ft.internalBinaryWrite(e.inventory[n],t,i),t.join().join();let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},Rt=new class extends ot{constructor(){super("protocol.GameStateDeltaMessage",[{no:1,name:"added_players",kind:"map",K:9,V:{kind:"message",T:()=>ct}},{no:2,name:"updated_players",kind:"map",K:9,V:{kind:"message",T:()=>Et}},{no:3,name:"removed_players",kind:"scalar",repeat:2,T:9},{no:4,name:"added_bullets",kind:"map",K:9,V:{kind:"message",T:()=>ut}},{no:5,name:"updated_bullets",kind:"map",K:9,V:{kind:"message",T:()=>bt}},{no:6,name:"removed_bullets",kind:"map",K:9,V:{kind:"message",T:()=>ut}},{no:7,name:"added_walls",kind:"map",K:9,V:{kind:"message",T:()=>pt}},{no:8,name:"removed_walls",kind:"scalar",repeat:2,T:9},{no:9,name:"added_enemies",kind:"map",K:9,V:{kind:"message",T:()=>gt}},{no:10,name:"updated_enemies",kind:"map",K:9,V:{kind:"message",T:()=>It}},{no:11,name:"removed_enemies",kind:"scalar",repeat:2,T:9},{no:12,name:"added_bonuses",kind:"map",K:9,V:{kind:"message",T:()=>yt}},{no:13,name:"updated_bonuses",kind:"map",K:9,V:{kind:"message",T:()=>Bt}},{no:14,name:"removed_bonuses",kind:"scalar",repeat:2,T:9},{no:15,name:"added_shops",kind:"map",K:9,V:{kind:"message",T:()=>mt}},{no:16,name:"updated_shops",kind:"map",K:9,V:{kind:"message",T:()=>Nt}},{no:17,name:"removed_shops",kind:"scalar",repeat:2,T:9},{no:18,name:"added_players_shops",kind:"scalar",repeat:2,T:9},{no:19,name:"removed_players_shops",kind:"scalar",repeat:2,T:9},{no:20,name:"updated_other_player_positions",kind:"map",K:9,V:{kind:"message",T:()=>ht}},{no:21,name:"removed_other_player_positions",kind:"scalar",repeat:2,T:9},{no:22,name:"timestamp",kind:"scalar",T:3,L:0}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.addedPlayers={},t.updatedPlayers={},t.removedPlayers=[],t.addedBullets={},t.updatedBullets={},t.removedBullets={},t.addedWalls={},t.removedWalls=[],t.addedEnemies={},t.updatedEnemies={},t.removedEnemies=[],t.addedBonuses={},t.updatedBonuses={},t.removedBonuses=[],t.addedShops={},t.updatedShops={},t.removedShops=[],t.addedPlayersShops=[],t.removedPlayersShops=[],t.updatedOtherPlayerPositions={},t.removedOtherPlayerPositions=[],t.timestamp=0n,void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:this.binaryReadMap1(s.addedPlayers,e,i);break;case 2:this.binaryReadMap2(s.updatedPlayers,e,i);break;case 3:s.removedPlayers.push(e.string());break;case 4:this.binaryReadMap4(s.addedBullets,e,i);break;case 5:this.binaryReadMap5(s.updatedBullets,e,i);break;case 6:this.binaryReadMap6(s.removedBullets,e,i);break;case 7:this.binaryReadMap7(s.addedWalls,e,i);break;case 8:s.removedWalls.push(e.string());break;case 9:this.binaryReadMap9(s.addedEnemies,e,i);break;case 10:this.binaryReadMap10(s.updatedEnemies,e,i);break;case 11:s.removedEnemies.push(e.string());break;case 12:this.binaryReadMap12(s.addedBonuses,e,i);break;case 13:this.binaryReadMap13(s.updatedBonuses,e,i);break;case 14:s.removedBonuses.push(e.string());break;case 15:this.binaryReadMap15(s.addedShops,e,i);break;case 16:this.binaryReadMap16(s.updatedShops,e,i);break;case 17:s.removedShops.push(e.string());break;case 18:s.addedPlayersShops.push(e.string());break;case 19:s.removedPlayersShops.push(e.string());break;case 20:this.binaryReadMap20(s.updatedOtherPlayerPositions,e,i);break;case 21:s.removedOtherPlayerPositions.push(e.string());break;case 22:s.timestamp=e.int64().toBigInt();break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}binaryReadMap1(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=ct.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.added_players")}}e[n??""]=s??ct.create()}binaryReadMap2(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=Et.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_players")}}e[n??""]=s??Et.create()}binaryReadMap4(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=ut.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.added_bullets")}}e[n??""]=s??ut.create()}binaryReadMap5(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=bt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_bullets")}}e[n??""]=s??bt.create()}binaryReadMap6(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=ut.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.removed_bullets")}}e[n??""]=s??ut.create()}binaryReadMap7(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=pt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.added_walls")}}e[n??""]=s??pt.create()}binaryReadMap9(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=gt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.added_enemies")}}e[n??""]=s??gt.create()}binaryReadMap10(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=It.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_enemies")}}e[n??""]=s??It.create()}binaryReadMap12(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=yt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.added_bonuses")}}e[n??""]=s??yt.create()}binaryReadMap13(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=Bt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_bonuses")}}e[n??""]=s??Bt.create()}binaryReadMap15(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=mt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.added_shops")}}e[n??""]=s??mt.create()}binaryReadMap16(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=Nt.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_shops")}}e[n??""]=s??Nt.create()}binaryReadMap20(e,t,i){let n,s,r=t.uint32(),a=t.pos+r;for(;t.pos<a;){let[e,r]=t.tag();switch(e){case 1:n=t.string();break;case 2:s=ht.internalBinaryRead(t,t.uint32(),i);break;default:throw new globalThis.Error("unknown map entry field for protocol.GameStateDeltaMessage.updated_other_player_positions")}}e[n??""]=s??ht.create()}internalBinaryWrite(e,t,i){for(let n of globalThis.Object.keys(e.addedPlayers))t.tag(1,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),ct.internalBinaryWrite(e.addedPlayers[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.updatedPlayers))t.tag(2,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),Et.internalBinaryWrite(e.updatedPlayers[n],t,i),t.join().join();for(let i=0;i<e.removedPlayers.length;i++)t.tag(3,ce.LengthDelimited).string(e.removedPlayers[i]);for(let n of globalThis.Object.keys(e.addedBullets))t.tag(4,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),ut.internalBinaryWrite(e.addedBullets[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.updatedBullets))t.tag(5,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),bt.internalBinaryWrite(e.updatedBullets[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.removedBullets))t.tag(6,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),ut.internalBinaryWrite(e.removedBullets[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.addedWalls))t.tag(7,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),pt.internalBinaryWrite(e.addedWalls[n],t,i),t.join().join();for(let i=0;i<e.removedWalls.length;i++)t.tag(8,ce.LengthDelimited).string(e.removedWalls[i]);for(let n of globalThis.Object.keys(e.addedEnemies))t.tag(9,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),gt.internalBinaryWrite(e.addedEnemies[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.updatedEnemies))t.tag(10,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),It.internalBinaryWrite(e.updatedEnemies[n],t,i),t.join().join();for(let i=0;i<e.removedEnemies.length;i++)t.tag(11,ce.LengthDelimited).string(e.removedEnemies[i]);for(let n of globalThis.Object.keys(e.addedBonuses))t.tag(12,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),yt.internalBinaryWrite(e.addedBonuses[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.updatedBonuses))t.tag(13,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),Bt.internalBinaryWrite(e.updatedBonuses[n],t,i),t.join().join();for(let i=0;i<e.removedBonuses.length;i++)t.tag(14,ce.LengthDelimited).string(e.removedBonuses[i]);for(let n of globalThis.Object.keys(e.addedShops))t.tag(15,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),mt.internalBinaryWrite(e.addedShops[n],t,i),t.join().join();for(let n of globalThis.Object.keys(e.updatedShops))t.tag(16,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),Nt.internalBinaryWrite(e.updatedShops[n],t,i),t.join().join();for(let i=0;i<e.removedShops.length;i++)t.tag(17,ce.LengthDelimited).string(e.removedShops[i]);for(let i=0;i<e.addedPlayersShops.length;i++)t.tag(18,ce.LengthDelimited).string(e.addedPlayersShops[i]);for(let i=0;i<e.removedPlayersShops.length;i++)t.tag(19,ce.LengthDelimited).string(e.removedPlayersShops[i]);for(let n of globalThis.Object.keys(e.updatedOtherPlayerPositions))t.tag(20,ce.LengthDelimited).fork().tag(1,ce.LengthDelimited).string(n),t.tag(2,ce.LengthDelimited).fork(),ht.internalBinaryWrite(e.updatedOtherPlayerPositions[n],t,i),t.join().join();for(let i=0;i<e.removedOtherPlayerPositions.length;i++)t.tag(21,ce.LengthDelimited).string(e.removedOtherPlayerPositions[i]);0n!==e.timestamp&&t.tag(22,ce.Varint).int64(e.timestamp);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},Pt=new class extends ot{constructor(){super("protocol.PlayerJoinMessage",[{no:1,name:"player",kind:"message",T:()=>ct}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();if(1===t)s.player=ct.internalBinaryRead(e,e.uint32(),i,s.player);else{let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){e.player&&ct.internalBinaryWrite(e.player,t.tag(1,ce.LengthDelimited).fork(),i).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},Lt=new class extends ot{constructor(){super("protocol.PlayerLeaveMessage",[{no:1,name:"player_id",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.playerId="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();if(1===t)s.playerId=e.string();else{let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){""!==e.playerId&&t.tag(1,ce.LengthDelimited).string(e.playerId);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},Ot=new class extends ot{constructor(){super("protocol.PlayerRespawnMessage",[])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();{let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},xt=new class extends ot{constructor(){super("protocol.ErrorMessage",[{no:1,name:"message",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.message="",void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();if(1===t)s.message=e.string();else{let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){""!==e.message&&t.tag(1,ce.LengthDelimited).string(e.message);let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}},At=new class extends ot{constructor(){super("protocol.GameMessage",[{no:1,name:"type",kind:"enum",T:()=>["protocol.MessageType",lt]},{no:3,name:"input",kind:"message",oneof:"payload",T:()=>wt},{no:11,name:"game_state_delta",kind:"message",oneof:"payload",T:()=>Rt},{no:6,name:"player_join",kind:"message",oneof:"payload",T:()=>Pt},{no:7,name:"player_leave",kind:"message",oneof:"payload",T:()=>Lt},{no:8,name:"player_respawn",kind:"message",oneof:"payload",T:()=>Ot},{no:10,name:"error",kind:"message",oneof:"payload",T:()=>xt}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.type=0,t.payload={oneofKind:void 0},void 0!==e&&ue(this,t,e),t}internalBinaryRead(e,t,i,n){let s=n??this.create(),r=e.pos+t;for(;e.pos<r;){let[t,n]=e.tag();switch(t){case 1:s.type=e.int32();break;case 3:s.payload={oneofKind:"input",input:wt.internalBinaryRead(e,e.uint32(),i,s.payload.input)};break;case 11:s.payload={oneofKind:"gameStateDelta",gameStateDelta:Rt.internalBinaryRead(e,e.uint32(),i,s.payload.gameStateDelta)};break;case 6:s.payload={oneofKind:"playerJoin",playerJoin:Pt.internalBinaryRead(e,e.uint32(),i,s.payload.playerJoin)};break;case 7:s.payload={oneofKind:"playerLeave",playerLeave:Lt.internalBinaryRead(e,e.uint32(),i,s.payload.playerLeave)};break;case 8:s.payload={oneofKind:"playerRespawn",playerRespawn:Ot.internalBinaryRead(e,e.uint32(),i,s.payload.playerRespawn)};break;case 10:s.payload={oneofKind:"error",error:xt.internalBinaryRead(e,e.uint32(),i,s.payload.error)};break;default:let r=i.readUnknownField;if("throw"===r)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let a=e.skip(n);!1!==r&&(!0===r?de.onRead:r)(this.typeName,s,t,n,a)}}return s}internalBinaryWrite(e,t,i){0!==e.type&&t.tag(1,ce.Varint).int32(e.type),"input"===e.payload.oneofKind&&wt.internalBinaryWrite(e.payload.input,t.tag(3,ce.LengthDelimited).fork(),i).join(),"playerJoin"===e.payload.oneofKind&&Pt.internalBinaryWrite(e.payload.playerJoin,t.tag(6,ce.LengthDelimited).fork(),i).join(),"playerLeave"===e.payload.oneofKind&&Lt.internalBinaryWrite(e.payload.playerLeave,t.tag(7,ce.LengthDelimited).fork(),i).join(),"playerRespawn"===e.payload.oneofKind&&Ot.internalBinaryWrite(e.payload.playerRespawn,t.tag(8,ce.LengthDelimited).fork(),i).join(),"error"===e.payload.oneofKind&&xt.internalBinaryWrite(e.payload.error,t.tag(10,ce.LengthDelimited).fork(),i).join(),"gameStateDelta"===e.payload.oneofKind&&Rt.internalBinaryWrite(e.payload.gameStateDelta,t.tag(11,ce.LengthDelimited).fork(),i).join();let n=i.writeUnknownFields;return!1!==n&&(1==n?de.onWrite:n)(this.typeName,e,t),t}};class Ut{static instance;socket=null;_gameStateDeltaHandler=null;_playerJoinedHandler=null;_playerLeftHandler=null;reconnectAttempts=0;maxReconnectAttempts=5;reconnectDelay=1e3;sessionId=null;messageQueue=[];binaryMode=!0;constructor(){}static getInstance(){return Ut.instance||(Ut.instance=new Ut),Ut.instance}connect(e){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.close(),this.sessionId=e;const t=le.getInstance().getToken(),i=`${n.startsWith("https")?"wss":"ws"}://${n.replace(/^https?:\/\//,"")}/ws?sessionId=${e}&token=${t}&protocol=${this.binaryMode?"binary":"json"}`;return this.socket=new WebSocket(i),this.binaryMode&&(this.socket.binaryType="arraybuffer"),this.setupEventListeners(),this.socket}disconnect(){this.socket&&(this.socket.close(),this.socket=null,this.sessionId=null,this.messageQueue=[])}getSocket(){return this.socket}emit(e){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)return console.warn("Attempting to emit without socket connection"),void this.messageQueue.push(e);this.socket.send(this.binaryMode?At.toBinary(e):At.toJsonString(e))}setupEventListeners(){this.socket&&(this.socket.onopen=()=>{for(console.log("Connected to WebSocket server"),this.reconnectAttempts=0;this.messageQueue.length>0;){const e=this.messageQueue.shift();e&&this.emit(e)}},this.socket.onclose=e=>{console.log("Disconnected from WebSocket server",e.code,e.reason),1e3!==e.code&&this.reconnectAttempts<this.maxReconnectAttempts&&this.sessionId&&(this.reconnectAttempts++,console.log(`Reconnecting... Attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`),setTimeout((()=>{this.sessionId&&this.connect(this.sessionId)}),this.reconnectDelay*this.reconnectAttempts))},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onmessage=e=>{try{const t=this.binaryMode?At.fromBinary(new Uint8Array(e.data)):At.fromJsonString(e.data);this.handleMessage(t)}catch(e){console.error("Failed to parse WebSocket message:",e)}})}handleMessage({payload:e}){switch(e.oneofKind){case"gameStateDelta":this._gameStateDeltaHandler?.(e.gameStateDelta);break;case"playerJoin":this._playerJoinedHandler?.(e.playerJoin);break;case"playerLeave":this._playerLeftHandler?.(e.playerLeave);break;default:console.warn("Unknown WebSocket event:",e.oneofKind)}}onGameStateDelta(e){this._gameStateDeltaHandler=e}onPlayerJoined(e){this._playerJoinedHandler=e}onPlayerLeft(e){this._playerLeftHandler=e}}class Dt{static instance;currentSession=null;socketService;constructor(){this.socketService=Ut.getInstance()}static getInstance(){return Dt.instance||(Dt.instance=new Dt),Dt.instance}async listSessions(){return await he.get("/sessions")}async startSession(e){const t=await he.post("/sessions",{name:e});return this.currentSession=t,this.socketService.connect(t.id),t}async joinSession(e){const t=await he.post(`/sessions/${e}/join`);return this.currentSession=t,this.socketService.connect(t.id),t}async deleteSession(e){await he.delete(`/sessions/${e}`),this.currentSession?.id===e&&(this.currentSession=null,this.socketService.disconnect())}async endSession(){this.currentSession&&(this.socketService.disconnect(),this.currentSession=null)}getCurrentSession(){return this.currentSession}notifyRespawn(){this.currentSession?this.socketService.emit({type:lt.PLAYER_RESPAWN,payload:{oneofKind:"playerRespawn",playerRespawn:Ot.create()}}):console.warn("Attempting to notify about respawn without active session")}notifyInput(e){this.socketService.emit({type:lt.INPUT,payload:{oneofKind:"input",input:e}})}onGameStateDelta(e){this.socketService.onGameStateDelta(e)}onPlayerJoined(e){this.socketService.onPlayerJoined(e)}onPlayerLeft(e){this.socketService.onPlayerLeft(e)}}class Mt{_Player;_Enemy;_Wall;_Bonus;_OtherPlayer;_Shop;_BulletManager;_multiplayerMode;CHUNK_SIZE=2e3;_player=null;_otherPlayers={};_otherPlayerCoordinates={};_enemies=[];_walls=[];_bonuses=[];_shops=[];_gameOver=!1;floorTexture=null;inventoryItemTextures={};chunks=new Map;_cameraPoint=new i(0,0);_torchRadius=200;_debug=!1;_sessionManager=Dt.getInstance();_bulletManager;_lastChangesetTimestamp=0;_bonusPickupCache=new Set;_previousInputState={forward:!1,backward:!1,left:!1,right:!1,shoot:!1,itemKey:{},purchaseItemKey:{}};_inputStateSubmitTimestamp=0;get debug(){return this._debug}toggleDebug(){this._debug=!this._debug}get gameOver(){return this._gameOver}get player(){return this._player}get otherPlayers(){return Object.values(this._otherPlayers)}getOtherPlayerById(e){return this._otherPlayers[e]||null}get walls(){return this._walls}get enemies(){return this._enemies}get bonuses(){return this._bonuses}get shops(){return this._shops}get cameraPoint(){return this._cameraPoint}get torchRadius(){return this._torchRadius}get multiplayerMode(){return this._multiplayerMode}constructor(e,t,i,n,s,r,a,o){this._Player=e,this._Enemy=t,this._Wall=i,this._Bonus=n,this._OtherPlayer=s,this._Shop=r,this._BulletManager=a,this._multiplayerMode=o;const l=se.getInstance();l.loadSound(k.TORCH).then((()=>{l.playSound(k.TORCH,{volume:1,loop:!0})})),ie(w.FLOOR).then((e=>{this.floorTexture=e})),Object.entries(M).forEach((([e,t])=>{ie(t).then((t=>{this.inventoryItemTextures[Number(e)]=t}))})),this._bulletManager=new this._BulletManager(this)}addOtherPlayer(e){new i(e.position.x,e.position.y);const t=new this._OtherPlayer(this,e);this._otherPlayers[e.id]=t}removeOtherPlayer(e){delete this._otherPlayers[e]}getChunkLeftTop(e){return new i(Math.floor(e.x/this.CHUNK_SIZE),Math.floor(e.y/this.CHUNK_SIZE))}update(e){if(!this.gameOver){this._player&&(this._player.update(e),this._cameraPoint=this._player.getPosition().clone());for(const t of Object.values(this._otherPlayers))t.update(e)}}endGame(){this._gameOver||(this._gameOver=!0,se.getInstance().playSound(k.GAME_OVER,{when:1.5}))}drawFloor(e){if(this.floorTexture){const t=this.floorTexture.width/2,i=this.floorTexture.height/2,n=this.cameraPoint.x%t-t,s=this.cameraPoint.y%i-i;for(let o=-720/i-1;o<a/i+2;o++)for(let a=-1280/t-1;a<r/t+2;a++)e.drawImage(this.floorTexture,-n-a*t,-s-o*i,t,i)}if(this.debug){const t=this.getChunkLeftTop(this.cameraPoint);e.strokeStyle="yellow",e.lineWidth=1;for(let n=-1;n<=1;n++)for(let s=-1;s<=1;s++){const r=(t.x+s)*this.CHUNK_SIZE,a=(t.y+n)*this.CHUNK_SIZE,o=this.worldToScreenCoordinates(new i(r,a));e.strokeRect(o.x,o.y,this.CHUNK_SIZE,this.CHUNK_SIZE),e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(o.x+this.CHUNK_SIZE,o.y+this.CHUNK_SIZE),e.moveTo(o.x+this.CHUNK_SIZE,o.y),e.lineTo(o.x,o.y+this.CHUNK_SIZE),e.closePath(),e.stroke()}}}draw(e,t,i){e.clearRect(0,0,r,a),this.drawFloor(e),this._shops.forEach((t=>t.draw(e,i))),this._walls.forEach((t=>t.draw(e,i))),this._enemies.forEach((t=>t.draw(e,i))),Object.values(this._otherPlayers).forEach((t=>{t.draw(e,i)})),this._bonuses.forEach((t=>t.draw(e,i))),this._player&&this._player.draw(e,i),this._bulletManager.draw(e,i),this.drawDarknessOverlay(t),this.drawUI(i)}drawArrowToPoint(e,t,n,s,o=!1){const l=this.worldToScreenCoordinates(t);if(l.x>=0&&l.x<=r&&l.y>=0&&l.y<=a&&o)return;const h=new i(640,360),d=l.subtracted(h),c=10,u=n,p=Math.sqrt(d.x*d.x+d.y*d.y),g=new i(d.x/p,d.y/p),y=new i(h.x+g.x*Math.min(p-u,630),h.y+g.y*Math.min(p-u,350)),f=Date.now()/200,m=3*Math.sin(f);y.moveBy(g.x*m,g.y*m),e.strokeStyle=s,e.lineWidth=2,e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(y.x-g.x*c+g.y*(c/3),y.y-g.y*c-g.x*(c/3)),e.lineTo(y.x-g.x*c-g.y*(c/3),y.y-g.y*c+g.x*(c/3)),e.lineTo(y.x,y.y),e.fill(),e.stroke(),e.closePath()}drawUI(e){if(this._player){if(!this.gameOver){const t=this._bonuses.filter((e=>e.belongsToPlayer));for(const i of t)this.drawArrowToPoint(e,i.getPosition(),i.width*Math.SQRT2/2+10,"lime");for(const t of Object.values(this._otherPlayerCoordinates))this.drawArrowToPoint(e,t,24*Math.SQRT2/2+10,"yellow",!0)}if(e.textAlign="left",this.gameOver)e.fillStyle="white",e.font="48px Rubik Distressed",e.textAlign="center",e.fillText("Game Over",640,360),e.font=`24px ${o}`,e.fillStyle="yellow",e.fillText(`Your Posthumous Score: ${this._player.score.toFixed(0)}`,640,400),e.fillStyle="magenta",e.fillText("Press R to Restart",640,440);else{e.fillStyle="white",e.font=`22px ${o}`,e.fillText(`Lives: ${Array(Math.ceil(this._player.lives)).fill("‚ù§Ô∏è").join(" ")}`,10,30),e.fillStyle="yellow",e.fillText(`Money: ${this._player.money.toFixed(0)}$`,10,60),e.fillStyle="cyan";const t=W[this._player.selectedGunType],i=this._player.bulletsLeft,n=0===i?"-":i<6?Array(i).fill(t).join(""):`${t} x ${i}`;e.fillText(`Bullets: ${n}`,10,90),this._player.hasNightVision()&&(e.fillStyle="#90ff90",e.fillText(`Night Vision: ${this._player.nightVisionTimer.toFixed(0)}`,10,120))}if(this._player.drawUI(e),this._shops.forEach((t=>t.drawUI(e))),this.debug){const t=this._enemies.length+this._walls.length+this._bonuses.length+this._shops.length+Object.values(this._otherPlayers).length+(this._player?1:0);e.fillStyle="white",e.font=`12px ${o}`,e.fillText(`Chunk: ${this.getChunkLeftTop(this.cameraPoint)}`,10,668),e.fillText(`Number of world objects: ${t}`,10,654),e.fillText(`Camera position: ${this.cameraPoint}`,10,640),e.fillText(`Number of chunks: ${this.chunks.size}`,10,626),e.fillText(`Host: ${this._sessionManager.getCurrentSession()?.host.username}`,10,612),e.fillText(`Session ID: ${this._sessionManager.getCurrentSession()?.id}`,10,598),e.fillText(`Session: ${this._sessionManager.getCurrentSession()?.name}`,10,584)}}}drawDarknessOverlay(e){if(!this._player||!this._player.isAlive())return e.fillStyle=l,void e.fillRect(0,0,r,a);if(this._player.hasNightVision())return e.fillStyle=this._player.isNightVisionFading()?"#006000a0":"#009600a0",void e.fillRect(0,0,r,a);const t=[this._player,...this.otherPlayers.filter((e=>e.isAlive()&&!e.hasNightVision()))],i=.97*this._torchRadius+Math.random()*this._torchRadius*.06;e.fillStyle=l,e.fillRect(0,0,r,a),e.globalCompositeOperation="destination-out",t.forEach((t=>{const n=this.worldToScreenCoordinates(t.getTorchPoint()),s=e.createRadialGradient(n.x,n.y,0,n.x,n.y,i);s.addColorStop(0,"#ffffffff"),s.addColorStop(1,"#ffffff00"),e.fillStyle=s,e.fillRect(0,0,r,a),e.fillRect(0,0,r,a)})),e.globalCompositeOperation="source-over"}worldToScreenCoordinates(e){return e.movedBy(640-this._cameraPoint.x,360-this._cameraPoint.y)}handleInput(e,t){if(!this._player)return;const i=e.has("KeyW")||e.has("ArrowUp"),n=e.has("KeyS")||e.has("ArrowDown"),s=e.has("KeyA")||e.has("ArrowLeft"),r=e.has("KeyD")||e.has("ArrowRight"),a=e.has("Space"),o=Date.now(),l={},h={};for(let t=0;t<=9;t++)if(e.has(`Digit${t}`)){const e=this.shops.find((e=>e.hasPlayer()&&e.isModalOpen));if(e){const i=e.inventory;h[Number(Object.keys(i).filter((e=>i[Number(e)].quantity>0))[0==t?9:t-1])??null]=!0}else l[t]=!0}if(this._previousInputState)for(const e of Object.keys(this._previousInputState.purchaseItemKey))h[Number(e)]||this.handleShoppingAttempt(Number(e));(i!==this._previousInputState.forward||n!==this._previousInputState.backward||s!==this._previousInputState.left||r!==this._previousInputState.right||a!==this._previousInputState.shoot||JSON.stringify(l)!==JSON.stringify(this._previousInputState.itemKey)||JSON.stringify(h)!==JSON.stringify(this._previousInputState.purchaseItemKey)||o-this._inputStateSubmitTimestamp>1e3)&&(this._sessionManager.notifyInput({forward:i,backward:n,left:s,right:r,shoot:a,itemKey:l,purchaseItemKey:h}),this._previousInputState={forward:i,backward:n,left:s,right:r,shoot:a,itemKey:l,purchaseItemKey:h},this._inputStateSubmitTimestamp=o)}handleShoppingAttempt(e){if(Object.values(V).includes(e)&&this._player?.hasInventoryItem(e))return void se.getInstance().playSound(k.MISTAKE);const t=this.shops.find((e=>e.hasPlayer()&&e.isModalOpen));if(t&&t.inventory[e]){const i=t.inventory[e],n=i.price*i.packSize;this._player&&this._player.money<=n&&se.getInstance().playSound(k.MISTAKE)}}restart(){this._sessionManager.notifyRespawn()}getInventoryTexture(e){return this.inventoryItemTextures[e]||null}applyGameStateDelta(e,t){if(e.timestamp<=this._lastChangesetTimestamp)return void console.log(`Ignoring out-of-order changeset. Last: ${this._lastChangesetTimestamp}, Received: ${e.timestamp}`,e);this._lastChangesetTimestamp=Number(e.timestamp);const n=!!this._player&&0===this._player.bulletsLeft;for(const i of Object.values(e.addedPlayers))i.id!==t?this._otherPlayers[i.id]||this.addOtherPlayer(i):this._player=this._Player.fromGameState(this,i);for(const[i,n]of Object.entries(e.updatedPlayers)){if(i===t){if(n.lives?.isAlive&&!this._player?.isAlive()){const e=se.getInstance();e.playSound(k.SPAWN),e.stopSound(k.GAME_OVER),this._gameOver=!1}this._player?.applyFromGameStateDelta(n);continue}const e=this._otherPlayers[i];e&&e.applyFromGameStateDelta(n)}for(const t of e.removedPlayers)this.removeOtherPlayer(t);for(const t of Object.values(e.addedWalls))this._walls.find((e=>e.id===t.id))||this._walls.push(new this._Wall(this,new i(t.position.x,t.position.y),t.width,t.height,t.orientation,t.id));for(const t of e.removedWalls)this._walls=this._walls.filter((e=>e.id!==t));for(const t of Object.values(e.addedEnemies)){let e=this._enemies.find((e=>e.id===t.id));const i=t.wallId?this._walls.find((e=>e.id===t.wallId)):void 0;e=new this._Enemy(this,t,i),this._enemies=this._enemies.filter((e=>e.id!==t.id)).concat([e])}for(const[t,i]of Object.entries(e.updatedEnemies)){const e=this._enemies.find((e=>e.id===t));e&&e.applyFromGameStateDelta(i)}for(const t of e.removedEnemies)this._enemies=this._enemies.filter((e=>e.id!==t));for(const t of Object.values(e.addedBonuses))t.pickedUpBy||this._bonuses.find((e=>e.id===t.id))||this._bonuses.push(new this._Bonus(this,t));for(const[t,i]of Object.entries(e.updatedBonuses))i.pickedUpBy&&(this._bonuses=this._bonuses.filter((e=>e.id!==t)),i.pickedUpBy!==this._player?.id||this._bonusPickupCache.has(t)||(se.getInstance().playSound(k.BONUS_PICKUP),this._bonusPickupCache.add(t)));for(const t of e.removedBonuses)this._bonuses=this._bonuses.filter((e=>e.id!==t));for(const t of Object.values(e.addedBullets))t.ownerId!==this._player?.id||!n||0!==this._player.bulletsLeft||this._bulletManager.hasSoundPlayedForBullet(t)||j.includes(t.weaponType)||se.getInstance().playSound(k.PLAYER_BULLET_RECHARGE,{volume:.5}),this._bulletManager.applyFromGameState(t);for(const[t,i]of Object.entries(e.updatedBullets)){const e=this._bulletManager.getBulletById(t);e&&e.getPosition().setTo(i.x,i.y)}for(const t of Object.values(e.removedBullets))this._bulletManager.getBulletById(t.id)||t.ownerId!==this._player?.id||!n||0!==this._player.bulletsLeft||this._bulletManager.hasSoundPlayedForBullet(t)||j.includes(t.weaponType)||se.getInstance().playSound(k.PLAYER_BULLET_RECHARGE,{volume:.5}),this._bulletManager.applyFromGameState(t,!0);for(const t of Object.values(e.addedShops))this._shops.find((e=>e.id===t.id))||this._shops.push(new this._Shop(this,t));for(const[t,i]of Object.entries(e.updatedShops)){const e=this._shops.find((e=>e.id===t));e&&e.applyFromGameStateDelta(i)}for(const t of e.removedShops)this._shops=this._shops.filter((e=>e.id!==t));for(const t of e.addedPlayersShops){const e=this._shops.find((e=>e.id===t));e?.handlePlayerEnter()}for(const t of e.removedPlayersShops){const e=this._shops.find((e=>e.id===t));e?.handlePlayerExit()}for(const[t,n]of Object.entries(e.updatedOtherPlayerPositions))this._otherPlayerCoordinates[t]=new i(n.x,n.y);for(const t of e.removedOtherPlayerPositions)delete this._otherPlayerCoordinates[t]}toggleInventory(){this._player?.toggleInventory()}openShopModal(){this._shops.forEach((e=>{e.hasPlayer()&&!e.isModalOpen&&e.openModal()}))}closeShopModal(){this._shops.forEach((e=>{e.hasPlayer()&&e.isModalOpen&&e.closeModal()}))}isPlayerInShop(){return this._shops.some((e=>e.hasPlayer()&&e.isModalOpen))}}class Ct extends te{world;_image=null;_layoutImage=null;_inventory={};_isEnteredByPlayer=!1;_modalOpen=!1;_name="";constructor(e,t){super(new i(t.position.x,t.position.y),64,64,t.id),this.world=e,this._inventory=t.inventory||{},this._name=t.name,ie(w.SHOP).then((e=>{this._image=e})),ie(w.SHOP_LAYOUT).then((e=>{this._layoutImage=e}))}handlePlayerEnter(){this._isEnteredByPlayer||(this._isEnteredByPlayer=!0,se.getInstance().playSound(k.ENTER_SHOP))}handlePlayerExit(){this._isEnteredByPlayer=!1,this._modalOpen=!1}hasPlayer(){return this._isEnteredByPlayer}openModal(){this._modalOpen=!this._modalOpen}closeModal(){this._modalOpen=!1}get inventory(){return this._inventory}get isModalOpen(){return this._modalOpen}draw(e,t){if(!this._image||!this.world.player||this.world.gameOver)return;const i=this.world.player;let n=(this.getPosition().distanceTo(i.getPosition())<=this.world.torchRadius+this.width||i.hasNightVision())&&!this.world.gameOver;for(const e of this.world.otherPlayers)if(!e.hasNightVision()&&this.getPosition().distanceTo(e.getPosition())<=this.world.torchRadius+this.width){n=!0;break}if(!n)return;const s=this.world.worldToScreenCoordinates(this.getPosition());e.save(),e.translate(s.x,s.y),e.drawImage(this._image,-this.width/2,-this.height/2,this.width,this.height),e.font=`14px ${o}`;const r=e.measureText(this._name),a=r.width+6,l=r.actualBoundingBoxAscent+6;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(-a/2,this.height/2+30,a,l),e.fillStyle="white",e.textAlign="center",e.fillText(this._name,0,this.height/2+30+r.actualBoundingBoxAscent+3),e.restore(),this.world.debug&&(t.save(),t.translate(s.x,s.y),t.strokeStyle="turquoise",t.strokeRect(-this.width/2,-this.height/2,this.width,this.height),t.restore())}drawUI(e){if(this._isEnteredByPlayer)if(this._modalOpen){if(!this._layoutImage)return;e.save();const t=this._layoutImage.width,i=this._layoutImage.height,n=(e.canvas.width-t)/2,s=(e.canvas.height-i)/2;e.drawImage(this._layoutImage,n,s,t,i);const r=5,a=400,l=72;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect((e.canvas.width-a)/2-r,e.canvas.height-88-r,a+2*r,l+2*r);const h=Object.values(this._inventory).filter((e=>e.quantity>0)).length,d=h>9?"Press buttons from 1 through 9 and 0 to make a purchase.":0===h?"No items available for purchase.":1===h?"Press button 1 to make a purchase.":`Press button from 1 through ${h} to make a purchase.`;e.fillStyle="white",e.textAlign="center",e.font=`14px ${o}`,e.fillText("üü® - available, üü• - not enough money, üü© - already owned",e.canvas.width/2,e.canvas.height-72),e.fillText(d,e.canvas.width/2,e.canvas.height-50),e.fillText("Press Escape to close the Shop.",e.canvas.width/2,e.canvas.height-28);const c=n+148,u=s+72,p=53;let g=0;e.fillStyle="#f7e78cff",e.font=`20px ${o}`,e.textAlign="center",e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=4,e.fillText("Item",c+28,u-20),e.fillText("Pack Size",c+140,u-20),e.fillText("Price",c+290,u-20),e.fillText("Stock",c+400,u-20),e.restore();for(const[t,i]of Object.entries(this._inventory)){if(i.quantity<=0)continue;const n=c,s=u+g*p,r=this.world.getInventoryTexture(Number(t));r&&e.drawImage(r,n-r.width/2+p/2,s-r.height/2+p/2,r.width,r.height),e.save(),e.fillStyle="#f7e78cff";const a=this.world.player,l=Number(t),h=Object.values(V).includes(l);a&&a.money<i.price*i.packSize&&(e.fillStyle="#ff4d4dff"),h&&a&&a.hasInventoryItem(l)&&(e.fillStyle="#4dff4dff"),e.font=`20px ${o}`,e.textAlign="right",e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=4,e.fillText(`${i.packSize}`,n+174,s+p/2+5),e.fillText("$"+i.price*i.packSize,n+328,s+p/2+5),e.fillText(`${i.quantity}`,n+418,s+p/2+5),e.fillText(""+(g+1)%10,n-10,s+p/2+5),e.restore(),g++}}else e.save(),e.fillStyle="white",e.textAlign="center",e.font=`14px ${o}`,e.fillText("Press Enter to visit the Shop",e.canvas.width/2,e.canvas.height-160),e.restore()}applyFromGameStateDelta(e){this._inventory=e.inventory||{}}}class jt extends te{world;_images={blaster:null,shotgun:null,railgun:null,rocket_launcher:null};_bloodImage=null;_rotation=0;_name;_invulnerableTimer=0;_lives=5;_nightVisionTimer=0;_weaponType="blaster";dead=!1;get rotation(){return this._rotation}get nightVisionTimer(){return this._nightVisionTimer}get name(){return this._name}constructor(e,t){const n=new i(t.position.x,t.position.y),s=t.rotation;super(n,24,24,t.id),this.world=e,this._name=t.username,this._rotation=s,ie(G.blaster).then((e=>{this._images.blaster=e})),ie(G.shotgun).then((e=>{this._images.shotgun=e})),ie(G.railgun).then((e=>{this._images.railgun=e})),ie(G.rocket_launcher).then((e=>{this._images.rocket_launcher=e})),ie(w.BLOOD).then((e=>{this._bloodImage=e}))}getGunPoint(){return this.getPosition().movedByPointCoordinates(d).rotateAroundPointCoordinates(this.getPosition(),this._rotation)}moveTo(e){this._point.setToPointCoordinates(e)}rotate(e){this._rotation=e}update(e){this._invulnerableTimer>0&&(this._invulnerableTimer=Math.max(0,this._invulnerableTimer-e))}draw(e,t){if(!this._images[this._weaponType]||!this.world.player||this.world.gameOver)return;const n=this.world.worldToScreenCoordinates(this.getPosition());let s=!0;if((!this.world.player.hasNightVision()&&this.hasNightVision()||!this.isAlive())&&(s=this.getPosition().distanceTo(this.world.player.getTorchPoint())<=this.world.torchRadius+this.width),!s)return;this.drawUI(t);const r=5*this._invulnerableTimer/1,a=r-Math.floor(r)<.5;if(e.save(),e.translate(n.x,n.y),(this.dead||!this._invulnerableTimer||a)&&!this.world.gameOver){e.rotate(this._rotation*Math.PI/180);const t=this.dead?32:64,n=this.dead?new i(-t/2,-t/2):h.inverted();this.dead&&this._bloodImage&&e.drawImage(this._bloodImage,-this.width/2,-this.height/2,this.width,this.height),!this.dead&&this._images[this._weaponType]&&e.drawImage(this._images[this._weaponType],n.x,n.y,t,t),e.rotate(-this._rotation*Math.PI/180)}if(e.restore(),this.world.debug){t.strokeStyle="red",t.strokeRect(-this.width/2+n.x,-this.height/2+n.y,this.width,this.height),t.fillStyle="magenta",t.beginPath(),t.arc(n.x,n.y,2,0,2*Math.PI),t.fill(),t.fillStyle="magenta";const e=this.world.worldToScreenCoordinates(this.getGunPoint());t.beginPath(),t.arc(e.x,e.y,2,0,2*Math.PI),t.fill()}}isAlive(){return this._lives>0}get lives(){return this._lives}drawUI(e){const t=this.world.worldToScreenCoordinates(this.getPosition());e.font=`14px ${o}`;const i=e.measureText(this.name),n=i.width+6,s=i.actualBoundingBoxAscent+6;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(t.x-n/2,t.y+this.height/2+30,n,s),e.fillStyle="white",e.textAlign="center",e.fillText(this.name,t.x,t.y+this.height/2+30+i.actualBoundingBoxAscent+3)}isInvulnerable(){return this._invulnerableTimer>0}hasNightVision(){return this._nightVisionTimer>0}isNightVisionFading(){return!1}getTorchPoint(){return this.getPosition().movedByPointCoordinates(c).rotateAroundPointCoordinates(this.getPosition(),this._rotation)}applyFromGameStateDelta(e){e.position&&(this._point.setTo(e.position.x,e.position.y),this._rotation=e.position.rotation),e.lives&&(this._lives=e.lives.lives,this.dead=!e.lives.isAlive),e.timers&&(this._invulnerableTimer=e.timers.invulnerableTimer,this._nightVisionTimer=e.timers.nightVisionTimer),e.inventory&&(this._weaponType=e.inventory.selectedGunType)}}class $t{x;y;constructor(e,t){this.x=e,this.y=t}add(e){return new $t(this.x+e.x,this.y+e.y)}subtract(e){return new $t(this.x-e.x,this.y-e.y)}multiply(e){return new $t(this.x*e,this.y*e)}normalize(){const e=Math.sqrt(this.x*this.x+this.y*this.y);return 0===e?new $t(0,0):new $t(this.x/e,this.y/e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}static fromAngle(e){return new $t(-Math.sin(e),Math.cos(e))}getAngle(){return 270+180*Math.atan2(this.y,this.x)/Math.PI}}class Vt extends te{world;rotation;isEnemy;enemyType;ownerId;_velocity;_speed;_active=!0;_inactiveMs=0;_weaponType="blaster";static _imageRocket=null;static _imageRocketBlast=null;get weaponType(){return this._weaponType}get inactiveMs(){return this._inactiveMs}get active(){return this._active}get velocity(){return this._velocity}set active(e){this._active=e}constructor(e,t,i,n,s,r,a){super(t,8,8,a),this.world=e,this.rotation=i,this.isEnemy=n,this.enemyType=s,this.ownerId=r,this._speed=n?240:420,this._velocity=$t.fromAngle(i*Math.PI/180).multiply(this._speed),Vt._imageRocket||ie(w.BULLET_ROCKET).then((e=>{Vt._imageRocket=e})),Vt._imageRocketBlast||ie(b.EXPLOSION.image).then((e=>{document.body.appendChild(e),e.style.display="none",Vt._imageRocketBlast=e}))}static fromGameState(e,t){const n=new Vt(e,new i(t.position?.x??0,t.position?.y??0),t.velocity?Math.atan2(t.velocity.y,t.velocity.x)*(180/Math.PI):0,t.isEnemy,t.enemyType,t.ownerId,t.id);return n._weaponType=t.weaponType,t.isActive||(n._active=!1),t.velocity&&(n._velocity=new $t(t.velocity.x,t.velocity.y)),n._weaponType=t.weaponType,n._inactiveMs=Number(t.inactiveMs??0),n}draw(e,t,i){if(this.world.gameOver||!this._active&&!["railgun","rocket_launcher"].includes(this._weaponType))return;const n=this.world.worldToScreenCoordinates(this.getPosition());if(e.save(),e.translate(n.x,n.y),"railgun"===this._weaponType){e.strokeStyle=this.isEnemy?H[this.enemyType]??m:u,e.lineWidth=2,e.beginPath(),e.moveTo(0,0);const t=this.velocity.x,i=this.velocity.y;e.lineTo(t,i),e.stroke();const n=20,s=e.createRadialGradient(t,i,0,t,i,n);return s.addColorStop(0,this.isEnemy?m:u),s.addColorStop(1,"transparent"),e.fillStyle=s,e.beginPath(),e.arc(t,i,n,0,2*Math.PI),e.fill(),void e.restore()}if("rocket_launcher"===this._weaponType&&Vt._imageRocket){if(!this._active&&Vt._imageRocketBlast&&i){const t=Vt._imageRocketBlast.width/b.EXPLOSION.frameCount,n=Vt._imageRocketBlast.height,s=b.EXPLOSION.duration,r=Math.floor(i/s*b.EXPLOSION.frameCount);return r>=b.EXPLOSION.frameCount||e.drawImage(Vt._imageRocketBlast,r*t,0,t,n,-t/2,-n/2,t,n),void e.restore()}const t=Math.atan2(this.velocity.y,this.velocity.x)+Math.PI/2;e.rotate(t);const n=Vt._imageRocket.width,s=Vt._imageRocket.height;return e.drawImage(Vt._imageRocket,-n/2,-s/2,n,s),void e.restore()}e.rotate(this.rotation*Math.PI/180),e.fillStyle=this.isEnemy?H[this.enemyType]??m:u,e.beginPath(),e.arc(0,0,this.width/2,0,2*Math.PI),e.fill(),e.restore()}}class Ft{world;_bullets=new Map;_bulletsSoundCache=new Set;_bulletsRemovedSoundCache=new Set;get bullets(){return Array.from(this._bullets.values())}constructor(e){this.world=e}getBulletCacheKey(e){let t=`${e.id}`;return"shotgun"!==e.weaponType||e.isActive||(t=`${e.ownerId}-${e.deletedAt}`),t}applyFromGameState(e,t){const i=Vt.fromGameState(this.world,e);if(t&&i.active)return void this._bullets.delete(i.id);const n=i.getPosition().distanceTo(this.world.player.getPosition()),s=2*this.world.torchRadius,r=n>=s?0:1-n/s,a=this.getBulletCacheKey(e);if(this._bulletsSoundCache.has(a)||(this._bulletsSoundCache.add(a),se.getInstance().playSound(C[i.weaponType]||k.BULLET,{volume:r})),!i.active){const e=K[i.weaponType];if(i.inactiveMs>=e)return void this._bullets.delete(i.id);"rocket_launcher"===i.weaponType&&(this._bulletsRemovedSoundCache.has(a)||(se.getInstance().playSound(k.ROCKET_BLAST,{volume:r,offset:i.inactiveMs}),this._bulletsRemovedSoundCache.add(a)))}this._bullets.set(i.id,i)}getBulletById(e){return this._bullets.get(e)||null}hasSoundPlayedForBullet(e){const t=this.getBulletCacheKey(e);return this._bulletsSoundCache.has(t)}draw(e,t){this.bullets.forEach((i=>{if(i.active)i.draw(e,t);else{const n=K[i.weaponType],s=i.inactiveMs;if(s>=n)return this._bullets.delete(i.id),this._bulletsSoundCache.delete(i.id),void this._bulletsRemovedSoundCache.delete(i.id);i.draw(e,t,s)}}))}}class Wt{_canvas;_lightCanvas;_uiCanvas;_ctx;_lightCtx;_uiCtx;_lastTime=0;_world=null;_activeKeys=new Set;_authManager;_sessionManager;_started=!1;get world(){return this._world}constructor(){this._canvas=document.getElementById("gameCanvas"),this._lightCanvas=document.getElementById("lightCanvas"),this._uiCanvas=document.getElementById("uiCanvas"),[this._canvas,this._lightCanvas,this._uiCanvas].forEach((e=>{e.width=r,e.height=a})),this._ctx=this._canvas.getContext("2d"),this._lightCtx=this._lightCanvas.getContext("2d"),this._uiCtx=this._uiCanvas.getContext("2d"),this._authManager=le.getInstance(),this._sessionManager=Dt.getInstance(),this.setupEventListeners()}static async loadResources(){const e=se.getInstance();await Promise.all([ie(w.FLOOR),ie(w.PLAYER),ie(w.ENEMY),ie(w.WALL),e.loadSound(k.PLAYER_HURT),e.loadSound(k.PLAYER_DEAD),e.loadSound(k.ENEMY_HURT),e.loadSound(k.TOWER_HIT),e.loadSound(k.TORCH)]),e.loadSound(k.PLAYER_BULLET_RECHARGE),e.loadSound(k.BONUS_PICKUP),e.loadSound(k.GAME_OVER),e.loadSound(k.BULLET),e.loadSound(k.SHOTGUN),e.loadSound(k.RAILGUN),e.loadSound(k.ROCKET_LAUNCHER),e.loadSound(k.ROCKET_BLAST),e.loadSound(k.SPAWN),e.loadSound(k.ENTER_SHOP),e.loadSound(k.MONEY_SPENT),e.loadSound(k.MISTAKE),e.loadSound(k.TOWER_CRASH),ie(w.BLOOD),ie(w.AID_KIT),ie(w.GOGGLES),ie(w.SHOP)}setupEventListeners(){window.addEventListener("keydown",(e=>{this._activeKeys.add(e.code),this.handleKeyDown(e)})),window.addEventListener("keyup",(e=>{this._activeKeys.delete(e.code)})),window.addEventListener("mousemove",(e=>this.handleMouseMove(e))),window.addEventListener("mousedown",(e=>this.handleMouseDown(e))),this._sessionManager.onGameStateDelta((e=>{if(this._world){const t=this._authManager.getUserData();this._world.applyGameStateDelta(e,t.id)}})),this._sessionManager.onPlayerJoined((({player:e})=>{e&&this._world&&this._world.addOtherPlayer(e)})),this._sessionManager.onPlayerLeft((({playerId:e})=>{this._world&&this._world.removeOtherPlayer(e)}))}handleKeyDown(e){"F3"===e.key&&this._world?.toggleDebug(),"KeyR"===e.code&&this._world?.gameOver&&this._world?.restart(),"KeyE"!==e.code&&"Backquote"!==e.code||this._world?.toggleInventory(),"Enter"===e.code&&this._world?.openShopModal(),"Escape"===e.code&&this._world?.closeShopModal()}handleMouseMove(e){const t=this._canvas.getBoundingClientRect();e.clientX,t.left,e.clientY,t.top}handleMouseDown(e){if(0===e.button){const t=this._canvas.getBoundingClientRect();e.clientX,t.left,e.clientY,t.top}}async start(e){if(e){const t=this._authManager.getUserData(),i=e.host&&t&&e.host.id===t.id?"host":"guest";this._world=new Mt(ae,re,oe,ne,jt,Ct,Ft,i),this._started=!0,requestAnimationFrame((e=>this.gameLoop(e)))}}gameLoop(e){if(!this._started)return;const t=(e-this._lastTime)/1e3;this._lastTime=e,this._world?.handleInput(this._activeKeys,t),this._world?.update(t),this.draw(),requestAnimationFrame((e=>this.gameLoop(e)))}stop(){this._started=!1,se.getInstance().stopAllSounds()}draw(){[this._ctx,this._uiCtx,this._lightCtx].forEach((e=>{e.clearRect(0,0,this._canvas.width,this._canvas.height)})),this._world?.draw(this._ctx,this._lightCtx,this._uiCtx)}}class Gt{static instance;leaderboardData=[];constructor(){}static getInstance(){return Gt.instance||(Gt.instance=new Gt),Gt.instance}async getLeaderboard(){const e=await he.get("/leaderboard/global");return this.leaderboardData=e,e}getCurrentLeaderboard(){return this.leaderboardData}async refreshLeaderboard(){return this.getLeaderboard()}}const Kt=le.getInstance(),Ht=Gt.getInstance(),Yt=Dt.getInstance();let qt=null;function Jt(e){return document.getElementById(e)}function Xt(){const e=window.location.pathname.match(/\/([a-f0-9-]+)$/i);return e?e[1]:null}function Zt(e){window.history.pushState({},"",`${e}`)}function zt(){window.history.pushState({},"","")}function Qt(e){document.querySelectorAll(".screen").forEach((e=>{e.style.setProperty("display","none")})),Jt(e+"Screen")?.style.setProperty("display","flex")}function ei(e){const t=Jt("leaderboardList");t&&(0!==e.length?t.innerHTML=e.slice(0,10).map(((e,t)=>`\n            <li class="leaderboard-item">\n                <span class="rank">#${t+1}</span> \n                <span class="username">${e.username}</span> \n                <span class="session">For the battle at ${e.sessionName}</span>\n                <span class="score">${e.score}</span>\n            </li>\n        `)).join(""):t.innerHTML='<li class="leaderboard-empty">No scores yet. Be the first!</li>')}function ti(e){const t=Jt("sessionsList");if(!t)return;if(0===e.length)return void(t.innerHTML='<li class="sessions-empty">No active sessions</li>');const i=Kt.getUserData()?.id;t.innerHTML=e.map((e=>{const t=Object.keys(e.players).length,n=e.max_players||4,s=e.host.id===i,r=`<button ${s?"":'disabled title="You must be the host to delete this session"'} class="session-delete" data-session-id="${e.id}" onclick="event.stopPropagation()">üóëÔ∏è</button>`;return`\n                <li class="session-item" data-session-id="${e.id}">\n                    <div class="session-info">\n                        <span class="session-name">"${e.name}"<span class="session-host">${s?"You":e.host.username}</span></span>\n                        <span class="session-players">${t}/${n}</span>\n                    </div>\n                    ${r}\n                </li>\n            `})).join(""),t.querySelectorAll(".session-item").forEach((e=>{e.addEventListener("click",(async()=>{const t=e.dataset.sessionId;if(t){qt=new Wt;try{const e=await Yt.joinSession(t);Zt(t),await qt.start(e),Qt("game")}catch(e){console.error("Failed to join session:",e);const t=document.querySelector("#leaderboardScreen .error");t&&(t.textContent="Failed to join session. Please try again.",t.style.setProperty("display","block"))}}}))})),t.querySelectorAll(".session-delete").forEach((e=>{e.addEventListener("click",(async t=>{t.stopPropagation();const i=e.dataset.sessionId;if(i&&confirm("Are you sure you want to delete this session?"))try{await Yt.deleteSession(i),ti(await Yt.listSessions())}catch(e){console.error("Failed to delete session:",e);const t=document.querySelector("#leaderboardScreen .error");t&&(t.textContent="Failed to delete session. Please try again.",t.style.setProperty("display","block"))}}))}))}window.onload=async()=>{try{Kt.initToken(),await Kt.checkAuthStatus(),await Wt.loadResources();const e=Xt();if(e)try{qt=new Wt;const t=await Yt.joinSession(e);return await qt.start(t),void Qt("game")}catch(e){console.error("Failed to join session from URL:",e),zt()}const[t,i]=await Promise.all([Ht.getLeaderboard(),Yt.listSessions()]);ei(t),ti(i),Qt("leaderboard"),Jt("username").textContent=Kt.getUserData().username}catch(e){console.error(e),function(){const e=Jt("loader");e&&e.style.setProperty("display","none")}(),function(){const e=Jt("loginButton");e&&e.style.setProperty("display","flex")}()}},Jt("loginButton")?.addEventListener("click",(async()=>{if(!Kt.isPerformingRequest())try{await Kt.getAuthUrl(),Kt.openAuthPage()}catch(e){console.error("Authentication failed:",e)}})),Jt("sessionsTab")?.addEventListener("click",(()=>{Jt("sessionsTab")?.classList.add("active"),Jt("leaderboardTab")?.classList.remove("active");const e=Jt("sessions"),t=Jt("leaderboard");e&&(e.style.display="block"),t&&(t.style.display="none")})),Jt("leaderboardTab")?.addEventListener("click",(()=>{Jt("leaderboardTab")?.classList.add("active"),Jt("sessionsTab")?.classList.remove("active");const e=Jt("sessions"),t=Jt("leaderboard");e&&(e.style.display="none"),t&&(t.style.display="block")})),Jt("startGameButton")?.addEventListener("click",(async()=>{const e=Jt("sessionNameModal"),t=Jt("sessionNameInput");e&&t&&(t.value=function(){const e=["Silly","Crazy","Brave","Sneaky","Mighty","Clumsy","Epic","Fancy","Grumpy","Happy","Sleepy","Dancing","Flying","Invisible","Legendary","Mysterious","Chaotic","Funky","Bizarre","Magical"],t=["Dragon","Goblin","Wizard","Knight","Potato","Unicorn","Troll","Ninja","Pirate","Skeleton","Chicken","Banana","Mushroom","Phoenix","Penguin","Donut","Cactus","Platypus","Waffle","Pickles"],i=["Dungeon","Castle","Cave","Tower","Forest","Swamp","Mountain","Island","Kingdom","Realm","Lair","Temple","Abyss","Palace","Fortress"];return`${e[Math.floor(Math.random()*e.length)]} ${t[Math.floor(Math.random()*t.length)]} ${i[Math.floor(Math.random()*i.length)]}`}(),e.classList.add("show"),t.focus(),t.select())})),Jt("cancelSessionButton")?.addEventListener("click",(()=>{const e=Jt("sessionNameModal");e&&e.classList.remove("show")})),Jt("createSessionButton")?.addEventListener("click",(async()=>{const e=Jt("sessionNameModal"),t=Jt("sessionNameInput"),i=t?.value.trim()||"";if(i){e&&e.classList.remove("show"),qt&&qt.stop(),qt=new Wt;try{const e=await Yt.startSession(i);Zt(e.id),await qt.start(e),Qt("game")}catch(e){if(console.error("Game initialization failed:",e),"object"==typeof e&&e&&"message"in e&&"string"==typeof e.message){const e=document.querySelector("#leaderboardScreen .error");e&&(e.textContent="There's a problem on our end. Please try again later.",e.style.setProperty("display","block"))}}}})),Jt("sessionNameInput")?.addEventListener("keypress",(e=>{"Enter"===e.key&&Jt("createSessionButton")?.click()})),document.addEventListener("keydown",(e=>{if("Escape"===e.key){const e=Jt("sessionNameModal");e?.classList.contains("show")&&e.classList.remove("show")}})),window.addEventListener("popstate",(async()=>{const e=Xt();if(e)try{qt&&qt.stop(),qt=new Wt;const t=await Yt.joinSession(e);await qt.start(t),Qt("game")}catch(e){console.error("Failed to join session from URL:",e),zt(),Qt("leaderboard")}else{const e=document.querySelector(".screen[style*='display: flex']");if("gameScreen"===e?.id){try{await Yt.endSession(),qt?.stop()}catch(e){console.error("Error ending session:",e)}const[e,t]=await Promise.all([Ht.getLeaderboard(),Yt.listSessions()]);ei(e),ti(t);const i=Kt.getUserData();i&&(Jt("username").textContent=i.username),Qt("leaderboard")}}}))})();